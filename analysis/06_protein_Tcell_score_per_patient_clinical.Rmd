---
title: "Cluster images by celltypes"
author: "Daniel"
date: "09.04.2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Load libraries

First, we will load the libraries needed for this part of the analysis.

```{r load-libraries, message=FALSE}
sapply(list.files("code/helper_functions/", full.names = TRUE), source)
library(data.table)
library(S4Vectors)
library(SingleCellExperiment)
library(devtools)
library(ggplot2)
library(tidyverse)
library(cba)
library(ComplexHeatmap)
```

# Read the data

```{r load data}
sce = readRDS(file = "data/sce_protein.rds")

colour_vector <- readRDS("data/colour_vector.rds")

image_mat <- as.data.frame(read.csv(file = "data/protein/Image.csv",stringsAsFactors = FALSE))
# here we get the imagesize from the image metadata
im_size <- (image_mat$Height_cellmask * image_mat$Width_cellmask)/1000000
```




plot per image the fraction of cytotoxic T cells that sit next to a tumor cell per tumor cell colored by infiltration

the red line in the plot marks images that have one or more cytotoxic T cells sitting next to a tumor cells per 10 tumor cells

## T cell density score per ImageNumber

```{r barplot Tcell score sorted with Death, fig.height=10, fig.width=15, message=FALSE}
set.seed(534)
cur_df <- data.frame(ImageNumber = sce$ImageNumber,
                     celltype = sce$celltype,
                     Tcell_score = sce$Tcell_score)

cur_df <- reshape2::dcast(cur_df,formula = "Tcell_score + ImageNumber  ~ celltype", fun.aggregate = length)
cur_df <- as_tibble(cur_df)


cur_df$image_size <- im_size[cur_df$ImageNumber]


# calculate the density of Tcytotoxic cells
cur_df <- cur_df %>%
  mutate(Tcytotoxic_density = round(Tcytotoxic/image_size))

matrixrownames <- as.character(cur_df$ImageNumber)

m <- as.matrix(cur_df$Tcytotoxic_density)
rownames(m) <- matrixrownames
m <- m[order(m[,1]),]

# construct color vector for Tcell score
count_vec <- as.vector(m)

Tcell_score_col <- c(rep("red",length(count_vec[count_vec<=40])),
                         rep("orange",length(count_vec[which(count_vec <100 & count_vec > 40)])),
                         rep("lightgreen",length(count_vec[which(count_vec <400 & count_vec > 100)])),
                         rep("darkgreen",length(count_vec[count_vec>400])))

ha <- rowAnnotation(cell_composition = anno_barplot(m,gp=gpar(fill=Tcell_score_col),bar_width = 1,height = unit(30,"cm"),width = unit(15,"cm"),show_row_names =FALSE))

# now we sort the patient meta data for plotting on top. This data can be used for all subsequent plots, just needs to be sorted differently
patient_meta <- data.frame(ImageNumber = sce$ImageNumber,
                           BlockID = sce$BlockID,
                           PatientID = sce$PatientID,
                           Mutation = sce$Mutation,
                           MM_location = sce$MM_location_simplified,
                           Death = sce$Death,
                           Adjuvant = sce$Adjuvant,
                           Treatment_after_surgery = sce$treatment_group_after_surgery,
                           E_I_D = sce$E_I_D)

patient_meta <- unique(patient_meta)

mrownames <- patient_meta$ImageNumber
patient_meta_matrix <- as.matrix(patient_meta)

rownames(patient_meta_matrix) <- as.character(mrownames)
patient_meta_matrix <- patient_meta_matrix[names(m),]

# heatmap consisting of the patient_IDs. one color per patient
h1 = Heatmap(patient_meta_matrix[,"Death"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Death"),show_row_names = FALSE,
             column_labels = "Death",right_annotation =  ha)


ht = grid.grabExpr(draw( h1))
grid.newpage()
pushViewport(viewport(angle = 270))
grid.draw(ht)
```
## T cell density score per BlockID

```{r barplot Tcell score sorted with death for BlockID, fig.height=15, fig.width=15, message=FALSE}
set.seed(436)
cur_df <- data.frame(BlockID = sce$BlockID,
                     celltype = sce$celltype,
                     Tcell_score = sce$Tcell_score_per_BlockID,
                     MM_location = sce$MM_location)

cur_df <- cur_df[which(cur_df$MM_location != ""),]

cur_df <- reshape2::dcast(cur_df,formula = "BlockID + Tcell_score  ~ celltype", fun.aggregate = length)
cur_df <- as_tibble(cur_df)

# create named vector with ImageNumber and BlockID
block_images <- data.frame(ImageNumber = sce$ImageNumber,
                           BlockID = sce$BlockID)
block_images <- unique(block_images)
block_vec <- block_images$BlockID


block_size <- data.frame(ImageNumber = 1:length(im_size),
                         image_size = im_size)
block_size$BlockID <- block_vec

block_size <- block_size %>%
  group_by(BlockID) %>%
  mutate(Blocksize = sum(image_size))

# remove unwanted information for merging
block_size <- unique(block_size %>%
  select(BlockID, Blocksize))
# add info to cur_df
cur_df <- left_join(x = cur_df,y = block_size,"BlockID")

# calculate the density of Tcytotoxic cells
cur_df <- cur_df %>%
  mutate(Tcytotoxic_density = round(Tcytotoxic/Blocksize)) 

matrixrownames <- as.character(cur_df$BlockID)

m <- as.matrix(cur_df$Tcytotoxic_density)
rownames(m) <- matrixrownames
m <- m[order(m[,1]),]

# construct color vector for Tcell score
count_vec <- as.vector(m)


Tcell_score_col <- c(rep("red",length(count_vec[count_vec<=40])),
                         rep("orange",length(count_vec[which(count_vec <100 & count_vec > 40)])),
                         rep("lightgreen",length(count_vec[which(count_vec <400 & count_vec > 100)])),
                         rep("darkgreen",length(count_vec[count_vec>400])))

ha <- rowAnnotation(Tcells_per_mm2 = anno_barplot(m,gp=gpar(fill=Tcell_score_col),bar_width = 1,height = unit(30,"cm"),width = unit(15,"cm"),show_row_names =FALSE,ylab = "test"))



mrownames <- patient_meta$BlockID
patient_meta_matrix <- as.matrix(patient_meta)

rownames(patient_meta_matrix) <- as.character(mrownames)
patient_meta_matrix <- patient_meta_matrix[names(m),]


# heatmap consisting of the patient_IDs. one color per patient
h1 = Heatmap(patient_meta_matrix[,"Death"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Date death"),show_row_names = FALSE,
             column_labels = "Date death",right_annotation =  ha)
h2 = Heatmap(patient_meta_matrix[,"Mutation"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Mutation"),show_row_names = FALSE,
             column_labels = "Mutation")
h4 = Heatmap(patient_meta_matrix[,"Treatment_after_surgery"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Treatment_after_surgery"),show_row_names = FALSE,
             column_labels = "Treatment_after_surgery")
h5 = Heatmap(patient_meta_matrix[,"MM_location"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "MM_location"),show_row_names = FALSE,
             column_labels = "MM_location")
h6 = Heatmap(patient_meta_matrix[,"Adjuvant"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Adjuvant"),show_row_names = FALSE,
             column_labels = "Adjuvant")
h7 = Heatmap(patient_meta_matrix[,"E_I_D"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "E_I_D"),show_row_names = FALSE,
             column_labels = "E_I_D")

ht = grid.grabExpr(draw( h7 + h6 + h5 + h4 + h2  + h1))
grid.newpage()
pushViewport(viewport(angle = 270))
grid.draw(ht)

```

## T cell density score per PatientID

```{r barplot Tcell score sorted with death for PatientID, fig.height=15, fig.width=15, message=FALSE}
set.seed(534)
cur_df <- data.frame(E_I_D = sce$E_I_D,
                     PatientID = sce$PatientID,
                     celltype = sce$celltype,
                     Tcell_score = sce$Tcell_score_per_BlockID,
                     infiltration = sce$infiltration,
                     MM_location = sce$MM_location)

cur_df <- cur_df[which(cur_df$MM_location != ""),]

cur_df <- reshape2::dcast(cur_df,formula = "PatientID + Tcell_score  ~ celltype", fun.aggregate = length)
cur_df <- as_tibble(cur_df)

# create named vector with ImageNumber and PatientID
block_images <- data.frame(ImageNumber = sce$ImageNumber,
                           PatientID = sce$PatientID)
block_images <- unique(block_images)
block_vec <- block_images$PatientID


block_size <- data.frame(ImageNumber = 1:length(im_size),
                         image_size = im_size)
block_size$PatientID <- block_vec

block_size <- block_size %>%
  group_by(PatientID) %>%
  mutate(Blocksize = sum(image_size))

# remove unwanted information for merging
block_size <- unique(block_size %>%
  select(PatientID, Blocksize))
# add info to cur_df
cur_df <- left_join(x = cur_df,y = block_size,"PatientID")

# calculate the density of Tcytotoxic cells
cur_df <- cur_df %>%
  mutate(Tcytotoxic_density = round(Tcytotoxic/Blocksize)) 

matrixrownames <- as.character(cur_df$PatientID)

m <- as.matrix(cur_df$Tcytotoxic_density)
rownames(m) <- matrixrownames
m <- m[order(m[,1]),]

# construct color vector for Tcell score
count_vec <- as.vector(m)


Tcell_score_col <- c(rep("red",length(count_vec[count_vec<=40])),
                         rep("orange",length(count_vec[which(count_vec <100 & count_vec > 40)])),
                         rep("lightgreen",length(count_vec[which(count_vec <400 & count_vec > 100)])),
                         rep("darkgreen",length(count_vec[count_vec>400])))

ha <- rowAnnotation(Tcells_per_mm2 = anno_barplot(m,gp=gpar(fill=Tcell_score_col),bar_width = 1,height = unit(30,"cm"),width = unit(15,"cm"),show_row_names =FALSE,ylab = "test"))


mrownames <- patient_meta$PatientID
patient_meta_matrix <- as.matrix(patient_meta)

rownames(patient_meta_matrix) <- as.character(mrownames)
patient_meta_matrix <- patient_meta_matrix[names(m),]


# heatmap consisting of the patient_IDs. one color per patient
h1 = Heatmap(patient_meta_matrix[,"Death"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Date death"),show_row_names = FALSE,
             column_labels = "Date death",right_annotation =  ha)

ht = grid.grabExpr(draw(h1))
grid.newpage()
pushViewport(viewport(angle = 270))
grid.draw(ht)

```

## cytotoxic T cell fraction per ImageNumber

```{r barplot Tcytotoxic fraction per ImageNumber with clinical annotation, fig.height=15, fig.width=15, message=FALSE}
set.seed(426)
cur_df <- data.frame(E_I_D = sce$E_I_D,
                     ImageNumber = sce$ImageNumber,
                     celltype = sce$celltype,
                     Tcell_score = sce$T_frac_score_per_ImageNumber,
                     infiltration = sce$infiltration,
                     MM_location = sce$MM_location)

cur_df <- cur_df[which(cur_df$MM_location != ""),]

cur_df <- reshape2::dcast(cur_df,formula = "ImageNumber + Tcell_score  ~ celltype", fun.aggregate = length)
cur_df <- as_tibble(cur_df)


# calculate the fraction of Tcytotoxic cells
cur_df <- cur_df %>%
  mutate(Tcytotoxic_fraction = (Tcytotoxic/rowSums(cur_df[,-c(1,2)]))) 

matrixrownames <- as.character(cur_df$ImageNumber)

m <- as.matrix(cur_df$Tcytotoxic_fraction)
rownames(m) <- matrixrownames
m <- m[order(m[,1]),]

# construct color vector for Tcell score
count_vec <- as.vector(m)

Tcell_score_col <- c(rep("red",length(unique(sce[,sce$T_frac_score_per_ImageNumber == "low"]$ImageNumber))),
                         rep("orange",length(unique(sce[,sce$T_frac_score_per_ImageNumber == "med"]$ImageNumber))),
                         rep("darkgreen",length(unique(sce[,sce$T_frac_score_per_ImageNumber == "high"]$ImageNumber))))

ha <- rowAnnotation(Fraction_Tcyototoxic = anno_barplot(m,gp=gpar(fill=Tcell_score_col),bar_width = 1,height = unit(30,"cm"),width = unit(15,"cm"),show_row_names =FALSE))


patient_meta <- patient_meta[which(patient_meta$Mutation != ""),]

mrownames <- patient_meta$ImageNumber 
patient_meta_matrix <- as.matrix(patient_meta)

rownames(patient_meta_matrix) <- mrownames
patient_meta_matrix <- patient_meta_matrix[names(m),]

# heatmap consisting of the patient_IDs. one color per patient
h1 = Heatmap(patient_meta_matrix[,"Death"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Death"),show_row_names = FALSE,
             column_labels = "Death",right_annotation =  ha)
h2 = Heatmap(patient_meta_matrix[,"Mutation"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Mutation"),show_row_names = FALSE,
             column_labels = "Mutation")
h4 = Heatmap(patient_meta_matrix[,"Treatment_after_surgery"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Treatment_after_surgery"),show_row_names = FALSE,
             column_labels = "Treatment_after_surgery")
h5 = Heatmap(patient_meta_matrix[,"MM_location"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "MM_location"),show_row_names = FALSE,
             column_labels = "MM_location")
h6 = Heatmap(patient_meta_matrix[,"Adjuvant"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Adjuvant"),show_row_names = FALSE,
             column_labels = "Adjuvant")
h7 = Heatmap(patient_meta_matrix[,"E_I_D"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "E_I_D"),show_row_names = FALSE,
             column_labels = "E_I_D")

ht = grid.grabExpr(draw( h7 + h6 + h5 + h4 + h2  + h1))
grid.newpage()
pushViewport(viewport(angle = 270))
grid.draw(ht)

```

## cytotoxic T cell fraction per BlockID

```{r barplot Tcytotoxic fraction per BlockID with clinical annotation, fig.height=15, fig.width=15, message=FALSE}
set.seed(362)
cur_df <- data.frame(E_I_D = sce$E_I_D,
                     BlockID = sce$BlockID,
                     celltype = sce$celltype,
                     Tcell_score = sce$T_frac_score_per_BlockID,
                     infiltration = sce$infiltration,
                     MM_location = sce$MM_location)

cur_df <- cur_df[which(cur_df$MM_location != ""),]

cur_df <- reshape2::dcast(cur_df,formula = "BlockID + Tcell_score  ~ celltype", fun.aggregate = length)
cur_df <- as_tibble(cur_df)


# calculate the fraction of Tcytotoxic cells
cur_df <- cur_df %>%
  mutate(Tcytotoxic_fraction = (Tcytotoxic/rowSums(cur_df[,-c(1,2)]))) 

matrixrownames <- as.character(cur_df$BlockID)

m <- as.matrix(cur_df$Tcytotoxic_fraction)
rownames(m) <- matrixrownames
m <- m[order(m[,1]),]

# construct color vector for Tcell score
count_vec <- as.vector(m)

Tcell_score_col <- c(rep("red",length(unique(sce[,which(sce$T_frac_score_per_BlockID == "low" & ! sce$Location == "CTRL")]$BlockID))),
                         rep("orange",length(unique(sce[,which(sce$T_frac_score_per_BlockID == "med"& ! sce$Location == "CTRL")]$BlockID))),
                         rep("darkgreen",length(unique(sce[,which(sce$T_frac_score_per_BlockID == "high"& ! sce$Location == "CTRL")]$BlockID))))

ha <- rowAnnotation(Fraction_Tcyototoxic = anno_barplot(m,gp=gpar(fill=Tcell_score_col),bar_width = 1,height = unit(30,"cm"),width = unit(15,"cm"),show_row_names =FALSE))


patient_meta <- patient_meta[which(patient_meta$Mutation != ""),]

mrownames <- patient_meta$BlockID 
patient_meta_matrix <- as.matrix(patient_meta)

rownames(patient_meta_matrix) <- mrownames
patient_meta_matrix <- patient_meta_matrix[names(m),]

# heatmap consisting of the patient_IDs. one color per patient
h1 = Heatmap(patient_meta_matrix[,"Death"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Death"),show_row_names = FALSE,
             column_labels = "Death",right_annotation =  ha)
h2 = Heatmap(patient_meta_matrix[,"Mutation"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Mutation"),show_row_names = FALSE,
             column_labels = "Mutation")
h4 = Heatmap(patient_meta_matrix[,"Treatment_after_surgery"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Treatment_after_surgery"),show_row_names = FALSE,
             column_labels = "Treatment_after_surgery")
h5 = Heatmap(patient_meta_matrix[,"MM_location"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "MM_location"),show_row_names = FALSE,
             column_labels = "MM_location")
h6 = Heatmap(patient_meta_matrix[,"Adjuvant"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Adjuvant"),show_row_names = FALSE,
             column_labels = "Adjuvant")
h7 = Heatmap(patient_meta_matrix[,"E_I_D"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "E_I_D"),show_row_names = FALSE,
             column_labels = "E_I_D")

ht = grid.grabExpr(draw( h7 + h6 + h5 + h4 + h2  + h1))
grid.newpage()
pushViewport(viewport(angle = 270))
grid.draw(ht)

```

## cytotoxic T cell fraction per PatientID

```{r barplot Tcell score sorted with death for PatientID and interaction_score, fig.height=15, fig.width=15, message=FALSE}
set.seed(362)
cur_df <- data.frame(E_I_D = sce$E_I_D,
                     PatientID = sce$PatientID,
                     celltype = sce$celltype,
                     Tcell_score = sce$T_frac_score_per_PatientID,
                     infiltration = sce$infiltration,
                     MM_location = sce$MM_location)

cur_df <- cur_df[which(cur_df$MM_location != ""),]

cur_df <- reshape2::dcast(cur_df,formula = "PatientID + Tcell_score  ~ celltype", fun.aggregate = length)
cur_df <- as_tibble(cur_df)


# calculate the fraction of Tcytotoxic cells
cur_df <- cur_df %>%
  mutate(Tcytotoxic_fraction = (Tcytotoxic/rowSums(cur_df[,-c(1,2)]))) 

matrixrownames <- as.character(cur_df$PatientID)

m <- as.matrix(cur_df$Tcytotoxic_fraction)
rownames(m) <- matrixrownames
m <- m[order(m[,1]),]

# construct color vector for Tcell score
count_vec <- as.vector(m)

Tcell_score_col <- c(rep("red",length(unique(sce[,which(sce$T_frac_score_per_PatientID == "low" & ! sce$Location == "CTRL")]$PatientID))),
                         rep("orange",length(unique(sce[,which(sce$T_frac_score_per_PatientID == "med"& ! sce$Location == "CTRL")]$PatientID))),
                         rep("darkgreen",length(unique(sce[,which(sce$T_frac_score_per_PatientID == "high"& ! sce$Location == "CTRL")]$PatientID))))

ha <- rowAnnotation(Fraction_Tcyototoxic = anno_barplot(m,gp=gpar(fill=Tcell_score_col),bar_width = 1,height = unit(30,"cm"),width = unit(15,"cm"),show_row_names =FALSE))


patient_meta <- patient_meta[which(patient_meta$Mutation != ""),]

mrownames <- patient_meta$PatientID 
patient_meta_matrix <- as.matrix(patient_meta)

rownames(patient_meta_matrix) <- mrownames
patient_meta_matrix <- patient_meta_matrix[names(m),]

# heatmap consisting of the patient_IDs. one color per patient
h1 = Heatmap(patient_meta_matrix[,"Death"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Death"),show_row_names = FALSE,
             column_labels = "Death",right_annotation =  ha)
h2 = Heatmap(patient_meta_matrix[,"Mutation"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Mutation"),show_row_names = FALSE,
             column_labels = "Mutation")
h4 = Heatmap(patient_meta_matrix[,"Treatment_after_surgery"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Treatment_after_surgery"),show_row_names = FALSE,
             column_labels = "Treatment_after_surgery")
h5 = Heatmap(patient_meta_matrix[,"MM_location"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "MM_location"),show_row_names = FALSE,
             column_labels = "MM_location")
h6 = Heatmap(patient_meta_matrix[,"Adjuvant"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "Adjuvant"),show_row_names = FALSE,
             column_labels = "Adjuvant")
h7 = Heatmap(patient_meta_matrix[,"E_I_D"], width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = TRUE,heatmap_legend_param = list(title = "E_I_D"),show_row_names = FALSE,
             column_labels = "E_I_D")

ht = grid.grabExpr(draw( h7 + h6 + h5 + h4 + h2  + h1))
grid.newpage()
pushViewport(viewport(angle = 270))
grid.draw(ht)

```

