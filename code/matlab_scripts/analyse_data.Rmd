---
title: "Analyse REDSEA data"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script reads in the REDSEA corrected data and compares the corrected 
expression to the non-corrected data.

```{r read-in-data, message=FALSE}
library(SingleCellExperiment)
final_sce <- readRDS("~/Desktop/REDSEA_test/sce_RNA.rds")

cur_folders <- list.files("~/Desktop/REDSEA_test/", pattern = "ZTMA256")
cur_numbers <- read.csv("~/Desktop/REDSEA_masks/max_ids.csv")
rownames(cur_numbers) <- gsub("_ilastik_s2_Probabilities_equalized_cellmask", 
                              "", cur_numbers$X)

cur_out <- lapply(cur_folders,
                  function(x){
                      cur_counts <- read.csv(paste0("~/Desktop/REDSEA_test/", x, 
                                                    "/BM=2_RC=1_Shape=2_Size=2/dataRedSeaScaled.csv"))
                      
                      print(paste("NA:", sum(is.na(cur_counts))))
                      
                      cur_counts <- cur_counts[cur_counts$Row %in% 1:cur_numbers[x,2],]
                      
                      cur_sce <- SingleCellExperiment(assays = list(counts = t(cur_counts[,-1])))
                      colData(cur_sce) <- DataFrame(ObjectNumber = cur_counts$Row,
                                                    ImageId = x)
                      cur_sce
                  })

sce_borders <- do.call("cbind", cur_out)

# Non-corrected counts
cur_out <- lapply(cur_folders,
                  function(x){
                      cur_counts <- read.csv(paste0("~/Desktop/REDSEA_test/", x, 
                                                    "/BM=2_RC=1_Shape=2_Size=2/dataScaled.csv"))
                      
                      print(paste("NA:", sum(is.na(cur_counts))))
                      
                      cur_counts <- cur_counts[cur_counts$Row %in% 1:cur_numbers[x,2],]
                      
                      cur_sce <- SingleCellExperiment(assays = list(counts = t(cur_counts[,-1])))
                      colData(cur_sce) <- DataFrame(ObjectNumber = cur_counts$Row,
                                                    ImageId = x)
                      cur_sce
                  })

sce_noncorrected_borders <- do.call("cbind", cur_out)

cur_out <- lapply(cur_folders,
                  function(x){
                      cur_counts <- read.csv(paste0("~/Desktop/REDSEA_test/", x, 
                                                    "/BM=1_RC=1_Shape=2_Size=2/dataRedSeaScaled.csv"))
                      
                      print(paste("NA:", sum(is.na(cur_counts))))
                      
                      cur_counts <- cur_counts[cur_counts$Row %in% 1:cur_numbers[x,2],]
                      
                      cur_sce <- SingleCellExperiment(assays = list(counts = t(cur_counts[,-1])))
                      colData(cur_sce) <- DataFrame(ObjectNumber = cur_counts$Row,
                                                    ImageId = x)
                      cur_sce
                  })

sce_wholeCell <- do.call("cbind", cur_out)

# Non-corrected counts
cur_out <- lapply(cur_folders,
                  function(x){
                      cur_counts <- read.csv(paste0("~/Desktop/REDSEA_test/", x, 
                                                    "/BM=1_RC=1_Shape=2_Size=2/dataScaled.csv"))
                      
                      print(paste("NA:", sum(is.na(cur_counts))))
                      
                      cur_counts <- cur_counts[cur_counts$Row %in% 1:cur_numbers[x,2],]
                      
                      cur_sce <- SingleCellExperiment(assays = list(counts = t(cur_counts[,-1])))
                      colData(cur_sce) <- DataFrame(ObjectNumber = cur_counts$Row,
                                                    ImageId = x)
                      cur_sce
                  })

sce_noncorrected_wholeCell <- do.call("cbind", cur_out)
```

# Border correction

## Compare corrected vs non-corrected expression

We will first check that the expression of markers that were not corrected 
are the same.

```{r non-corrected-markers}
sce_noncorrected_borders <- sce_noncorrected_borders[,!is.na(colMins(counts(sce_borders)))]
sce_borders <- sce_borders[,!is.na(colMins(counts(sce_borders)))]

library(ggplot2)
ggplot(data.frame(GLUT1_corrected = counts(sce_borders)["Glucose.Transporter.GLUT1",],
                  GLUT1_noncorrected = counts(sce_noncorrected_borders)["Glucose.Transporter.GLUT1",])) +
    geom_point(aes(GLUT1_corrected, GLUT1_noncorrected)) + coord_fixed()

ggplot(data.frame(MPO_corrected = counts(sce_borders)["Myeloperoxidase.MPO",],
                  MPO_noncorrected = counts(sce_noncorrected_borders)["Myeloperoxidase.MPO",])) +
    geom_point(aes(MPO_corrected, MPO_noncorrected)) + coord_fixed()

ggplot(data.frame(Vim_corrected = counts(sce_borders)["Vimentin",],
                  Vim_noncorrected = counts(sce_noncorrected_borders)["Vimentin",])) +
    geom_point(aes(Vim_corrected, Vim_noncorrected)) + coord_fixed()
```

Now look at some of the markers that were affected by spillover.

For this, we will focus on T cells and need to match cell-information between
the datasets.

```{r match-metadata}
cur_df <- colData(final_sce)
cur_image_meta <- read.csv("/Volumes/sh_thoch/Git/MelanomaIMC/data/full_data/rna/cpout/Image.csv")

cur_df$ImageName <- sub("_ilastik_s2_Probabilities_equalized_cellmask.tiff", "", cur_image_meta$FileName_CellImage[cur_df$ImageNumber])
rownames(cur_df) <- paste0(cur_df$ImageName, "_", cur_df$CellNumber)

cur_df <- cur_df[paste0(colData(sce_borders)$ImageId, "_", colData(sce_borders)$ObjectNumber),]

colData(sce_borders) <- colData(sce_noncorrected_borders) <- cur_df
```

## Final plot

Fianlly, we will visualize the corrected vs non-corrected expression in
CD3+ T cells that were previously detected to express the individual cytokines.

```{r final-plot-borderCorrection, fig.width=12, fig.height=12}
cur_tcells <- sce_noncorrected_borders[,sce_noncorrected_borders$celltype_rf %in% 
                        c("Tcytotoxic", "CD134- Tcell", "CD134+ Tcell", "exhausted Tcytotoxic")]
cur_tcells_borders <- sce_borders[,sce_borders$celltype_rf %in% 
                        c("Tcytotoxic", "CD134- Tcell", "CD134+ Tcell", "exhausted Tcytotoxic")] 
all_plots <- list()

for (i in c("CCL4", "CCL18", "CXCL8", "CXCL10", "CXCL12", "CXCL13", 
            "CCL2", "CCL22", "CXCL9", "CCL8", "CCL19")) {
    cur_cells <-  cur_tcells[,colData(cur_tcells)[[i]] == 1] 
    cur_cells_borders <- cur_tcells_borders[,colData(cur_tcells)[[i]] == 1]
    cur_plot <- ggplot(data.frame(corrected = counts(cur_cells_borders)[grepl(paste0(i, "$"), rownames(cur_cells_borders)),],
                       non_corrected = counts(cur_cells)[grepl(paste0(i, "$"), rownames(cur_cells)),])) + 
        geom_point(aes(asinh(corrected), asinh(non_corrected))) + coord_fixed() + 
        theme_minimal(base_size = 13) + geom_abline(slope = 1, intercept = 0, color = "dark red") +
        ggtitle(i)
    all_plots[[i]] <- cur_plot
}

library(cowplot)

plot_grid(plotlist = all_plots)
```

# Whole cell correction

## Compare corrected vs non-corrected expression

We will first check that the expression of markers that were not corrected 
are the same.

```{r non-corrected-markers-2}
final_sce <- readRDS("~/Desktop/REDSEA_test/sce_RNA.rds")

library(ggplot2)
ggplot(data.frame(GLUT1_corrected = counts(sce_wholeCell)["Glucose.Transporter.GLUT1",],
                  GLUT1_noncorrected = counts(sce_noncorrected_wholeCell)["Glucose.Transporter.GLUT1",])) +
    geom_point(aes(GLUT1_corrected, GLUT1_noncorrected)) + coord_fixed()

ggplot(data.frame(MPO_corrected = counts(sce_wholeCell)["Myeloperoxidase.MPO",],
                  MPO_noncorrected = counts(sce_noncorrected_wholeCell)["Myeloperoxidase.MPO",])) +
    geom_point(aes(MPO_corrected, MPO_noncorrected)) + coord_fixed()

ggplot(data.frame(Vim_corrected = counts(sce_wholeCell)["Vimentin",],
                  Vim_noncorrected = counts(sce_noncorrected_wholeCell)["Vimentin",])) +
    geom_point(aes(Vim_corrected, Vim_noncorrected)) + coord_fixed()
```

Now look at some of the markers that were affected by spillover.

For this, we will focus on T cells and need to match cell-information between
the datasets.

```{r match-metadata-wholeCell}
cur_df <- colData(final_sce)

cur_df$ImageName <- sub("_ilastik_s2_Probabilities_equalized_cellmask.tiff", "", cur_image_meta$FileName_CellImage[cur_df$ImageNumber])
rownames(cur_df) <- paste0(cur_df$ImageName, "_", cur_df$CellNumber)

cur_df <- cur_df[paste0(colData(sce_wholeCell)$ImageId, "_", colData(sce_wholeCell)$ObjectNumber),]

colData(sce_wholeCell) <- colData(sce_noncorrected_wholeCell) <- cur_df
```

## Final plot

Fianlly, we will visualize the corrected vs non-corrected expression in
CD3+ T cells that were previously detected to express the individual cytokines.

```{r final-plot-wholeCell, fig.width=12, fig.height=12}
cur_tcells <- sce_noncorrected_wholeCell[,sce_noncorrected_wholeCell$celltype_rf %in% 
                                          c("Tcytotoxic", "CD134- Tcell", "CD134+ Tcell", "exhausted Tcytotoxic")]
cur_tcells_wholeCell <- sce_wholeCell[,sce_wholeCell$celltype_rf %in% 
                                          c("Tcytotoxic", "CD134- Tcell", "CD134+ Tcell", "exhausted Tcytotoxic")] 
all_plots <- list()

for (i in c("CCL4", "CCL18", "CXCL8", "CXCL10", "CXCL12", "CXCL13", 
            "CCL2", "CCL22", "CXCL9", "CCL8", "CCL19")) {
    cur_cells <-  cur_tcells[,colData(cur_tcells)[[i]] == 1] 
    cur_cells_wholeCell <- cur_tcells_wholeCell[,colData(cur_tcells)[[i]] == 1]
    cur_plot <- ggplot(data.frame(corrected = counts(cur_cells_wholeCell)[grepl(paste0(i, "$"), rownames(cur_cells_wholeCell)),],
                       non_corrected = counts(cur_cells)[grepl(paste0(i, "$"), rownames(cur_cells)),])) + 
        geom_point(aes(asinh(corrected), asinh(non_corrected))) + coord_fixed() + 
        theme_minimal(base_size = 13) + geom_abline(slope = 1, intercept = 0, color = "dark red") +
        ggtitle(i)
    all_plots[[i]] <- cur_plot
}

plot_grid(plotlist = all_plots)
```