---
title: "XX_hazard_ratio"
author: ""
date: "2021-02-02"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Preparations

## Load libraries

First, we will load the libraries needed for this part of the analysis.

```{r, message=FALSE}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(SingleCellExperiment)
library(reshape2)
library(tidyverse)
library(dplyr)
library(data.table) 
library(ggplot2)
library(survminer)
library(survival)
```

## Read the data

```{r}
sce_rna = readRDS(file = "data/sce_RNA.rds")
sce_prot = readRDS(file = "data/sce_protein.rds")

# meta data
dat_survival = fread(file = "data/protein/clinical_data_protein.csv",stringsAsFactors = FALSE)
time_data = fread(file = "data/survdat_for_modelling.csv",stringsAsFactors = FALSE)
time_data$BlockID <- time_data$Block.ID
```

## Prepare data

```{r}
# Select for BlockID: Pre-Treatment, Mutation, Age, Cancer Stage
cur_dat <- data.frame(colData(sce_prot)) %>%
  distinct(BlockID, .keep_all = T) %>%
  select(BlockID, Mutation, Age, Cancer_Stage, treatment_status_before_surgery) %>%
  filter(treatment_status_before_surgery != "control")

# derive Tcell Score for Block (max score per block)
score <- data.frame(colData(sce_prot)) %>%
  distinct(Description, .keep_all = T) %>%
  filter(paste(MM_location, Location, sep = "_") != "LN_M") %>% # remove LN margin samples as these are not relevant 
  group_by(BlockID, Tcell_density_score_image) %>%
  summarise(n=n()) %>%
  filter(row_number()==n()) %>% # select last row of groups since this will always be the highest ranking
  select(BlockID, Tcell_density_score_image)

cur_dat <- left_join(cur_dat, score)

# change certain levels
cur_dat$Age <- ifelse(cur_dat$Age == "?60", ">60", cur_dat$Age)
cur_dat$Cancer_Stage <- ifelse(cur_dat$Cancer_Stage == "III or IV", "IV/III", cur_dat$Cancer_Stage)

# relevel factors
cur_dat$Age <- factor(cur_dat$Age, levels = c("<45", "45-59", ">60"))
cur_dat$Mutation <- factor(cur_dat$Mutation, levels = c("wt", "BRAF", "NRAS", "unknown"))
cur_dat$Cancer_Stage <- factor(cur_dat$Cancer_Stage, levels = c("III", "IV"))
cur_dat$treatment_status_before_surgery <- factor(cur_dat$treatment_status_before_surgery, levels = c("naive", "non-naive"))
cur_dat$Tcell_density_score_image <- factor(cur_dat$Tcell_density_score_image, levels = c("high", "med", "low", "absent"))

# join with survival dat
surv <- left_join(time_data[,c("BlockID", "Time_to_.progression_or_last_PET", "censoring_progression", "Time_to_death_or_last_PET", "censoring_death")], cur_dat)
```

## Hazard Ratio Plot 

```{r Hazard_Ratio_Analysis, fig.width=7, fig.height=5, dev=("pdf")}
# exclude GNAQ and KRAS mutation due to too few data points
surv_sub <- surv[!(surv$Mutation %in% c("KRAS", "GNAQ")),]
surv_sub <- surv[!(surv$Cancer_Stage %in% c("III/IV", "unknown")),]
colnames(surv_sub) <- c("BlockID", "Time_progression", "censoring_progression", "Time_death", "censoring_death", 
                        "Mutation", "Age", "Cancer Stage", "Treatment Status", "Max Tcell Score")

model <- coxph(Surv(Time_death, censoring_death) ~ 
                 Age + `Cancer Stage` + `Treatment Status` + `Max Tcell Score` + Mutation,
                data = surv_sub)

ggforest(model, data=surv_sub)
```

