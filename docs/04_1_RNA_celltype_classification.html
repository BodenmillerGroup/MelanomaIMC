<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="toobiwankenobi" />

<meta name="date" content="2020-07-28" />

<title>04_1_RNA_celltype_classification</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/master/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Melanoma Publication</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    RNA TMA
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01_RNA_read_data.html">Read Data</a>
    </li>
    <li>
      <a href="02_RNA_annotations.html">Annotations</a>
    </li>
    <li>
      <a href="03_RNA_quality_control.html">Quality Control</a>
    </li>
    <li>
      <a href="04_1_RNA_celltype_classification.html">Automated Celltype Classification</a>
    </li>
    <li>
      <a href="04_2_RNA_classification_subclustering.html">Subclustering</a>
    </li>
    <li>
      <a href="05_RNA_chemokine_expressing_cells.html">Chemokine-Expressing Cells</a>
    </li>
    <li>
      <a href="06_RNA_chemokine_patch_detection.html">Chemokine Patches</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Protein TMA
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01_Protein_read_data.html">Read Data</a>
    </li>
    <li>
      <a href="02_Protein_annotations.html">Annotations</a>
    </li>
    <li>
      <a href="03_Protein_quality_control.html">Quality Control</a>
    </li>
    <li>
      <a href="04_1_Protein_celltype_classification.html">Automated Celltype Classification</a>
    </li>
    <li>
      <a href="04_2_Protein_classification_subclustering.html">Subclustering</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Misc.
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="00_prepare_clinical_dat.html">Prep Clinical Table</a>
    </li>
    <li>
      <a href="07_TCF7_PD1_gating.html">TCF7/PD1 Gating</a>
    </li>
    <li>
      <a href="08_color_vectors.html">Color Vectors</a>
    </li>
    <li>
      <a href="09_Tcell_Score.html">Tcell Score</a>
    </li>
    <li>
      <a href="10_Dysfunction_Score.html">Dysfunction Score</a>
    </li>
    <li>
      <a href="11_Bcell_Score.html">Bcell Score</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Main Figures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Figure_1.html">Figure 1</a>
    </li>
    <li>
      <a href="Figure_2.html">Figure 2</a>
    </li>
    <li>
      <a href="Figure_3.html">Figure 3</a>
    </li>
    <li>
      <a href="Figure_4.html">Figure 4</a>
    </li>
    <li>
      <a href="Figure_5.html">Figure 5</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Supplemental Figures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Supp-Figure_1.html">Supp-Figure 1</a>
    </li>
    <li>
      <a href="Supp-Figure_2.html">Supp-Figure 2</a>
    </li>
    <li>
      <a href="Supp-Figure_3.html">Supp-Figure 3</a>
    </li>
    <li>
      <a href="Supp-Figure_4.html">Supp-Figure 4</a>
    </li>
    <li>
      <a href="Supp-Figure_5.html">Supp-Figure 5</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Additional Material
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Summary_Statistics.html">Summary Statistics</a>
    </li>
    <li>
      <a href="XX_hazard_ratio.html">Hazard Ratio Analysis</a>
    </li>
    <li>
      <a href="license.html">License</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">04_1_RNA_celltype_classification</h1>
<h4 class="author">toobiwankenobi</h4>
<h4 class="date">2020-07-28</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span> workflowr <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> </a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2021-02-18
</p>
<p>
<strong>Checks:</strong> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 6 <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> 1
</p>
<p>
<strong>Knit directory:</strong> <code>melanoma_publication_old_data/</code> <span class="glyphicon glyphicon-question-sign" aria-hidden="true" title="This is the local directory in which the code in this file was executed."> </span>
</p>
<p>
This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a> analysis was created with <a
  href="https://github.com/jdblischak/workflowr">workflowr</a> (version 1.6.2). The <em>Checks</em> tab describes the reproducibility checks that were applied when the results were created. The <em>Past versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguncommittedchanges"> <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> <strong>R Markdown file:</strong> uncommitted changes </a>
</p>
</div>
<div id="strongRMarkdownfilestronguncommittedchanges" class="panel-collapse collapse">
<div class="panel-body">
<p>The R Markdown file has unstaged changes. To know which version of the R Markdown file created these results, you’ll want to first commit it to the Git repo. If you’re still working on the analysis, you can ignore this warning. When you’re finished, you can run <code>wflow_publish</code> to commit the R Markdown file and build the HTML.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20200728code"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Seed:</strong> <code>set.seed(20200728)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20200728code" class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20200728)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Session information:</strong> recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be confident that you successfully produced the results during this run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomBodenmillerGroupmelanomapublicationtreeee1595de9ec17ee414a5beafb9ed08d174e12139targetblankee1595da"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Repository version:</strong> <a href="https://github.com/BodenmillerGroup/melanoma_publication/tree/ee1595de9ec17ee414a5beafb9ed08d174e12139" target="_blank">ee1595d</a> </a>
</p>
</div>
<div id="strongRepositoryversionstrongahrefhttpsgithubcomBodenmillerGroupmelanomapublicationtreeee1595de9ec17ee414a5beafb9ed08d174e12139targetblankee1595da" class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility.
</p>
<p>
The results in this page were generated with repository version <a href="https://github.com/BodenmillerGroup/melanoma_publication/tree/ee1595de9ec17ee414a5beafb9ed08d174e12139" target="_blank">ee1595d</a>. See the <em>Past versions</em> tab to see a history of the changes made to the R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .DS_Store
    Ignored:    .Rproj.user/
    Ignored:    ._.DS_Store
    Ignored:    analysis/._clinical metadata preparation.Rmd
    Ignored:    code/.DS_Store
    Ignored:    code/._.DS_Store
    Ignored:    data/.DS_Store
    Ignored:    data/._.DS_Store
    Ignored:    data/data_for_analysis/
    Ignored:    data/full_data/
    Ignored:    output/.DS_Store
    Ignored:    output/._.DS_Store
    Ignored:    output/._protein_neutrophil.png
    Ignored:    output/._rna_neutrophil.png
    Ignored:    output/PSOCKclusterOut/
    Ignored:    output/bcell_grouping.png
    Ignored:    output/dysfunction_correlation.pdf

Unstaged changes:
    Modified:   .gitignore
    Modified:   analysis/04_1_Protein_celltype_classification.rmd
    Modified:   analysis/04_1_RNA_celltype_classification.rmd
    Modified:   analysis/04_2_RNA_classification_subclustering.rmd
    Modified:   analysis/04_2_protein_classification_subclustering.rmd
    Modified:   analysis/07_TCF7_PD1_gating.rmd
    Modified:   analysis/08_color_vectors.rmd
    Modified:   analysis/09_Tcell_Score.Rmd
    Modified:   analysis/10_Dysfunction_Score.rmd
    Modified:   analysis/11_Bcell_Score.Rmd
    Modified:   analysis/Figure_1.rmd
    Modified:   analysis/Figure_2.rmd
    Modified:   analysis/Figure_3.rmd
    Modified:   analysis/Figure_4.rmd
    Modified:   analysis/Figure_5.rmd
    Modified:   analysis/Supp-Figure_1.rmd
    Modified:   analysis/Supp-Figure_2.rmd
    Modified:   analysis/Supp-Figure_3.rmd
    Modified:   analysis/Supp-Figure_4.rmd
    Modified:   analysis/Supp-Figure_5.rmd

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were made to the R Markdown (<code>analysis/04_1_RNA_celltype_classification.rmd</code>) and HTML (<code>docs/04_1_RNA_celltype_classification.html</code>) files. If you’ve configured a remote Git repository (see <code>?wflow_git_remote</code>), click on the hyperlinks in the table below to view the files as they were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/ee1595de9ec17ee414a5beafb9ed08d174e12139/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">ee1595d</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2021-02-12
</td>
<td>
clean repo and adapt files
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/BodenmillerGroup/melanoma_publication/ee1595de9ec17ee414a5beafb9ed08d174e12139/docs/04_1_RNA_celltype_classification.html" target="_blank">ee1595d</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2021-02-12
</td>
<td>
clean repo and adapt files
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/BodenmillerGroup/melanoma_publication/3f5af3f59358eebb33aa2a8a06fddca34dad6a6b/docs/04_1_RNA_celltype_classification.html" target="_blank">3f5af3f</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2021-02-09
</td>
<td>
add .html files
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/f9bb33a83d519d86072a7e716214ff78bce022a0/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">f9bb33a</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2021-02-04
</td>
<td>
new Figure 5 and minor changes in figure order
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/2ac183310c0cc9a7a420897f1b99752b1aae10a7/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">2ac1833</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2021-01-08
</td>
<td>
changes to Figures
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/9442cb9048bc92f3320eda95d2b40ce49d09d10e/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">9442cb9</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2020-12-22
</td>
<td>
add all new files
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/d8819f2b618d0620606a5e5b181d3b5340469763/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">d8819f2</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2020-10-08
</td>
<td>
read new data (nuclei expansion) and adapt scripts
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/a21c858d4863579f86e8afbae8e85cff16d1a46f/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">a21c858</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2020-08-06
</td>
<td>
adapt pipeline
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/941155cf459bf26e710660cb4c0865bf105885e1/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">941155c</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2020-08-05
</td>
<td>
Update 04_1_RNA_celltype_classification.rmd
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/2c11d5cd8e42b3be31d1c1f512864b531f93fd7c/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">2c11d5c</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2020-08-05
</td>
<td>
add new scripts
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/512d9449100ff12b72ce04d2283f04badebea98f/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">512d944</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2020-07-30
</td>
<td>
update
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/054e957c8324fc70010b9af49a3fbd5fe34a2340/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">054e957</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2020-07-30
</td>
<td>
switch to Nils’s new pipeline
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/ceedd465f7827ede31e7706af0a31641be255070/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">ceedd46</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2020-07-28
</td>
<td>
update scripts
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/BodenmillerGroup/melanoma_publication/blob/cf46cfa8b12f4f0a91b191b1049f877eac74db54/analysis/04_1_RNA_celltype_classification.rmd" target="_blank">cf46cfa</a>
</td>
<td>
toobiwankenobi
</td>
<td>
2020-07-28
</td>
<td>
create files
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This script performs cell-type classification based on manually labelled cells. We will create increasing complexity for cell type labelling.</p>
</div>
<div id="preparations" class="section level1">
<h1>Preparations</h1>
<pre class="r"><code>knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())</code></pre>
<div id="read-in-data" class="section level2">
<h2>Read in data</h2>
<p>First, we will read in the SingleCellExperiment object and load all libraries.</p>
<pre class="r"><code>library(caret)
library(scater)
library(tidyverse)
library(dittoSeq)
library(viridis)
library(doParallel)</code></pre>
</div>
<div id="load-data" class="section level2">
<h2>Load data</h2>
<pre class="r"><code>sce &lt;- readRDS(&quot;data/data_for_analysis/sce_RNA.rds&quot;)

# load all subsetted sce object from hierarchichal gating and combine the
label.files &lt;- list.files(&quot;data/data_for_analysis/rna/celltype_classifier/&quot;, full.names = TRUE)

# Read in SCE objects
cur_sces &lt;- lapply(label.files, readRDS)

# Merge SCE objects
# Due to relabelling, we now need to match the colData entries and remove rowData
cur_entries &lt;- names(colData(cur_sces[[1]]))

cur_sces &lt;- lapply(cur_sces, function(x){
  colData(x) &lt;- colData(x)[,cur_entries]
  rowData(x) &lt;- NA
  return(x)
  })
  
labelled_sce &lt;- do.call(&quot;cbind&quot;, cur_sces)

# add rowData
rowData(labelled_sce) &lt;- rowData(sce)</code></pre>
</div>
<div id="duplicates" class="section level2">
<h2>Duplicates</h2>
<pre class="r"><code># how many duplicates do we have?
ncol(labelled_sce[,duplicated(labelled_sce$cellID) == T]) / ncol(labelled_sce[,duplicated(labelled_sce$cellID) == F]) * 100</code></pre>
<pre><code>[1] 0.09870831</code></pre>
<pre class="r"><code># remove duplicates (more than 1 label per cellID)
unique_labels &lt;- labelled_sce[,duplicated(labelled_sce$cellID) == F]</code></pre>
</div>
<div id="add-labels-to-sce-object" class="section level2">
<h2>Add labels to SCE object</h2>
<pre class="r"><code>label_vector &lt;- rep(&quot;unlabelled&quot;, ncol(sce))
names(label_vector) &lt;- colnames(sce)
label_vector[colnames(unique_labels)] &lt;- unique_labels$cytomapper_CellLabel

# unique cell labels
unique(label_vector)</code></pre>
<pre><code> [1] &quot;unlabelled&quot;           &quot;Vasculature&quot;          &quot;Tumor&quot;               
 [4] &quot;CD38&quot;                 &quot;HLA-DR&quot;               &quot;CD134- Tcell&quot;        
 [7] &quot;Tcytotoxic&quot;           &quot;CD134+ Tcell&quot;         &quot;Macrophage&quot;          
[10] &quot;Neutrophil&quot;           &quot;Stroma&quot;               &quot;unknown&quot;             
[13] &quot;exhausted Tcytotoxic&quot;</code></pre>
<pre class="r"><code># add to sce
colData(sce)$layer_1_gated &lt;- label_vector</code></pre>
</div>
<div id="create-colour-vector" class="section level2">
<h2>Create colour vector</h2>
<p>Here, we will define a colour vector for the cell-types contained in layer 1.</p>
<pre class="r"><code>layer1_colours &lt;- vector(length = length(unique(label_vector)))
names(layer1_colours) &lt;- unique(label_vector)

layer1_colours[&quot;CD38&quot;] &lt;- &quot;goldenrod2&quot;
layer1_colours[&quot;HLA-DR&quot;] &lt;- &quot;green1&quot;
layer1_colours[&quot;Macrophage&quot;] &lt;- &quot;greenyellow&quot;
layer1_colours[&quot;Neutrophil&quot;] &lt;- &quot;blue1&quot;
layer1_colours[&quot;CD134- Tcell&quot;] &lt;- &quot;yellow&quot;
layer1_colours[&quot;CD134+ Tcell&quot;] &lt;- &quot;sienna1&quot;
layer1_colours[&quot;Vasculature&quot;] &lt;- &quot;red2&quot;
layer1_colours[&quot;Stroma&quot;] &lt;- &quot;tomato&quot;
layer1_colours[&quot;Tcytotoxic&quot;] &lt;- &quot;deepskyblue&quot;
layer1_colours[&quot;exhausted Tcytotoxic&quot;] &lt;- &quot;deeppink&quot;
layer1_colours[&quot;Tumor&quot;] &lt;- &quot;sienna4&quot;
layer1_colours[&quot;unknown&quot;] &lt;- &quot;darkgray&quot;
layer1_colours[&quot;unlabelled&quot;] &lt;- &quot;gray&quot;

# Save in SCE object
metadata(sce)$colour_vectors$layer_1 &lt;- layer1_colours</code></pre>
</div>
<div id="quality-control" class="section level2">
<h2>Quality control</h2>
<p>In the next step, we will check the quality of the labels by:</p>
<ol style="list-style-type: decimal">
<li>checking how many cells contain multiple labels (see chunk 2)</li>
<li>how many cells of how many images are labeled</li>
<li>how balanced the classes are</li>
<li>if the selected cells actually express the markers that they are supposed to express</li>
</ol>
<p>Next, we will check how many cells and how many images are labelled.</p>
<pre class="r"><code># 2. How many cells of how many images are labelled

# Percent cells labelled
as_tibble(colData(sce)) %&gt;% 
  summarise(labelled_cells = sum(layer_1_gated != &quot;unlabelled&quot;)/n()) * 100</code></pre>
<pre><code>  labelled_cells
1       15.00411</code></pre>
<pre class="r"><code># Percent images labelled
as_tibble(colData(sce)) %&gt;% 
  group_by(ImageNumber) %&gt;%
  summarise(labelled_cells = sum(layer_1_gated != &quot;unlabelled&quot;)) %&gt;%
  ungroup() %&gt;%
  summarise(labelled_images = sum(labelled_cells != 0)/n()) * 100</code></pre>
<pre><code>  labelled_images
1        45.78313</code></pre>
<pre class="r"><code># Percent of cells labelled per image
as_tibble(colData(sce)) %&gt;% 
  group_by(ImageNumber) %&gt;%
  summarise(labelled_cells = sum(layer_1_gated != &quot;unlabelled&quot;)/n(),
            number_cells = n()) %&gt;%
  as.data.frame()</code></pre>
<pre><code>    ImageNumber labelled_cells number_cells
1             1   0.0608424337         1282
2             2   0.0000000000         1259
3             3   0.6302583026         5420
4             4   0.6509507179        10308
5             5   0.4851955911         4627
6             6   0.0000000000         1121
7             7   0.4774311927         5450
8             8   0.0000000000         1713
9             9   0.0000000000         2343
10           10   0.0000000000         5227
11           11   0.0857067857         7619
12           12   0.2250061713         8102
13           13   0.1802919708         4110
14           14   0.4633860574         6828
15           15   0.0000000000         3612
16           16   0.0000000000         6202
17           17   0.2685050798         2067
18           18   0.7754577092         6609
19           19   0.5932611312         4986
20           20   0.2851585877         6684
21           21   0.0009721952         5143
22           22   0.1486738887         5354
23           23   0.0000000000         3918
24           24   0.0000000000         6890
25           25   0.0000000000         7950
26           26   0.0000000000         5697
27           27   0.0000000000         5655
28           28   0.0000000000         7343
29           29   0.0000000000         5738
30           30   0.0433778858         8230
31           31   0.0253794266        11860
32           32   0.6440576230         1666
33           33   0.0477107720         6749
34           34   0.0000000000         5818
35           35   0.0000000000         5612
36           36   0.0000000000         4242
37           37   0.2052594003         8404
38           38   0.0000000000          522
39           39   0.3264580370         7030
40           40   0.0687802961         7633
41           41   0.3979097629         3923
42           42   0.3447955390         3228
43           43   0.5761103924         4638
44           44   0.0000000000         5233
45           45   0.0000000000         8065
46           46   0.5218669607         2721
47           47   0.0000000000         1183
48           48   0.0001741857         5741
49           49   0.1722336257         5359
50           50   0.0000000000         1423
51           51   0.6531093126         9761
52           52   0.0000000000         6188
53           53   0.0000000000         7246
54           54   0.4339076079         6559
55           55   0.4261586803         5092
56           56   0.0000000000         1969
57           57   0.0000000000          136
58           58   0.6358640082         7824
59           59   0.0100279851         4288
60           60   0.7352537723         5103
61           61   0.0000000000         6871
62           62   0.0000000000         9609
63           63   0.0000000000         3733
64           64   0.0000000000         5643
65           65   0.2584729256         5134
66           66   0.0000000000         3311
67           67   0.0203687822         4664
68           68   0.8311225500         5051
69           69   0.0000000000         3108
70           70   0.0000000000         4269
71           71   0.0000000000          768
72           72   0.4892120521        10521
73           73   0.4762782900         5965
74           74   0.0000000000         6471
75           75   0.0372771475         4319
76           76   0.0000000000         6186
77           77   0.0000000000         3442
78           78   0.0000000000         6356
79           79   0.0000000000         3308
80           80   0.0042877561         6297
81           81   0.0000000000         7091
82           82   0.0000000000         6886
83           83   0.0000000000         1044
84           84   0.8013168724         6075
85           85   0.0000000000         5666
86           86   0.0521910389         2031
87           87   0.0819985656         4183
88           88   0.0000000000         8960
89           89   0.0000000000         6809
90           90   0.2976159627         7718
91           91   0.0000000000         3523
92           92   0.0000000000         2111
93           93   0.0000000000         4524
94           94   0.9257018768         6447
95           95   0.0000000000         3298
96           96   0.0000000000         1660
97           97   0.0000000000         1715
98           98   0.0000000000         3352
99           99   0.4570678337        11425
100         100   0.0000000000         3155
101         101   0.0000000000         7240
102         102   0.0381465013         4273
103         103   0.1079253449         7394
104         104   0.3565464262         5988
105         105   0.0587593233         5497
106         106   0.4434270765         4587
107         107   0.0000000000         1529
108         108   0.0834852351         5486
109         109   0.0803448707         8003
110         110   0.0000000000         6358
111         111   0.3372817194         8189
112         112   0.0000000000         5278
113         113   0.0000000000         7471
114         114   0.1358318891         4616
115         115   0.1058166989         4659
116         116   0.0000000000         5665
117         117   0.0000000000         5472
118         118   0.0000000000         3151
119         119   0.2458682939         7866
120         120   0.0000000000         6598
121         121   0.0000000000         5310
122         122   0.0819408740         3112
123         123   0.0222222222         7065
124         124   0.0000000000         4971
125         125   0.0000000000         3663
126         126   0.0000000000         8504
127         127   0.0058910162         6790
128         128   0.5924764890         5742
129         129   0.6383304614         5223
130         130   0.0000000000          727
131         131   0.1086138513         9833
132         132   0.0000000000         7723
133         133   0.0000000000         3655
134         134   0.0942982456         5472
135         135   0.0000000000         9404
136         136   0.0000000000         3313
137         137   0.0000000000         7845
138         138   0.0000000000         4145
139         139   0.0537383178         6420
140         140   0.0127215552         6996
141         141   0.4080804517         5668
142         142   0.0000000000         5932
143         143   0.0000000000          729
144         144   0.1777088773         6128
145         145   0.0000000000         3713
146         146   0.0000000000          896
147         147   0.0000000000         4532
148         148   0.0000000000          761
149         149   0.0000000000         2295
150         150   0.0100050025         5997
151         151   0.0303030303        10494
152         152   0.0528153645         4582
153         153   0.0000000000         4204
154         154   0.6292493726         4383
155         155   0.0000000000         6009
156         156   0.0000000000         5227
157         157   0.0000000000          502
158         158   0.0000000000         3326
159         159   0.0000000000         5323
160         160   0.2551888397         2939
161         161   0.0000000000         4527
162         162   0.0767246937         7755
163         163   0.0000000000         6801
164         164   0.0000000000         4910
165         165   0.0315228967         4695
166         166   0.0000000000         5300</code></pre>
<p>We will check how balanced the classes are across the images.</p>
<pre class="r"><code># Total cells per class
as_tibble(colData(sce)) %&gt;%
  group_by(layer_1_gated) %&gt;%
  summarise(number_cells = n())</code></pre>
<pre><code># A tibble: 13 x 2
   layer_1_gated        number_cells
   &lt;chr&gt;                       &lt;int&gt;
 1 CD134- Tcell                20610
 2 CD134+ Tcell                  806
 3 CD38                         4440
 4 exhausted Tcytotoxic          553
 5 HLA-DR                       9407
 6 Macrophage                   7948
 7 Neutrophil                   3264
 8 Stroma                       1560
 9 Tcytotoxic                   4662
10 Tumor                       74661
11 unknown                        72
12 unlabelled                 734588
13 Vasculature                  1692</code></pre>
<pre class="r"><code># Total cells per class and Sample
as_tibble(colData(sce)) %&gt;%
  group_by(layer_1_gated, ImageNumber) %&gt;%
  summarise(number_cells = n()) %&gt;%
  as.data.frame() %&gt;%
  head(.)</code></pre>
<pre><code>  layer_1_gated ImageNumber number_cells
1  CD134- Tcell           4         3995
2  CD134- Tcell           5          759
3  CD134- Tcell           7          512
4  CD134- Tcell          12         1002
5  CD134- Tcell          37          567
6  CD134- Tcell          39         1001</code></pre>
<p>Now, we will check the expression of selected markers across the classes and visualize cell labels on UMAP.</p>
<pre class="r"><code>lab_sce &lt;- sce[,sce$layer_1_gated != &quot;unlabelled&quot;]
agr_sce &lt;- aggregateAcrossCells(lab_sce, ids = colData(lab_sce)[,c(&quot;ImageNumber&quot;, &quot;layer_1_gated&quot;)], 
                                average = TRUE)

assay(agr_sce, &quot;asinh&quot;) &lt;- asinh(counts(agr_sce))
assay(agr_sce, &quot;scaled_asinh&quot;) &lt;- t(scale(t(asinh(counts(agr_sce)))))

colnames(agr_sce) &lt;- paste0(agr_sce$ImageNumber, &quot;_&quot;, agr_sce$layer_1_gated)

# Define markers that were used for gating
cur_markers &lt;- c(&quot;SMA&quot;, &quot;CK5&quot;,&quot;CD38&quot;,&quot;HLADR&quot;,&quot;S100&quot;,&quot;Cadherin11&quot;,&quot;FAP&quot;, &quot;CD134&quot;, &quot;CD68&quot;,
                 &quot;CD3&quot;, &quot;Lag3&quot;, &quot;PD1&quot;, &quot;CD8&quot;, &quot;SOX10&quot;, &quot;CD31&quot;, &quot;Mart1&quot;, &quot;pRB&quot;, &quot;CD15&quot;, &quot;MPO&quot;,
                 &quot;CD163&quot;)

# Non-scaled
dittoHeatmap(agr_sce[cur_markers,], assay = &quot;asinh&quot;,
             cells.use = colnames(agr_sce[cur_markers,]),
            annot.by = c(&quot;ImageNumber&quot;, &quot;layer_1_gated&quot;), 
            order.by = &quot;layer_1_gated&quot;, cluster_rows = FALSE,
            scale = &quot;none&quot;, heatmap.colors = viridis(100), 
            annotation_colors = list(layer_1_gated = metadata(sce)$colour_vectors$layer_1))</code></pre>
<p><img src="figure/04_1_RNA_celltype_classification.rmd/quality-control-4-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Centered and scaled
dittoHeatmap(agr_sce[cur_markers,], assay = &quot;scaled_asinh&quot;,
            annot.by = c(&quot;ImageNumber&quot;, &quot;layer_1_gated&quot;), 
            order.by = &quot;layer_1_gated&quot;, cluster_rows = FALSE,
            annotation_colors = list(layer_1_gated = metadata(sce)$colour_vectors$layer_1),
            heatmap.colors = colorRampPalette(c(&quot;dark blue&quot;, &quot;white&quot;, &quot;dark red&quot;))(100),
            breaks = seq(-3, 3, length.out = 101))</code></pre>
<p><img src="figure/04_1_RNA_celltype_classification.rmd/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>unlab_sce &lt;- sce[,sce$layer_1_gated == &quot;unlabelled&quot;]

ggplot() +
  geom_point(aes(x = UMAP1, y = UMAP2, colour = layer_1_gated), 
             data = data.frame(UMAP1 = reducedDim(unlab_sce, &quot;UMAP&quot;)[,1],
                               UMAP2 = reducedDim(unlab_sce, &quot;UMAP&quot;)[,2],
                               layer_1_gated = colData(unlab_sce)$layer_1_gated)) +
    geom_point(aes(x = UMAP1, y = UMAP2, colour = layer_1_gated), size = 0.5, 
             data = data.frame(UMAP1 = reducedDim(lab_sce, &quot;UMAP&quot;)[,1],
                               UMAP2 = reducedDim(lab_sce, &quot;UMAP&quot;)[,2],
                               layer_1_gated = colData(lab_sce)$layer_1_gated)) +
  scale_color_manual(values = metadata(sce)$colour_vectors$layer_1) + 
  theme_bw()</code></pre>
<p><img src="figure/04_1_RNA_celltype_classification.rmd/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="random-forrest-training" class="section level1">
<h1>Random Forrest Training</h1>
<p>After quality control, we will now use a random forest classifier to classify the remaining cells in the dataset.</p>
<div id="splitting-by-cell-types" class="section level2">
<h2>Splitting by cell-types</h2>
<p>In the first instance, we will split the labelled data based on their cell-types and ignore from which images the calls come. In the current setting most images have been labelled but in the future we want to have a closer look at how well cells of non-labelled images are classified.</p>
<div id="train-and-validate-the-classifier" class="section level3">
<h3>Train and validate the classifier</h3>
<p>We will first split the labelled data into training and test (validation) data at a ratio of 70/30 train/test.</p>
<pre class="r"><code>set.seed(1234)
trainIndex &lt;- createDataPartition(factor(lab_sce$layer_1_gated), p = 0.70)
train_sce &lt;- lab_sce[,trainIndex$Resample1]
test_sce &lt;- lab_sce[,-trainIndex$Resample1]</code></pre>
<p>Here, we will first use a 10-fold crossvalidation by partitioning the data randomly across the full dataset. This process is repeated 5 times. We will also use parallel processing for time reasons. For the <code>randomForrest</code> classifier, we need to tune the <code>mtry</code> parameter - the number of variables sampled for each split.</p>
<pre class="r"><code># Define seeds for parallel processing
# Per iteration, we evaluate 10 models while tuning mtry
set.seed(222)
seeds &lt;- vector(mode = &quot;list&quot;, length = 11)
for (i in 1:10) {
  seeds[[i]] &lt;- sample.int(5000, 10)
}

seeds[[11]] &lt;- sample.int(5000, 1)

fitControl &lt;- trainControl(method = &quot;repeatedcv&quot;,
                           repeats = 1,
                           number = 10,
                           seeds = seeds)

cl &lt;- makePSOCKcluster(round(detectCores()/1.9,0), setup_strategy = &quot;sequential&quot;)
registerDoParallel(cl)

set.seed(1234)

start = Sys.time()
rffit &lt;- train(x = t(assay(train_sce, &quot;asinh&quot;)[rowData(sce)$good_marker,]), 
               y = factor(train_sce$layer_1_gated),
               method = &quot;rf&quot;, ntree = 500,
               tuneLength = 10,
               trControl = fitControl)
stopCluster(cl)
end = Sys.time()
print(end-start)</code></pre>
<pre><code>Time difference of 31.26501 mins</code></pre>
<pre class="r"><code>rffit</code></pre>
<pre><code>Random Forest 

90777 samples
   33 predictor
   12 classes: &#39;CD134- Tcell&#39;, &#39;CD134+ Tcell&#39;, &#39;CD38&#39;, &#39;exhausted Tcytotoxic&#39;, &#39;HLA-DR&#39;, &#39;Macrophage&#39;, &#39;Neutrophil&#39;, &#39;Stroma&#39;, &#39;Tcytotoxic&#39;, &#39;Tumor&#39;, &#39;unknown&#39;, &#39;Vasculature&#39; 

No pre-processing
Resampling: Cross-Validated (10 fold, repeated 1 times) 
Summary of sample sizes: 81700, 81703, 81700, 81699, 81698, 81699, ... 
Resampling results across tuning parameters:

  mtry  Accuracy   Kappa    
   2    0.9845665  0.9754440
   5    0.9918592  0.9870778
   8    0.9930269  0.9889361
  12    0.9931921  0.9891999
  15    0.9931260  0.9890953
  19    0.9927184  0.9884506
  22    0.9923109  0.9878048
  26    0.9917050  0.9868419
  29    0.9913304  0.9862476
  33    0.9907135  0.9852693

Accuracy was used to select the optimal model using the largest value.
The final value used for the model was mtry = 12.</code></pre>
<p>We will now have a look at the accuracy measures over iterations. The only parameter that has been tuned is <code>mtry</code>.</p>
<pre class="r"><code>ggplot(rffit) + 
  geom_errorbar(data = rffit$results,
                aes(ymin = Accuracy - AccuracySD,
                    ymax = Accuracy + AccuracySD),
                width = 0.4)</code></pre>
<p><img src="figure/04_1_RNA_celltype_classification.rmd/accuracy-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>We can also compute the confusion matrix:</p>
<pre class="r"><code>confusionMatrix(rffit)</code></pre>
<pre><code>Cross-Validated (10 fold, repeated 1 times) Confusion Matrix 

(entries are percentual average cell counts across resamples)
 
                      Reference
Prediction             CD134- Tcell CD134+ Tcell CD38 exhausted Tcytotoxic
  CD134- Tcell                 15.8          0.0  0.0                  0.0
  CD134+ Tcell                  0.0          0.6  0.0                  0.0
  CD38                          0.0          0.0  3.4                  0.0
  exhausted Tcytotoxic          0.0          0.0  0.0                  0.4
  HLA-DR                        0.0          0.0  0.0                  0.0
  Macrophage                    0.0          0.0  0.0                  0.0
  Neutrophil                    0.0          0.0  0.0                  0.0
  Stroma                        0.0          0.0  0.0                  0.0
  Tcytotoxic                    0.0          0.0  0.0                  0.0
  Tumor                         0.0          0.0  0.0                  0.0
  unknown                       0.0          0.0  0.0                  0.0
  Vasculature                   0.0          0.0  0.0                  0.0
                      Reference
Prediction             HLA-DR Macrophage Neutrophil Stroma Tcytotoxic Tumor
  CD134- Tcell            0.0        0.0        0.0    0.0        0.0   0.0
  CD134+ Tcell            0.0        0.0        0.0    0.0        0.0   0.0
  CD38                    0.0        0.0        0.0    0.0        0.0   0.0
  exhausted Tcytotoxic    0.0        0.0        0.0    0.0        0.0   0.0
  HLA-DR                  7.2        0.0        0.0    0.1        0.0   0.0
  Macrophage              0.0        6.1        0.0    0.0        0.0   0.0
  Neutrophil              0.0        0.0        2.5    0.0        0.0   0.0
  Stroma                  0.0        0.0        0.0    1.0        0.0   0.0
  Tcytotoxic              0.0        0.0        0.0    0.0        3.5   0.0
  Tumor                   0.0        0.0        0.0    0.1        0.0  57.5
  unknown                 0.0        0.0        0.0    0.0        0.0   0.0
  Vasculature             0.0        0.0        0.0    0.0        0.0   0.0
                      Reference
Prediction             unknown Vasculature
  CD134- Tcell             0.0         0.0
  CD134+ Tcell             0.0         0.0
  CD38                     0.0         0.0
  exhausted Tcytotoxic     0.0         0.0
  HLA-DR                   0.0         0.0
  Macrophage               0.0         0.0
  Neutrophil               0.0         0.0
  Stroma                   0.0         0.0
  Tcytotoxic               0.0         0.0
  Tumor                    0.0         0.0
  unknown                  0.0         0.0
  Vasculature              0.0         1.2
                            
 Accuracy (average) : 0.9932</code></pre>
<p>We will also look at the variable importance.</p>
<pre class="r"><code>cur_varImp &lt;- varImp(rffit)
plot(cur_varImp, top = 34)</code></pre>
<p><img src="figure/04_1_RNA_celltype_classification.rmd/variable-importance-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Finally, we will validate the model using the test data.</p>
<pre class="r"><code>cur_pred &lt;- predict(rffit, newdata = t(assay(test_sce, &quot;asinh&quot;)[rowData(sce)$good_marker,]))

cm &lt;- confusionMatrix(data = cur_pred, reference = factor(test_sce$layer_1_gated))
cm</code></pre>
<pre><code>Confusion Matrix and Statistics

                      Reference
Prediction             CD134- Tcell CD134+ Tcell  CD38 exhausted Tcytotoxic
  CD134- Tcell                 6164            6    10                    1
  CD134+ Tcell                    2          234     0                    0
  CD38                            4            0  1310                    0
  exhausted Tcytotoxic            0            0     0                  160
  HLA-DR                          0            0     1                    0
  Macrophage                      0            1     3                    0
  Neutrophil                      0            0     0                    0
  Stroma                          1            0     3                    0
  Tcytotoxic                     12            0     5                    4
  Tumor                           0            0     0                    0
  unknown                         0            0     0                    0
  Vasculature                     0            0     0                    0
                      Reference
Prediction             HLA-DR Macrophage Neutrophil Stroma Tcytotoxic Tumor
  CD134- Tcell              0          0          0      5         12     0
  CD134+ Tcell              0          0          0      0          1     0
  CD38                      0          2          0      9          1     0
  exhausted Tcytotoxic      0          0          0      0          3     0
  HLA-DR                 2796          0          0     25          0    11
  Macrophage                0       2365          0     19          0     5
  Neutrophil                0          9        978      0          0     0
  Stroma                   11          4          1    386          0     3
  Tcytotoxic                0          0          0      1       1381     0
  Tumor                     5          4          0     22          0 22368
  unknown                   0          0          0      0          0     0
  Vasculature              10          0          0      1          0    11
                      Reference
Prediction             unknown Vasculature
  CD134- Tcell               0           3
  CD134+ Tcell               0           0
  CD38                       0           1
  exhausted Tcytotoxic       0           0
  HLA-DR                     0           9
  Macrophage                 0           0
  Neutrophil                 0           0
  Stroma                     2           0
  Tcytotoxic                 0           1
  Tumor                      3           5
  unknown                   16           0
  Vasculature                0         488

Overall Statistics
                                          
               Accuracy : 0.9935          
                 95% CI : (0.9927, 0.9943)
    No Information Rate : 0.5758          
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
                                          
                  Kappa : 0.9897          
                                          
 Mcnemar&#39;s Test P-Value : NA              

Statistics by Class:

                     Class: CD134- Tcell Class: CD134+ Tcell Class: CD38
Sensitivity                       0.9969            0.970954     0.98348
Specificity                       0.9989            0.999922     0.99955
Pos Pred Value                    0.9940            0.987342     0.98719
Neg Pred Value                    0.9994            0.999819     0.99941
Prevalence                        0.1590            0.006196     0.03424
Detection Rate                    0.1585            0.006016     0.03368
Detection Prevalence              0.1594            0.006093     0.03411
Balanced Accuracy                 0.9979            0.985438     0.99152
                     Class: exhausted Tcytotoxic Class: HLA-DR
Sensitivity                             0.969697       0.99079
Specificity                             0.999923       0.99872
Pos Pred Value                          0.981595       0.98381
Neg Pred Value                          0.999871       0.99928
Prevalence                              0.004242       0.07255
Detection Rate                          0.004113       0.07188
Detection Prevalence                    0.004190       0.07306
Balanced Accuracy                       0.984810       0.99476
                     Class: Macrophage Class: Neutrophil Class: Stroma
Sensitivity                    0.99203           0.99898      0.824786
Specificity                    0.99923           0.99976      0.999349
Pos Pred Value                 0.98830           0.99088      0.939173
Neg Pred Value                 0.99948           0.99997      0.997869
Prevalence                     0.06129           0.02517      0.012031
Detection Rate                 0.06080           0.02514      0.009923
Detection Prevalence           0.06152           0.02537      0.010566
Balanced Accuracy              0.99563           0.99937      0.912068
                     Class: Tcytotoxic Class: Tumor Class: unknown
Sensitivity                    0.98784       0.9987      0.7619048
Specificity                    0.99939       0.9976      1.0000000
Pos Pred Value                 0.98362       0.9983      1.0000000
Neg Pred Value                 0.99955       0.9982      0.9998714
Prevalence                     0.03594       0.5758      0.0005399
Detection Rate                 0.03550       0.5750      0.0004113
Detection Prevalence           0.03609       0.5760      0.0004113
Balanced Accuracy              0.99361       0.9981      0.8809524
                     Class: Vasculature
Sensitivity                     0.96252
Specificity                     0.99943
Pos Pred Value                  0.95686
Neg Pred Value                  0.99951
Prevalence                      0.01303
Detection Rate                  0.01255
Detection Prevalence            0.01311
Balanced Accuracy               0.98098</code></pre>
<pre class="r"><code>data.frame(cm$byClass) %&gt;%
  mutate(class = sub(&quot;Class: &quot;, &quot;&quot;, rownames(cm$byClass))) %&gt;%
  ggplot() + 
  geom_point(aes(1 - Specificity, Sensitivity, 
                 size = Detection.Rate,
                 fill = class),
             shape = 21) + 
  scale_fill_manual(values = metadata(sce)$colour_vectors$layer_1) + 
  theme_bw() + 
  ylab(&quot;Sensitivity (TPR)&quot;) +
  xlab(&quot;1 - Specificity (FPR)&quot;)</code></pre>
<p><img src="figure/04_1_RNA_celltype_classification.rmd/model-testing-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>We will also observe the distribution of classification probabilities per image and class:</p>
<pre class="r"><code>cur_pred &lt;- predict(rffit, newdata = t(assay(test_sce, &quot;asinh&quot;)[rowData(sce)$good_marker,]), 
                    type = &quot;prob&quot;)

cur_pred %&gt;%
  mutate(class = test_sce$layer_1_gated,
         image = test_sce$ImageNumber) %&gt;%
  reshape2::melt(id.vars = c(&quot;class&quot;, &quot;image&quot;), variable.name = &quot;celltype&quot;, value.name = &quot;probability&quot;) %&gt;%
  filter(class == celltype) %&gt;%
  ggplot() +
  geom_boxplot(aes(interaction(image), probability), outlier.size = 0.5) +
    facet_wrap(. ~ class) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1))</code></pre>
<p><img src="figure/04_1_RNA_celltype_classification.rmd/prediciton-probability-1.png" width="1440" style="display: block; margin: auto;" /></p>
<p>This plot shows the median probability for each image and class.</p>
</div>
</div>
</div>
<div id="predicting-new-data" class="section level1">
<h1>Predicting new data</h1>
<p>Finally, we will predict the labels of all other cells. For cell-type classification, we will use the method that was trained across all images.</p>
<pre class="r"><code>start = Sys.time()
cell_labels.class &lt;- as.character(predict.train(rffit, 
                       newdata = t(assay(unlab_sce[rowData(sce)$good_marker,], &quot;asinh&quot;)), 
                       type = &quot;raw&quot;))
cell_labels.prob &lt;- predict.train(rffit, 
                       newdata = t(assay(unlab_sce[rowData(sce)$good_marker,], &quot;asinh&quot;)), 
                       type = &quot;prob&quot;)
end = Sys.time()
print(end-start)</code></pre>
<pre><code>Time difference of 1.015276 mins</code></pre>
<p>Store predictions in SCE object. We will not overwrite the labels of the already labelled cells.</p>
<pre class="r"><code>cell_labels &lt;- sce$layer_1_gated
cell_labels[colnames(unlab_sce)] &lt;- cell_labels.class

sce$celltype &lt;- cell_labels </code></pre>
</div>
<div id="visualization" class="section level1">
<h1>Visualization</h1>
<p>Here, we will visualize the predicted cell-types and their associated classification probabilities.</p>
<div id="using-reduced-dimensions" class="section level2">
<h2>Using reduced dimensions</h2>
<pre class="r"><code>dittoDimPlot(sce[,sce$layer_1_gated != &quot;unlabelled&quot;], var = &quot;celltype&quot;, reduction.use = &quot;UMAP&quot;, size = 0.5, 
              color.panel = metadata(sce)$colour_vectors$layer_1, main = &quot;Cell types gated&quot;)</code></pre>
<p><img src="figure/04_1_RNA_celltype_classification.rmd/UMAP_celltypes_gated-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>dittoDimPlot(sce[,sce$layer_1_gated == &quot;unlabelled&quot;], var = &quot;celltype&quot;, reduction.use = &quot;UMAP&quot;, size = 0.5, 
              color.panel = metadata(sce)$colour_vectors$layer_1, main = &quot;Cell types classified&quot;) </code></pre>
<p><img src="figure/04_1_RNA_celltype_classification.rmd/UMAP_celltypes_classified-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="probabilities-for-all-celltypes" class="section level2">
<h2>Probabilities for all celltypes</h2>
<pre class="r"><code>for (i in unique(cell_labels.class)) {
  cur_df &lt;- data.frame(UMAP1 = reducedDim(unlab_sce, &quot;UMAP&quot;)[,1],
       UMAP2 = reducedDim(unlab_sce, &quot;UMAP&quot;)[,2],
       prob = cell_labels.prob[,i],
       class = cell_labels.class == i)
  
  ggplot() + geom_point(aes(UMAP1, UMAP2), data = cur_df[!cur_df$class,],
                       color = &quot;gray&quot;) +
    geom_point(aes(UMAP1, UMAP2, color = prob), data = cur_df[cur_df$class,],
             size = 0.5)+
    scale_colour_viridis(name = paste0(i, &quot; probability&quot;))
}</code></pre>
</div>
<div id="visualization-of-marker-expression" class="section level2">
<h2>Visualization of marker expression</h2>
<p>Finally, we will visualize the marker expression per cell type using the classified cells.</p>
<pre class="r"><code>unlab_sce &lt;- sce[,sce$layer_1_gated == &quot;unlabelled&quot;]
agr_sce &lt;- aggregateAcrossCells(unlab_sce, ids = colData(unlab_sce)[,c(&quot;ImageNumber&quot;, &quot;celltype&quot;)], 
                                average = TRUE)
assay(agr_sce, &quot;asinh&quot;) &lt;- asinh(counts(agr_sce))

colnames(agr_sce) &lt;- paste0(agr_sce$ImageNumber, &quot;_&quot;, agr_sce$celltype)

# Non-scaled
dittoHeatmap(agr_sce[cur_markers,], assay = &quot;asinh&quot;,
            annot.by = c(&quot;celltype&quot;), 
            order.by = &quot;celltype&quot;, cluster_rows = FALSE,
            scale = &quot;none&quot;, heatmap.colors = viridis(100), 
            annotation_colors = list(celltype = metadata(sce)$colour_vectors$layer_1))</code></pre>
<p><img src="figure/04_1_RNA_celltype_classification.rmd/heatmap-visualization-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code># Centered and scaled
dittoHeatmap(agr_sce[cur_markers,], assay = &quot;asinh&quot;,
            annot.by = c(&quot;celltype&quot;), 
            cluster_rows = FALSE,
            annotation_colors = list(celltype = metadata(sce)$colour_vectors$layer_1),
            heatmap.colors = colorRampPalette(c(&quot;dark blue&quot;, &quot;white&quot;, &quot;dark red&quot;))(100),
            breaks = seq(-3, 3, length.out = 101))</code></pre>
<p><img src="figure/04_1_RNA_celltype_classification.rmd/heatmap-visualization-2.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="save-rds" class="section level1">
<h1>Save RDS</h1>
<pre class="r"><code>saveRDS(sce, &quot;data/data_for_analysis/sce_RNA.rds&quot;)

# create data frame with class and probabilities and save as csv.
layer_1_dat &lt;- as.data.frame(cell_labels.prob)
layer_1_dat$class &lt;- cell_labels.class

write.csv(layer_1_dat, file = &quot;data/data_for_analysis/layer_1_classification_rna.csv&quot;)</code></pre>
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.0.3 (2020-10-10)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 20.04 LTS

Matrix products: default
BLAS/LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.8.so

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] parallel  stats4    stats     graphics  grDevices utils     datasets 
[8] methods   base     

other attached packages:
 [1] doParallel_1.0.16           iterators_1.0.13           
 [3] foreach_1.5.1               viridis_0.5.1              
 [5] viridisLite_0.3.0           dittoSeq_1.0.2             
 [7] forcats_0.5.0               stringr_1.4.0              
 [9] dplyr_1.0.2                 purrr_0.3.4                
[11] readr_1.4.0                 tidyr_1.1.2                
[13] tibble_3.0.4                tidyverse_1.3.0            
[15] scater_1.16.2               SingleCellExperiment_1.12.0
[17] SummarizedExperiment_1.20.0 Biobase_2.50.0             
[19] GenomicRanges_1.42.0        GenomeInfoDb_1.26.2        
[21] IRanges_2.24.1              S4Vectors_0.28.1           
[23] BiocGenerics_0.36.0         MatrixGenerics_1.2.0       
[25] matrixStats_0.57.0          caret_6.0-86               
[27] ggplot2_3.3.3               lattice_0.20-41            
[29] workflowr_1.6.2            

loaded via a namespace (and not attached):
  [1] ggbeeswarm_0.6.0          colorspace_2.0-0         
  [3] ggridges_0.5.3            ellipsis_0.3.1           
  [5] class_7.3-17              rprojroot_2.0.2          
  [7] XVector_0.30.0            BiocNeighbors_1.6.0      
  [9] fs_1.5.0                  rstudioapi_0.13          
 [11] farver_2.0.3              ggrepel_0.9.0            
 [13] fansi_0.4.1               prodlim_2019.11.13       
 [15] lubridate_1.7.9.2         xml2_1.3.2               
 [17] codetools_0.2-18          splines_4.0.3            
 [19] knitr_1.30                jsonlite_1.7.2           
 [21] pROC_1.16.2               broom_0.7.3              
 [23] dbplyr_2.0.0              pheatmap_1.0.12          
 [25] compiler_4.0.3            httr_1.4.2               
 [27] backports_1.2.1           assertthat_0.2.1         
 [29] Matrix_1.3-2              limma_3.44.3             
 [31] cli_2.2.0                 later_1.1.0.1            
 [33] BiocSingular_1.4.0        htmltools_0.5.0          
 [35] tools_4.0.3               rsvd_1.0.3               
 [37] gtable_0.3.0              glue_1.4.2               
 [39] GenomeInfoDbData_1.2.4    reshape2_1.4.4           
 [41] Rcpp_1.0.5                cellranger_1.1.0         
 [43] vctrs_0.3.6               nlme_3.1-151             
 [45] DelayedMatrixStats_1.10.1 timeDate_3043.102        
 [47] gower_0.2.2               xfun_0.20                
 [49] rvest_0.3.6               lifecycle_0.2.0          
 [51] irlba_2.3.3               edgeR_3.30.3             
 [53] zlibbioc_1.36.0           MASS_7.3-53              
 [55] scales_1.1.1              ipred_0.9-9              
 [57] hms_0.5.3                 promises_1.1.1           
 [59] RColorBrewer_1.1-2        yaml_2.2.1               
 [61] gridExtra_2.3             rpart_4.1-15             
 [63] stringi_1.5.3             randomForest_4.6-14      
 [65] e1071_1.7-4               BiocParallel_1.22.0      
 [67] lava_1.6.8.1              rlang_0.4.10             
 [69] pkgconfig_2.0.3           bitops_1.0-6             
 [71] evaluate_0.14             labeling_0.4.2           
 [73] recipes_0.1.15            cowplot_1.1.1            
 [75] tidyselect_1.1.0          plyr_1.8.6               
 [77] magrittr_2.0.1            R6_2.5.0                 
 [79] generics_0.1.0            DelayedArray_0.16.0      
 [81] DBI_1.1.0                 pillar_1.4.7             
 [83] haven_2.3.1               whisker_0.4              
 [85] withr_2.3.0               survival_3.2-7           
 [87] RCurl_1.98-1.2            nnet_7.3-14              
 [89] modelr_0.1.8              crayon_1.3.4             
 [91] utf8_1.1.4                rmarkdown_2.6            
 [93] locfit_1.5-9.4            grid_4.0.3               
 [95] readxl_1.3.1              data.table_1.13.6        
 [97] git2r_0.28.0              ModelMetrics_1.2.2.2     
 [99] reprex_0.3.0              digest_0.6.27            
[101] httpuv_1.5.4              munsell_0.5.0            
[103] beeswarm_0.2.3            vipor_0.4.5              </code></pre>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
