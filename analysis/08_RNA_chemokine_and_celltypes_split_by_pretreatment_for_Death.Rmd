---
title: "celltypes and chemokine expression split by Tfrac score"
author: "Daniel"
date: "18 08 2020"
output: html_document
---

## here we compare the fractions of cell type clusters and marker expressions for T cell score

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# load packages

```{r load packages, message=FALSE}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(LSD)
library(SingleCellExperiment)
library(ggplot2)
library(scater)
library(viridis)
library(igraph)
library(CATALYST)
library(reshape2)
library(cowplot)
library(tidyverse)
```


# load data

```{r load data}
sce = readRDS(file = "data/sce_RNA.rds")

colour_vector <- readRDS("data/colour_vector.rds")

# import T_frac_score and add to sce object
T_frac_score <- readRDS("data/T_frac_score_per_Description")

sce$T_frac_score_per_ImageNumber   <- T_frac_score[sce$Description]

# import also the T cell score per BlockID
T_frac_score <- readRDS("data/T_frac_score_per_BlockID")

sce$T_frac_score_per_BlockID   <- T_frac_score[sce$BlockID]
```

```{r define chemokine expression colentry}
cur_df <- colData(sce)
cur_df <- as_tibble(cur_df)


cur_df <- cur_df[,grepl("CCL|CXCL",colnames(cur_df))]


for(i in colnames(cur_df)){
  cur_df[[i]] <- ifelse(cur_df[[i]]== 1,i,"none")
}

cur_df <- cur_df %>%
  unite(expressor,sep = "_",na.rm =TRUE,remove=FALSE)


cur_df$expressor <- gsub("none_","",cur_df$expressor)
cur_df$expressor <- gsub("_none","",cur_df$expressor)

summary_cur_df <- table(cur_df$expressor)

targets <- names(which(summary_cur_df >250))
targets <- targets[!targets == "none"]


sce$expressor <- cur_df$expressor


sce[,which(! sce$expressor %in% c(targets,"none")) ]$expressor <- "other"
```




```{r}
# subset sce to not contain CTRL samples
sce <- sce[,sce$Location != "CTRL"]

sce <- sce[,which(sce$Death == "ICI")]
```


## chemokine expression by Death for pretreated group
the fraction score defined on the protein dataset does also nicely split up the RNA data

```{r chemokine expression per Death, fig.height=12, fig.width=20, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$expressor <- as.factor(colData(sce)[,"expressor"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death ~ expressor",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "none")%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of celltype per Image")+
  scale_fill_discrete(name = "Death")

p2 <- plotBarFracCluster(sce,colour_by = "expressor",split_by = "Death", scale="count")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```

## community module expression by T_frac score
the fraction score defined on the protein dataset does also nicely split up the RNA data

```{r community module expression per Death, fig.height=12, fig.width=20, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$community_module <- as.factor(colData(sce)[,"community_module"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death ~ community_module",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != 0)%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of celltype per Image")+
  scale_fill_discrete(name = "Death")

p2 <- plotBarFracCluster(sce,colour_by = "community_module",split_by = "Death", scale="count")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```

```{r generate pure_community and pure_cluster colData slots}
# here we generate a colData entry by which we can split the data
sce$pure_community <- ""

sce[,sce$cxcl9only_comm != 0]$pure_community <- "cxcl9only_comm"
sce[,sce$cxcl10only_comm != 0]$pure_community <- "cxcl10only_comm"
sce[,sce$cxcl13only_comm != 0]$pure_community <- "cxcl13only_comm"
sce[,sce$ccl2only_comm != 0]$pure_community <- "ccl2only_comm"
sce[,sce$ccl4only_comm != 0]$pure_community <- "ccl4only_comm"
sce[,sce$ccl18only_comm != 0]$pure_community <- "ccl18only_comm"
sce[,sce$ccl19only_comm != 0]$pure_community <- "ccl19only_comm"
sce[,sce$ccl22only_comm != 0]$pure_community <- "ccl22only_comm"
sce[,sce$cxcl8only_comm != 0]$pure_community <- "cxcl8only_comm"

# here we generate a colData entry by which we can split the data
sce$pure_cluster <- ""

sce[,sce$cxcl9only_clust != 0]$pure_cluster <- "cxcl9only_clust"
sce[,sce$cxcl10only_clust != 0]$pure_cluster <- "cxcl10only_clust"
sce[,sce$cxcl13only_clust != 0]$pure_cluster <- "cxcl13only_clust"
sce[,sce$ccl2only_clust != 0]$pure_cluster <- "ccl2only_clust"
sce[,sce$ccl4only_clust != 0]$pure_cluster <- "ccl4only_clust"
sce[,sce$ccl18only_clust != 0]$pure_cluster <- "ccl18only_clust"
sce[,sce$ccl19only_clust != 0]$pure_cluster <- "ccl19only_clust"
sce[,sce$ccl22only_clust != 0]$pure_cluster <- "ccl22only_clust"
sce[,sce$cxcl8only_clust != 0]$pure_cluster <- "cxcl8only_clust"
```

## pure_community expression by Death
the fraction score defined on the protein dataset does also nicely split up the RNA data

```{r pure_community expression per Death, fig.height=12, fig.width=20, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$pure_community <- as.factor(colData(sce)[,"pure_community"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death ~ pure_community",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != 0)%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of pure_community per Image")+
  scale_fill_discrete(name = "Death")

p2 <- plotBarFracCluster(sce,colour_by = "pure_community",split_by = "Death", scale="count")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```

## pure_cluster expression by T_frac score
the fraction score defined on the protein dataset does also nicely split up the RNA data

```{r pure_cluster expression per Death, fig.height=12, fig.width=20, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$pure_cluster <- as.factor(colData(sce)[,"pure_cluster"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death ~ pure_cluster",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "Var.3")%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of pure_cluster per Image")+
  scale_fill_discrete(name = "Death")

p2 <- plotBarFracCluster(sce,colour_by = "pure_cluster",split_by = "Death", scale="count")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```


## celltype expression by T_frac score
the fraction score defined on the protein dataset does also nicely split up the RNA data

```{r celltype expression per Death, fig.height=12, fig.width=20, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$celltype <- as.factor(colData(sce)[,"celltype"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death ~ celltype",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "Var.3")%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of celltype per Image")+
  scale_fill_discrete(name = "Death")

p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death", scale="count")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```


## Tcytotoxic cluster fractions and marker profile for Death

```{r Tcytotoxic cluster fractions for Death, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Tcytotoxic", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Tcytotoxic", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "Death",celltype_subset = "Tcytotoxic",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of Tcytotoxic cells, fig.height=15, fig.width=20, message=FALSE}
# Aggregate the counts
mean_sce <- calculateSummary(sce, split_by = c( "Death","celltype","celltype_clustered"), 
                             exprs_values = "counts")

# Exclude DNA and Histone
mean_sce <- mean_sce[!grepl("DNA|Histone|Vimentin", rownames(mean_sce)),]

# Transform and scale
assay(mean_sce, "arcsinh") <- asinh(assay(mean_sce, "meanCounts")) 
assay(mean_sce, "arcsinh_scaled") <- t(scale(t(asinh(assay(mean_sce, "meanCounts")))))

# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Tcytotoxic"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "Death"), 
            labels_col = mean_sce[,mean_sce$celltype == "Tcytotoxic"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## marker profile for cytotoxic T cells

```{r marker expression of tumor cell  in skin sub-cutaneous split by pretreatment, fig.height=15, fig.width=15, message=FALSE}
cur_df <- data.frame(t(assay(sce,"asinh")))
cur_df$celltype_clustered <- sce$celltype_clustered
cur_df$celltype <- sce$celltype
cur_df$Death <- sce$Death
cur_df$cellID <- rownames(cur_df)
cur_df$MM_location <- sce$MM_location


# subset to only contain the celltype of interest
cur_df <- cur_df[which(cur_df$celltype == "Tcytotoxic"),]

# long format
cur_df_long <- melt(cur_df)

cur_df_long %>%
  ggplot()+
  geom_boxplot(aes(x = celltype_clustered,y=value, fill=Death))+
  facet_wrap(~variable)+
  theme(axis.text.x = element_text(angle = 90, vjust = 1))
```

## Tcell cluster fractions and marker profile for Death

```{r Tcell cluster fractions for Death, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Tcell", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Tcell", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "Death",celltype_subset = "Tcell",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

__this plot changed from the previous version. way less CD38 positive cells as producers.__

```{r marker expression of Tcells, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Tcell"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "Death"), 
            labels_col = mean_sce[,mean_sce$celltype == "Tcell"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## Macrophage cluster fractions and marker profile for Death

```{r Macrophage cluster fractions for Death, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Macrophage", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Macrophage", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "Death",celltype_subset = "Macrophage",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of Macrophage, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Macrophage"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "Death"), 
            labels_col = mean_sce[,mean_sce$celltype == "Macrophage"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## Tumor cluster fractions and marker profile for Death

```{r Tumor cluster fractions for Death, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Tumor", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Tumor", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "Death",celltype_subset = "Tumor",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of Tumor, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Tumor"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "Death"), 
            labels_col = mean_sce[,mean_sce$celltype == "Tumor"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## CD38 cluster fractions and marker profile for Death

```{r CD38 cluster fractions for Death, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="CD38", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="CD38", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "Death",celltype_subset = "CD38",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

__Plasma cells are basically absent__

## Stroma cluster fractions and marker profile for Death

```{r CD38 cluster fractions for Death, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Stroma", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Stroma", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "Death",celltype_subset = "Stroma",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of Stroma, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Stroma"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "Death"), 
            labels_col = mean_sce[,mean_sce$celltype == "Stroma"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## HLA-DR cluster fractions and marker profile for Death

```{r HLA-DR cluster fractions for Death, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="HLA-DR", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="HLA-DR", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "Death",celltype_subset = "HLA-DR",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of HLA-DR, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "HLA-DR"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "Death"), 
            labels_col = mean_sce[,mean_sce$celltype == "HLA-DR"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## Vasculature cluster fractions and marker profile for Death

```{r Vasculature cluster fractions for Death, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Vasculature", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "Death",celltype_subset ="Vasculature", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "Death",celltype_subset = "Vasculature",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of Vasculature, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Vasculature"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "Death"), 
            labels_col = mean_sce[,mean_sce$celltype == "Vasculature"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```
