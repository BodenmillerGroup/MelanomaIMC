---
title: "Read features from masks"
author: "Nils Eling"
date: "9/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here, I will read in features from masks using cytomapper and compare this 
against the results of REDSEA.

```{r read-data, eval = FALSE}
library(cytomapper)

all_images <- loadImages("/Volumes/bbvolume/server_homes/thoch/Git/MelanomaIMC/data/full_data/rna/cpout/",
                         pattern = "spillcor.tiff", on_disk = TRUE, h5FilesPath = "~/Desktop/cytomapper_h5/images/", as.is = TRUE)
all_masks <- loadImages("/Volumes/bbvolume/server_homes/thoch/Git/MelanomaIMC/data/full_data/rna/cpout/",
                         pattern = "cellmask.tiff", on_disk = TRUE, h5FilesPath = "~/Desktop/cytomapper_h5/masks/", as.is = TRUE)

mcols(all_images) <- mcols(all_masks) <- DataFrame(ImageId = sub("_full_spillcor", "", names(all_images)))

cur_metals <- read.csv("/Volumes/bbvolume/server_homes/thoch/Git/MelanomaIMC/data/full_data/rna/tiffs/20190731_ZTMA256.1_slide2_TH_s1_p14_r1_a1_ac_full.csv", header = FALSE)
cur_panel <- read.csv("/Volumes/bbvolume/server_homes/thoch/Git/MelanomaIMC/data/full_data/rna/config/melanoma_1.06_RNA.csv", header = TRUE)

cur_panel <- cur_panel[match(cur_metals$V1, cur_panel$Metal.Tag),]

channelNames(all_images) <- cur_panel$Target

saveRDS(all_images, "~/Desktop/cytomapper_h5/all_images.rds")
saveRDS(all_masks, "~/Desktop/cytomapper_h5/all_masks.rds")
```

Now, we'll measure the expression of cells.

```{r measureObject}
sce <- measureObjects(mask = all_masks, image = all_images, img_id = "ImageId")


```