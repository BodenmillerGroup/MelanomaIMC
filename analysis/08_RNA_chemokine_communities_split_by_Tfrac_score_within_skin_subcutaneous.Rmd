---
title: "celltypes and chemokine expression split by Tfrac score"
author: "Daniel"
date: "18 08 2020"
output: html_document
---

## here we compare the fractions of cell type clusters and marker expressions for T cell score

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# load packages

```{r load packages, message=FALSE}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(LSD)
library(SingleCellExperiment)
library(ggplot2)
library(scater)
library(viridis)
library(igraph)
library(CATALYST)
library(reshape2)
library(cowplot)
library(tidyverse)
```


# load data

```{r load data}
sce = readRDS(file = "data/sce_RNA.rds")

colour_vector <- readRDS("data/colour_vector.rds")

# import T_frac_score and add to sce object
T_frac_score <- readRDS("data/T_frac_score_per_Description")

sce$T_frac_score_per_ImageNumber   <- T_frac_score[sce$Description]

# import also the T cell score per BlockID
T_frac_score <- readRDS("data/T_frac_score_per_BlockID")

sce$T_frac_score_per_BlockID   <- T_frac_score[sce$BlockID]
```

```{r define chemokine expression colentry}
cur_df <- colData(sce)
cur_df <- as_tibble(cur_df)


cur_df <- cur_df[,grepl("CCL|CXCL",colnames(cur_df))]


for(i in colnames(cur_df)){
  cur_df[[i]] <- ifelse(cur_df[[i]]== 1,i,"none")
}

cur_df <- cur_df %>%
  unite(expressor,sep = "_",na.rm =TRUE,remove=FALSE)


cur_df$expressor <- gsub("none_","",cur_df$expressor)
cur_df$expressor <- gsub("_none","",cur_df$expressor)

summary_cur_df <- table(cur_df$expressor)

targets <- names(which(summary_cur_df >250))
targets <- targets[!targets == "none"]


sce$expressor <- cur_df$expressor


sce[,which(! sce$expressor %in% c(targets,"none")) ]$expressor <- "other"
```


```{r adapt T cell score to numbers, fig.height=10, fig.width=10}

sce[,which(sce$T_frac_score_per_ImageNumber == "low" & sce$Location != "CTRL")]$T_frac_score_per_ImageNumber <- 0
sce[,which(sce$T_frac_score_per_ImageNumber == "med" & sce$Location != "CTRL")]$T_frac_score_per_ImageNumber <- 1
sce[,which(sce$T_frac_score_per_ImageNumber == "high" & sce$Location != "CTRL")]$T_frac_score_per_ImageNumber <- 2

sce <- sce[,sce$MM_location == "skin_subcutaneous"]
```


## chemokine expression by T_frac score
the fraction score defined on the protein dataset does also nicely split up the RNA data

```{r chemokine expression per T_frac_score_per_ImageNumber, fig.height=12, fig.width=20, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$expressor <- as.factor(colData(sce)[,"expressor"])

cur_df$T_frac_score_per_ImageNumber <- as.factor(colData(sce)[,"T_frac_score_per_ImageNumber"])

cur_df <- dcast(cur_df,formula = " ImageNumber + T_frac_score_per_ImageNumber ~ expressor",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","T_frac_score_per_ImageNumber"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "none")%>%
  ggplot(aes(x=variable,y=frac,fill=T_frac_score_per_ImageNumber))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of celltype per Image")+
  scale_fill_discrete(name = "T_frac_score_per_ImageNumber")

p2 <- plotBarFracCluster(sce,colour_by = "expressor",split_by = "T_frac_score_per_ImageNumber", scale="count")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```

## community module expression by T_frac score
the fraction score defined on the protein dataset does also nicely split up the RNA data

```{r community module expression per T_frac_score_per_ImageNumber, fig.height=12, fig.width=20, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$community_module <- as.factor(colData(sce)[,"community_module"])

cur_df$T_frac_score_per_ImageNumber <- as.factor(colData(sce)[,"T_frac_score_per_ImageNumber"])

cur_df <- dcast(cur_df,formula = " ImageNumber + T_frac_score_per_ImageNumber ~ community_module",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","T_frac_score_per_ImageNumber"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != 0)%>%
  ggplot(aes(x=variable,y=frac,fill=T_frac_score_per_ImageNumber))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of celltype per Image")+
  scale_fill_discrete(name = "T_frac_score_per_ImageNumber")

p2 <- plotBarFracCluster(sce,colour_by = "community_module",split_by = "T_frac_score_per_ImageNumber", scale="count")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```

```{r generate pure_community and pure_cluster colData slots}
# here we generate a colData entry by which we can split the data
sce$pure_community <- ""

sce[,sce$cxcl9only_comm != 0]$pure_community <- "cxcl9only_comm"
sce[,sce$cxcl10only_comm != 0]$pure_community <- "cxcl10only_comm"
sce[,sce$cxcl13only_comm != 0]$pure_community <- "cxcl13only_comm"
sce[,sce$ccl2only_comm != 0]$pure_community <- "ccl2only_comm"
sce[,sce$ccl4only_comm != 0]$pure_community <- "ccl4only_comm"
sce[,sce$ccl18only_comm != 0]$pure_community <- "ccl18only_comm"
sce[,sce$ccl19only_comm != 0]$pure_community <- "ccl19only_comm"
sce[,sce$ccl22only_comm != 0]$pure_community <- "ccl22only_comm"
sce[,sce$cxcl8only_comm != 0]$pure_community <- "cxcl8only_comm"

# here we generate a colData entry by which we can split the data
sce$pure_cluster <- ""

sce[,sce$cxcl9only_clust != 0]$pure_cluster <- "cxcl9only_clust"
sce[,sce$cxcl10only_clust != 0]$pure_cluster <- "cxcl10only_clust"
sce[,sce$cxcl13only_clust != 0]$pure_cluster <- "cxcl13only_clust"
sce[,sce$ccl2only_clust != 0]$pure_cluster <- "ccl2only_clust"
sce[,sce$ccl4only_clust != 0]$pure_cluster <- "ccl4only_clust"
sce[,sce$ccl18only_clust != 0]$pure_cluster <- "ccl18only_clust"
sce[,sce$ccl19only_clust != 0]$pure_cluster <- "ccl19only_clust"
sce[,sce$ccl22only_clust != 0]$pure_cluster <- "ccl22only_clust"
sce[,sce$cxcl8only_clust != 0]$pure_cluster <- "cxcl8only_clust"
```

## pure_community expression by T_frac score
the fraction score defined on the protein dataset does also nicely split up the RNA data

```{r pure_community expression per T_frac_score_per_ImageNumber, fig.height=12, fig.width=20, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$pure_community <- as.factor(colData(sce)[,"pure_community"])

cur_df$T_frac_score_per_ImageNumber <- as.factor(colData(sce)[,"T_frac_score_per_ImageNumber"])

cur_df <- dcast(cur_df,formula = " ImageNumber + T_frac_score_per_ImageNumber ~ pure_community",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","T_frac_score_per_ImageNumber"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != 0)%>%
  ggplot(aes(x=variable,y=frac,fill=T_frac_score_per_ImageNumber))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of pure_community per Image")+
  scale_fill_discrete(name = "T_frac_score_per_ImageNumber")

p2 <- plotBarFracCluster(sce,colour_by = "pure_community",split_by = "T_frac_score_per_ImageNumber", scale="count")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```

## pure_cluster expression by T_frac score
the fraction score defined on the protein dataset does also nicely split up the RNA data

```{r pure_cluster expression per T_frac_score_per_ImageNumber, fig.height=12, fig.width=20, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$pure_cluster <- as.factor(colData(sce)[,"pure_cluster"])

cur_df$T_frac_score_per_ImageNumber <- as.factor(colData(sce)[,"T_frac_score_per_ImageNumber"])

cur_df <- dcast(cur_df,formula = " ImageNumber + T_frac_score_per_ImageNumber ~ pure_cluster",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","T_frac_score_per_ImageNumber"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "Var.3")%>%
  ggplot(aes(x=variable,y=frac,fill=T_frac_score_per_ImageNumber))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of pure_cluster per Image")+
  scale_fill_discrete(name = "T_frac_score_per_ImageNumber")

p2 <- plotBarFracCluster(sce,colour_by = "pure_cluster",split_by = "T_frac_score_per_ImageNumber", scale="count")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```

## chemokine expression by Death

```{r chemokine expression by Death,fig.height=10, fig.width=10, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$expressor <- as.factor(colData(sce)[,"expressor"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death ~ expressor",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "none",)%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of celltype per Image")+
  scale_fill_discrete(name = "Death")

p2 <- plotBarFracCluster(sce,colour_by = "expressor",split_by = "Death", scale="percent")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```



```{r Tcytotoxic cell fractions for Death within skin_subcutaneous, fig.height=10, fig.width=10}
p1 <- plotCellFracGroupsSubset(sce[,which(sce$treatment_group_before_surgery == "ICI")],CellClass = "celltype",split_by = "Death",celltype_subset = "Tcytotoxic",cluster_col = "celltype_clustered")
p2 <- plotCellFracGroupsSubset(sce[,sce$treatment_group_before_surgery == "untreated"],CellClass = "celltype",split_by = "Death",celltype_subset = "Tcytotoxic",cluster_col = "celltype_clustered")
p3 <- plotCellFracGroupsSubset(sce[,sce$treatment_group_before_surgery %in% c("untreated","ICI")],CellClass = "celltype",split_by = "treatment_group_before_surgery",celltype_subset = "Tcytotoxic",cluster_col = "celltype_clustered")
plot_grid(p1,p2,p3)
```

__Tcytotoxic_3 are almost absent from samples of patients that die. as you can see below,these are the chemokine expressing cytotoxic T cells.__

```{r marker expression of cytotoxic T cells clusters within skin_subcutaneous, fig.height=10, fig.width=10}
mean_sce <- calculateSummary(sce, split_by = c( "celltype","celltype_clustered"), 
                             exprs_values = "counts")

# Exclude DNA and Histone
mean_sce <- mean_sce[!grepl("DNA|Histone|Vimentin", rownames(mean_sce)),]

# Transform and scale
assay(mean_sce, "arcsinh") <- asinh(assay(mean_sce, "meanCounts")) 
assay(mean_sce, "arcsinh_scaled") <- t(scale(t(asinh(assay(mean_sce, "meanCounts")))))

# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Tcytotoxic"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered"), 
            labels_col = mean_sce[,mean_sce$celltype == "Tcytotoxic"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

mean_sce <- calculateSummary(sce[,sce$treatment_group_before_surgery], split_by = c( "Death","celltype","celltype_clustered"), 
                             exprs_values = "counts")

# Exclude DNA and Histone
mean_sce <- mean_sce[!grepl("DNA|Histone|Vimentin", rownames(mean_sce)),]

# Transform and scale
assay(mean_sce, "arcsinh") <- asinh(assay(mean_sce, "meanCounts")) 
assay(mean_sce, "arcsinh_scaled") <- t(scale(t(asinh(assay(mean_sce, "meanCounts")))))

# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Tcytotoxic"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered","Death"), 
            labels_col = mean_sce[,mean_sce$celltype == "Tcytotoxic"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## community fractions by Death

```{r community_module expression by Death,fig.height=10, fig.width=10, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$community_module <- as.factor(colData(sce)[,"community_module"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death ~ community_module",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != 0,)%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of celltype per Image")+
  scale_fill_discrete(name = "Death")

p2 <- plotBarFracCluster(sce,colour_by = "community_module",split_by = "Death", scale="percent")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```


## community module expression by Death within skin_subcutaneous

```{r community_module expression by Death within skin_subcutaneous,fig.height=10, fig.width=10, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$community_module <- as.factor(colData(sce)[,"community_module"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df$MM_location <- as.factor(colData(sce)[,"MM_location"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death + MM_location ~ community_module",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death","MM_location"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != 0,MM_location == "skin_subcutaneous")%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of community module per Image")+
  scale_fill_discrete(name = "Death")

p2 <- cur_df %>%
  group_by(Death) %>%
  filter(MM_location == "skin_subcutaneous") %>%
  select(! MM_location) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != 0)%>%
  ggplot(aes(x=Death,y=frac,fill=variable))+
  geom_bar(stat="identity")+
            theme(axis.text.x = element_text(angle = 45, hjust = 1),
                  axis.title.x = element_blank(),
                  panel.background = element_blank(),
                  panel.grid.minor=element_blank(),
                  panel.grid.major.x=element_blank(),
                  panel.grid.major.y=element_line(color="grey", size=.3)) +
            ylab("Cell fraction of all cells per group") + scale_fill_discrete(name = "Death")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```




## pure chemokine communities separated by Death

```{r pure_community expression by Death,fig.height=10, fig.width=10, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$pure_community <- as.factor(colData(sce)[,"pure_community"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death ~ pure_community",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "Var.3",)%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of pure_community per Image")+
  scale_fill_discrete(name = "Death")

p2 <- plotBarFracCluster(sce,colour_by = "pure_community",split_by = "Death", scale="percent")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```


## pure_community separated by Death within skin_subcutaneous

```{r pure_community expression by Death within skin_subcutaneous,fig.height=10, fig.width=10, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$pure_community <- as.factor(colData(sce)[,"pure_community"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df$MM_location <- as.factor(colData(sce)[,"MM_location"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death + MM_location ~ pure_community",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death","MM_location"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "Var.4",MM_location == "skin_subcutaneous")%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of pure_community per Image")+
  scale_fill_discrete(name = "Death")

p2 <- cur_df %>%
  group_by(Death) %>%
  filter(MM_location == "skin_subcutaneous") %>%
  select(! MM_location) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "Var.4")%>%
  ggplot(aes(x=Death,y=frac,fill=variable))+
  geom_bar(stat="identity")+
            theme(axis.text.x = element_text(angle = 45, hjust = 1),
                  axis.title.x = element_blank(),
                  panel.background = element_blank(),
                  panel.grid.minor=element_blank(),
                  panel.grid.major.x=element_blank(),
                  panel.grid.major.y=element_line(color="grey", size=.3)) +
            ylab("Cell fraction of all cells per group") + scale_fill_discrete(name = "Death")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```


## pure_cluster separated by Death

```{r pure_cluster expression by Death,fig.height=10, fig.width=10, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$pure_cluster <- as.factor(colData(sce)[,"pure_cluster"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death ~ pure_cluster",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "Var.3",)%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of pure_cluster per Image")+
  scale_fill_discrete(name = "Death")

p2 <- plotBarFracCluster(sce,colour_by = "pure_cluster",split_by = "Death", scale="percent")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```


## pure_cluster separated by Death within skin_subcutaneous

```{r pure_cluster expression by Death within skin_subcutaneous,fig.height=10, fig.width=10, message=FALSE}
cur_df <- data.frame( "ImageNumber" = as.factor(colData(sce)[,"ImageNumber"]))

cur_df$pure_cluster <- as.factor(colData(sce)[,"pure_cluster"])

cur_df$Death <- as.factor(colData(sce)[,"Death"])

cur_df$MM_location <- as.factor(colData(sce)[,"MM_location"])

cur_df <- dcast(cur_df,formula = " ImageNumber + Death + MM_location ~ pure_cluster",fun.aggregate = length)

cur_df <- melt(cur_df,id.vars = c("ImageNumber","Death","MM_location"))

p1 <- cur_df %>%
  group_by(ImageNumber) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "Var.4",MM_location == "skin_subcutaneous")%>%
  ggplot(aes(x=variable,y=frac,fill=Death))+
  geom_boxplot(outlier.shape = NA,position=position_dodge(width=1))+
  geom_jitter(position = position_jitterdodge(dodge.width = 1, jitter.width = 0.05),lwd=0.4)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  ylab("Fraction of pure_cluster per Image")+
  scale_fill_discrete(name = "Death")

p2 <- cur_df %>%
  group_by(Death) %>%
  filter(MM_location == "skin_subcutaneous") %>%
  select(! MM_location) %>%
  mutate(total = sum(value), frac = value/total) %>%
  filter(variable != "Var.4")%>%
  ggplot(aes(x=Death,y=frac,fill=variable))+
  geom_bar(stat="identity")+
            theme(axis.text.x = element_text(angle = 45, hjust = 1),
                  axis.title.x = element_blank(),
                  panel.background = element_blank(),
                  panel.grid.minor=element_blank(),
                  panel.grid.major.x=element_blank(),
                  panel.grid.major.y=element_line(color="grey", size=.3)) +
            ylab("Cell fraction of all cells per group") + scale_fill_discrete(name = "Death")

plot_grid(p1, p2,ncol=1, rel_heights = c(2,1))
```


