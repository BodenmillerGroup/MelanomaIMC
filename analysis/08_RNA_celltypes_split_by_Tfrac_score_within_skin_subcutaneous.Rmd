---
title: "celltypes and chemokine expression split by Tfrac score"
author: "Daniel"
date: "18 08 2020"
output: html_document
---

## here we compare the fractions of cell type clusters and marker expressions for T cell score

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# load packages

```{r load packages, message=FALSE}
sapply(list.files("code/helper_functions/", full.names = TRUE), source)
library(LSD)
library(SingleCellExperiment)
library(ggplot2)
library(scater)
library(viridis)
library(igraph)
library(CATALYST)
library(reshape2)
library(cowplot)
library(tidyverse)
```


# load data

```{r load data}
sce = readRDS(file = "data/sce_RNA.rds")

colour_vector <- readRDS("data/colour_vector.rds")

# import T_frac_score and add to sce object
T_frac_score <- readRDS("data/T_frac_score_per_Description")

sce$T_frac_score_per_ImageNumber   <- T_frac_score[sce$Description]

# import also the T cell score per BlockID
T_frac_score <- readRDS("data/T_frac_score_per_BlockID")

sce$T_frac_score_per_BlockID   <- T_frac_score[sce$BlockID]
```


```{r adapt T cell score to numbers, fig.height=10, fig.width=10}

sce[,which(sce$T_frac_score_per_ImageNumber == "low" & sce$Location != "CTRL")]$T_frac_score_per_ImageNumber <- 0
sce[,which(sce$T_frac_score_per_ImageNumber == "med" & sce$Location != "CTRL")]$T_frac_score_per_ImageNumber <- 1
sce[,which(sce$T_frac_score_per_ImageNumber == "high" & sce$Location != "CTRL")]$T_frac_score_per_ImageNumber <- 2

  # subset sce to not contain CTRL samples
sce <- sce[,sce$Location != "CTRL"]

sce <- sce[,sce$MM_location == "skin_subcutaneous"]
```



## celltypes per T_frac score
the fraction score defined on the protein dataset does also nicely split up the RNA data

```{r celltype fractions per T_frac_score_per_ImageNumber, fig.height=12, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",scale = "percent")+theme(legend.position = "none")

p3 <- plotCellFracGroups(sce,CellClass = "celltype",color_by = "T_frac_score_per_ImageNumber")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

__essentially no plasma cells (CD38+) in images with no cytotoxic T cells__


## Tcytotoxic cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r Tcytotoxic cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Tcytotoxic", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Tcytotoxic", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset = "Tcytotoxic",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of Tcytotoxic cells, fig.height=15, fig.width=20, message=FALSE}
# Aggregate the counts
mean_sce <- calculateSummary(sce, split_by = c( "T_frac_score_per_ImageNumber","celltype","celltype_clustered"), 
                             exprs_values = "counts")

# Exclude DNA and Histone
mean_sce <- mean_sce[!grepl("DNA|Histone|Vimentin", rownames(mean_sce)),]

# Transform and scale
assay(mean_sce, "arcsinh") <- asinh(assay(mean_sce, "meanCounts")) 
assay(mean_sce, "arcsinh_scaled") <- t(scale(t(asinh(assay(mean_sce, "meanCounts")))))

# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Tcytotoxic"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "T_frac_score_per_ImageNumber"), 
            labels_col = mean_sce[,mean_sce$celltype == "Tcytotoxic"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## Tcell cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r Tcell cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Tcell", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Tcell", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset = "Tcell",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

__this plot changed from the previous version. way less CD38 positive cells as producers.__

```{r marker expression of Tcells, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Tcell"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "T_frac_score_per_ImageNumber"), 
            labels_col = mean_sce[,mean_sce$celltype == "Tcell"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## Macrophage cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r Macrophage cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Macrophage", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Macrophage", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset = "Macrophage",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of Macrophage, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Macrophage"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "T_frac_score_per_ImageNumber"), 
            labels_col = mean_sce[,mean_sce$celltype == "Macrophage"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

__CXCL9 expression is strongest in those macrophages from samples with many Tcytotoxic cells. Basically, CXCL9 expressing macrophages are absent in samples with no Tcytotoxic cells. CCL18 expressed is observed in CD163 positive macrophages and is also strongest in samples with many Tcyototxic cells.__

## Tumor cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r Tumor cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Tumor", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Tumor", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset = "Tumor",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of Tumor, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Tumor"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "T_frac_score_per_ImageNumber"), 
            labels_col = mean_sce[,mean_sce$celltype == "Tumor"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## CD38 cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r CD38 cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="CD38", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="CD38", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset = "CD38",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of CD38, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "CD38"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "T_frac_score_per_ImageNumber"), 
            labels_col = mean_sce[,mean_sce$celltype == "CD38"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## Stroma cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r CD38 cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Stroma", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Stroma", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset = "Stroma",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of Stroma, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Stroma"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "T_frac_score_per_ImageNumber"), 
            labels_col = mean_sce[,mean_sce$celltype == "Stroma"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## HLA-DR cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r HLA-DR cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="HLA-DR", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="HLA-DR", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset = "HLA-DR",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of HLA-DR, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "HLA-DR"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "T_frac_score_per_ImageNumber"), 
            labels_col = mean_sce[,mean_sce$celltype == "HLA-DR"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

## Vasculature cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r Vasculature cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Vasculature", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset ="Vasculature", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_subset = "Vasculature",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

```{r marker expression of Vasculature, fig.height=15, fig.width=20, message=FALSE}
# Scaled
plotHeatmap(mean_sce[,mean_sce$celltype == "Vasculature"], exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltype_clustered", "T_frac_score_per_ImageNumber"), 
            labels_col = mean_sce[,mean_sce$celltype == "Vasculature"]$celltype_clustered,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE, cluster_cols = FALSE)

```

