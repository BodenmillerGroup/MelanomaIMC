---
title: "XX_Protein_p75_analysis"
author: "toobiwankenobi"
date: "2020-10-07"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Preparations

## Load packages and helper functions

```{r message=F}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(SingleCellExperiment)
library(ggplot2)
library(reshape2)
library(cowplot)
library(dplyr)
library(sf)
library(gridExtra)
library(scater)
library(dittoSeq)
library(RColorBrewer)
library(neighbouRhood)
library(ComplexHeatmap)
```

## Load data

```{r load data}
sce_protein = readRDS(file = "data/sce_protein.rds")
```

# p75 Analysis

## p75 Defintion

```{r}
# create manual cut-off for p75+ cells
p75_vec <- assay(sce_protein["p75",],"asinh")>1.5

class_vec <- vector(length = length(unique(sce_protein$cellID)))
class_vec[p75_vec] <- "p75pos"
class_vec[class_vec == "FALSE"] <- "p75neg"

sce_protein$p75 <- class_vec

# p75 Tumor
sce_protein[,which(sce_protein$p75 == "p75pos" & sce_protein$celltype == "Tumor")]$p75 <- "p75pos_Tumor"
```

## Run Cluster/Community Detection on p75+ Tumor Cells

```{r}
# find p75 tumor clusters
sce_protein <- findClusters(sce_protein, sce_protein[,colData(sce_protein)$p75 == "p75pos_Tumor"]$cellID , 
                    'cellID', 
                    'Center_X', 'Center_Y', 
                    'ImageNumber', 
                    distance = 30, 
                    min_clust_size = 5,
                    output_colname = "p75_Tumor_cluster")

# number of p75 tumor clusters
length(unique(sce_protein$p75_Tumor_cluster))

# define community
sce_protein <- findCommunity(sce_protein, 
                     'cellID', 
                     'Center_X', 'Center_Y', 
                     'ImageNumber', 
                     'p75_Tumor_cluster', 
                     distance = 30,
                     output_colname = "p75_Tumor_community",
                     plot = FALSE)


# number of chemokine communities
length(unique(sce_protein$p75_Tumor_community))
```

## p75+ tumors and control tumors

```{r}
data.frame(colData(sce_protein)) %>%
  filter(p75_Tumor_community > 0) %>%
  group_by(Description, MM_location, Location, PatientID) %>%
  summarise(n=n()) %>%
  distinct(Description, .keep_all = T)

# these images show a high amount of p75 communities
p75_tumor_images <- c("B9", "E9", "F9", "M9", "N5", "N9", "P5")

# 3 LN, 2 skin_subcutaneous, 2 visceral

# select random samples from control groups
control_tumor_images <- data.frame(colData(sce_protein)) %>%
  filter(!(Description %in% p75_tumor_images)) %>%
  filter(p75 != "p75pos_Tumor") %>%
  filter(MM_location %in% c("LN", "visceral", "skin_subcutaneous")) %>%
  distinct(Description, .keep_all = T) %>%
  group_by(Description) %>%
  select(Description, MM_location)

ctrl_LN <- sample(control_tumor_images[control_tumor_images$MM_location == "LN",]$Description, 6)
ctrl_skin <- sample(control_tumor_images[control_tumor_images$MM_location == "skin_subcutaneous",]$Description, 4)
ctrl_visceral <- sample(control_tumor_images[control_tumor_images$MM_location == "visceral",]$Description, 4)

control_tumor_images <- c(ctrl_LN, ctrl_skin, ctrl_visceral)
```

## Run Cluster/Community Detection on Control Tumor Cells

```{r}
# define some control images without p75+ tumor cells
control_samples <- data.frame(colData(sce_protein)) %>%
  filter(Description %in% control_tumor_images) %>%
  distinct(Description, MM_location)

# find tumor clusters 
sce_protein <- findClusters(sce_protein, 
                            sce_protein[,sce_protein$celltype == "Tumor" & sce_protein$Description %in% control_samples$Description]$cellID, 
                            'cellID', 
                            'Center_X', 'Center_Y', 
                            'ImageNumber', 
                            distance = 30, 
                            min_clust_size = 15,
                            output_colname = "control_Tumor_cluster")

# number of control clusters
length(unique(sce_protein$control_Tumor_cluster))

# define community
sce_protein <- findCommunity(sce_protein, 
                     'cellID', 
                     'Center_X', 'Center_Y', 
                     'ImageNumber', 
                     'control_Tumor_cluster', 
                     distance = 30,
                     output_colname = "control_Tumor_community",
                     plot = FALSE)

# number of chemokine communities
length(unique(sce_protein$control_Tumor_community))
```

## Compare communities from p75+ and control tumors

```{r UMAP}
sce_p75 <- sce_protein[,sce_protein$celltype != "Tumor" & sce_protein$p75_Tumor_community > 0 & sce_protein$p75_Tumor_cluster == 0]

# create UAMP
sce_p75 <- runUMAP(sce_p75, exprs_values = "scaled_asinh", 
                   subset_row = rowData(sce_p75)$good_marker,
                   n_neighbors = 10)

# plot UMAP
a <- dittoDimPlot(sce_p75, 
             reduction.use = "UMAP", 
             var = "celltype", 
             color.panel = metadata(sce_p75)$colour_vector$celltype,
             size = 2,
             legend.show = TRUE,
             main = "Immune cells from p75+ communities",
             opacity = 0.5) + 
  guides(colour = guide_legend(override.aes = list(alpha = 1, size=3)))

# control
sce_control <- sce_protein[,sce_protein$celltype != "Tumor" & sce_protein$control_Tumor_community > 0 & sce_protein$control_Tumor_cluster == 0]

# create UAMP
sce_control <- runUMAP(sce_control, exprs_values = "scaled_asinh", 
                   subset_row = rowData(sce_control)$good_marker,
                   n_neighbors = 10)

# plot UMAP
b <- dittoDimPlot(sce_control, 
             reduction.use = "UMAP", 
             var = "celltype", 
             color.panel = metadata(sce_control)$colour_vector$celltype,
             size = 2,
             legend.show = TRUE,
             main =  "Immune cells from p75- communities",
             opacity = 0.5)


leg <- cowplot::get_legend(a) 

pdf("~/Desktop/community_UMAP.pdf", width = 10, height = 8)
grid.arrange(a + theme(legend.position = "none"), 
             b + theme(legend.position = "none"), 
             leg,
             ncol = 2)
dev.off()
```


```{r celltype_fractions}
ctrl <- data.frame(colData(sce_protein)) %>%
  filter(control_Tumor_community > 0) %>%
  filter(celltype != "Tumor") %>%
  group_by(celltype, Description) %>%
  summarise(n=n()) %>%
  group_by(Description) %>%
  mutate(fraction= n / sum(n))

ctrl$type = "p75- communities"

p75 <- data.frame(colData(sce_protein)) %>%
  filter(p75_Tumor_community > 0) %>%
  filter(Description %in% p75_tumor_images) %>%
  filter(celltype != "Tumor") %>%
  group_by(celltype, Description) %>%
  summarise(n=n()) %>%
  group_by(Description) %>%
  mutate(fraction= n / sum(n))

p75$type <- "p75+ communities"

compare <- rbind(ctrl, p75)

pdf("~/Desktop/community_proportions.pdf", width = 10, height = 8)
ggplot(compare, aes(x=Description, y=fraction, fill=celltype)) + 
  geom_bar(stat = "identity") + 
        scale_fill_manual(values = unname(metadata(sce_protein)$colour_vector$celltype),
                        breaks = names(metadata(sce_protein)$colour_vector$celltype),
                        labels = names(metadata(sce_protein)$colour_vector$celltype)) +
        theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        panel.background = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "grey", size = .3)) +
  ylab("Celltype Proportions") + 
  facet_wrap(~type, scales = "free") 
dev.off()
```

# NeighbouRhood analysis

## Specify the input

```{r}
# Load and prepare
dat_cells = fread(file = "data/protein/cell.csv",stringsAsFactors = FALSE)
dat_relation = fread(file = "data/protein/Object relationships.csv",stringsAsFactors = FALSE)

n_perm = 1000

# Number of cores used for multicore:
ncores=7
```

## Start the analysis

```{r}
# add same cellID to dat_cells as in sce object
dat_cells$cellID <- paste("protein_", paste(dat_cells$ImageNumber, dat_cells$ObjectNumber, sep = "_"), sep = "")

# add p75 status to celltype annotaiton
sce_info <- as.data.frame(colData(sce_protein))[,c("cellID", "celltype", "p75", "Description")]
sce_info <- sce_info %>%
  mutate(celltype = ifelse(p75 == "p75pos_Tumor", paste(celltype, "p75+", sep = "_"), celltype)) %>%
  select(c("cellID", "celltype", "Description"))

# add celltype information
dat_cells <- left_join(dat_cells, sce_info, by = "cellID")

# keep p75+ and control images
dat_cells_sub <- dat_cells[dat_cells$Description %in% c(control_tumor_images, p75_tumor_images), ]
dat_relation_sub <- dat_relation[dat_relation$`First Image Number` %in% dat_cells_sub$ImageNumber,]

#assign labels and groups
dat_cells_sub <- as.data.table(dat_cells_sub)
dat_cells_sub[, label := celltype]
dat_cells_sub[, group := ImageNumber]

# Prepare the data
d = prepare_tables(dat_cells_sub, dat_relation_sub)

# Calculate the baseline statistics
dat_baseline = apply_labels(d[[1]], d[[2]]) %>%
  aggregate_classic()

# Calculate the permutation statistics
# This will run the test using parallel computing. The name of the idcol does actually not matter.

set.seed(12312)
dat_perm = rbindlist(mclapply(1:n_perm, function(x){
  dat_labels = shuffle_labels(d[[1]])
  apply_labels(dat_labels, d[[2]]) %>%
    aggregate_classic()
},mc.cores = ncores
), idcol = 'run') 

dat_p <- calc_p_vals(dat_baseline, dat_perm, n_perm = 1000, p_tresh = 0.01) 
```

## Heatmap per Sample (FirstLabel == Tumor)

```{r}
dat_p$first_second <- paste(dat_p$FirstLabel, dat_p$SecondLabel, sep = "__")

# only keep Tumor cells as FirstLabel
dat_p <- dat_p[dat_p$FirstLabel %in% c("Tumor", "Tumor_p75+")]

pmat = dcast(dat_p, 'group ~ first_second', value.var = 'sigval', fill=0, drop=F)
names(pmat)[1] <- "ImageNumber"

# add Description
pmat <- left_join(data.frame(pmat),distinct(dat_cells_sub[,c("ImageNumber", "Description")], ImageNumber, .keep_all = TRUE))

pmat$class <- ""
pmat[pmat$Description %in% p75_tumor_images,]$class <- "p75+ Tumor"
pmat[pmat$Description %in% control_tumor_images,]$class <- "Control Tumor"

pmat$ImageNumber <- as.character(pmat$ImageNumber)

pmat_num <- pmat %>%
  select_if(is.numeric) %>%
  colnames(.)

m <- t(pmat[,pmat_num])
ha1 <- HeatmapAnnotation("Sample ID" = anno_text(pmat$Description, which = "column", gp = gpar(cex=0.7)))

pdf("~/Desktop/neighboRhood_p75_firstlabel.pdf", width = 8, height = 8)
Heatmap(m = m, name = "+1 Attraction, \n-1 Avoidance",
        row_names_gp = gpar(cex=1),
        top_annotation = ha1,
        cluster_columns = TRUE,
        column_split = pmat$class,
        row_split = sapply(strsplit(rownames(m), "__"), "[", 1))
dev.off()
```

## Heatmap per Sample (SecondLabel == Tumor)

```{r}
# calc p values
dat_p <- calc_p_vals(dat_baseline, dat_perm, n_perm = 1000, p_tresh = 0.01) 

dat_p$first_second <- paste(dat_p$FirstLabel, dat_p$SecondLabel, sep = "__")

# only keep Tumor cells as FirstLabel
dat_p <- dat_p[dat_p$SecondLabel %in% c("Tumor", "Tumor_p75+")]

pmat = dcast(dat_p, 'group ~ first_second', value.var = 'sigval', fill=0, drop=F)
names(pmat)[1] <- "ImageNumber"

# add Description
pmat <- left_join(data.frame(pmat),distinct(dat_cells_sub[,c("ImageNumber", "Description")], ImageNumber, .keep_all = TRUE))

pmat$class <- ""
pmat[pmat$Description %in% p75_tumor_images,]$class <- "p75+ Tumor"
pmat[pmat$Description %in% control_tumor_images,]$class <- "Control Tumor"

pmat$ImageNumber <- as.character(pmat$ImageNumber)

pmat_num <- pmat %>%
  select_if(is.numeric) %>%
  colnames(.)

m <- t(pmat[,pmat_num])
ha1 <- HeatmapAnnotation("Sample ID" = anno_text(pmat$Description, which = "column", gp = gpar(cex=0.7)))

pdf("~/Desktop/neighboRhood_p75_secondlabel.pdf", width = 8, height = 8)
Heatmap(m = m, name = "+1 Attraction, \n-1 Avoidance",
        row_names_gp = gpar(cex=1),
        top_annotation = ha1,
        cluster_columns = TRUE,
        column_split = pmat$class,
        row_split = sapply(strsplit(rownames(m), "__"), "[", 2))
dev.off()
```

## Plot p75 communities

```{r}
example <- findCommunity(sce_protein[,sce_protein$Description %in% "F9"], 
                     'cellID', 
                     'Center_X', 'Center_Y', 
                     'ImageNumber', 
                     'p75_Tumor_cluster', 
                     distance = 30,
                     output_colname = "p75_Tumor_community1",
                     plot = TRUE)
```

```{r}
data.frame(colData(sce_protein)) %>%
  select(Description, T_frac_score_per_ImageNumber, infiltration) %>%
  distinct(Description, .keep_all = T) %>%
  write.csv("~/Desktop/scoring_melanoma_cohort.csv")
```

