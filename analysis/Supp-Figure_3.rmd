---
title: "Supplementary Figure 3"
author: "Tobias Hoch and Daniel Schulz"
date: "2020-10-14"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction
This script generates plots for Supplementary Figure 3.

# Preparations

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Load libraries

```{r load libraries}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(SingleCellExperiment)
library(dplyr)
library(ggplot2)
library(ggbeeswarm)
library(tidyr)
library(scater)
library(dittoSeq)
library(gridExtra)
library(cowplot)
library(data.table)
library(ggpmisc)
library(ggpubr)
library(rstatix)
```

## Load Data

```{r}
# SCE object
sce_rna = readRDS(file = "data/sce_RNA.rds")
sce_prot = readRDS(file = "data/sce_protein.rds")

# meta data
dat_relation = fread(file = "data/protein/Object relationships.csv",stringsAsFactors = FALSE)
dat_relation_rna = fread(file = "data/RNA/Object relationships.csv",stringsAsFactors = FALSE)

targets <- metadata(sce_rna)$chemokines_morethan600_withcontrol
```

# Supp Figure 3A

## Expressor in Tcell groups

```{r Supp_Fig_3A_expressor_cd8_grouping, fig.width=14, fig.height=5, dev=("pdf")}
targets <- metadata(sce_rna)$chemokines_morethan600_withcontrol

frac <- data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  group_by(Description, Tcell_density_score_image, expressor) %>%
  summarise(n=n()) %>%
  mutate(fraction = n / sum(n)) %>%
  filter(expressor %in% targets) %>%
  reshape2::dcast(Description + Tcell_density_score_image ~ expressor, value.var = "fraction", fill = 0) %>%
  reshape2::melt(id.vars = c("Description", "Tcell_density_score_image"), variable.name = "expressor", value.name = "fraction")

ggplot(frac, aes(x=expressor, y = fraction, fill = Tcell_density_score_image)) + 
  geom_boxplot(alpha=.75, outlier.size = 0.5) +
  #geom_jitter(size = 1, alpha=0.7, position = position_jitterdodge(dodge.width = 0.75,jitter.width = 0.05), aes(col=Tcell_density_score_image)) +
  scale_color_discrete(guide = FALSE) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + 
  guides(fill=guide_legend(title="Tcell Score")) +
  xlab("") + 
  ylab("Fractions")  +
  coord_cartesian(ylim = c(0,0.06))
```

# Supp Figure 3B

## Tumor Marker Profile for different Tcell Scoring Groups

```{r Supp_Fig_3B_tumor_profile_tcell, fig.height=8, fig.width=10, dev=c('pdf')}
tumor_marker_protein <- c("bCatenin", "Sox9", "pERK", "p75", "Ki67", "SOX10", "PARP", "S100", "MiTF")
tumor_marker_rna <- c("Mart1", "pRB")

# rna data 
dat_rna <- data.frame(t(assay(sce_rna[tumor_marker_rna, sce_rna$celltype == "Tumor"], "asinh")))
dat_rna$cellID <- rownames(dat_rna)
dat_rna <- left_join(dat_rna, data.frame(colData(sce_rna))[,c("cellID", "Tcell_density_score_image", "Description", "MM_location", "Location")])

# filter
dat_rna <- dat_rna %>%
  filter(Location != "CTRL")

# mean per image
dat_rna <- dat_rna %>%
  select(-cellID) %>%
  group_by(Description, Tcell_density_score_image) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# melt
dat_rna <- dat_rna %>%
  reshape2::melt(id.vars = c("Description", "Tcell_density_score_image"), variable.name = "channel", value.name = "asinh")

# protein data
dat_prot <- data.frame(t(assay(sce_prot[tumor_marker_protein,, sce_prot$celltype == "Tumor"], "asinh")))
dat_prot$cellID <- rownames(dat_prot)
dat_prot <- left_join(dat_prot, data.frame(colData(sce_prot))[,c("cellID", "Tcell_density_score_image", "Description", "MM_location", "Location")])

# filter
dat_prot <- dat_prot %>%
  filter(Location != "CTRL")

# mean per image
dat_prot <- dat_prot %>%
  select(-cellID) %>%
  group_by(Description, Tcell_density_score_image) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# melt
dat_prot <- dat_prot %>%
  reshape2::melt(id.vars = c("Description", "Tcell_density_score_image"), variable.name = "channel", value.name = "asinh")

# join both data sets
comb <- rbind(dat_prot, dat_rna)

# adjusted wilcox.test for groups
group_comparison <- list(c("absent", "high"), c("med", "high"))

stat.test <- comb %>%
  group_by(channel) %>%
  wilcox_test(data = ., asinh ~ Tcell_density_score_image) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance("p.adj") %>%
  add_xy_position(x = "Tcell_density_score_image", dodge = 0.8, comparisons = group_comparison) %>%
  filter(is.na(y.position) == FALSE)

# plot 
p <- ggplot(comb, aes(x=Tcell_density_score_image, y=asinh)) + 
  geom_boxplot(alpha=0.2, lwd=1, aes(fill=Tcell_density_score_image)) +
  geom_quasirandom(alpha=0.6, size=2, aes(col=Tcell_density_score_image)) +
  scale_color_discrete(guide = FALSE) +
  theme_bw() +
  theme(text = element_text(size=18),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank()) +
  facet_wrap(~channel, scales = "free") + 
  stat_pvalue_manual(stat.test, label = "p.adj.signif", size = 7) + 
  xlab("") + 
  ylab("Mean Count per Image (asinh)") +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.1))) +
  guides(fill=guide_legend(title="Tcell Score", override.aes = c(lwd=0.5, alpha=1)))

leg <- get_legend(p)

grid.arrange(p + theme(legend.position = "none"))
```

```{r Supp_Fig_3B_tumor_profile_tcell_legend, fig.height=2, fig.width=2, dev=c('pdf')}
grid.arrange(leg)
```

# Supp Figure 3C

## Prepare Relation Data RNA

```{r}
# prepare data and add cellID
dat_relation_rna$cellID_first <- paste("RNA", paste(dat_relation_rna$`First Image Number`, dat_relation_rna$`First Object Number`, sep = "_"), sep = "_")
dat_relation_rna$cellID_second <- paste("RNA", paste(dat_relation_rna$`Second Image Number`, dat_relation_rna$`Second Object Number`, sep = "_"), sep = "_")

# add celltype status to first and second label
celltype_first <- data.frame(colData(sce_rna))[,c("cellID", "celltype", "celltype_clustered")]
colnames(celltype_first) <- c("cellID_first", "celltype_first", "celltype_clust_first")
celltype_second <- data.frame(colData(sce_rna))[,c("cellID", "celltype", "celltype_clustered")]
colnames(celltype_second) <- c("cellID_second", "celltype_second", "celltype_clust_second")

dat_relation_rna <- left_join(dat_relation_rna, celltype_first, by = "cellID_first")
dat_relation_rna <- left_join(dat_relation_rna, celltype_second, by = "cellID_second")

colnames(dat_relation_rna)[5] <- "FirstImageNumber"
```

## CD8/Tumor Interactions and Chemokine Freqs

```{r Supp_Fig_3C_chemokines_tumor_interaction, dev=("pdf"), fig.width=9, fig.height=8}
# number of interactions tcytotoxic and tumor per image
dat_relation_sub <- dat_relation_rna[dat_relation_rna$celltype_first %in% c("Tcytotoxic") & 
                                   dat_relation_rna$celltype_second == "Tumor"]

# count number of interactions
count <- dat_relation_sub %>%
  group_by(FirstImageNumber) %>%
  summarise(n=n())
names(count)[1] <- "ImageNumber"

# fraction of exhausted cd8 per image
expressor_frac <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, expressor) %>%
  summarise(n=n()) %>%
  mutate(fraction=n/sum(n)) %>%
  filter(expressor %in% targets) %>%
  reshape2::dcast(ImageNumber ~ expressor, value.var = "fraction", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber"), variable.name = "expressor", value.name = "fraction")

# correlation plot
cur_dat <- left_join(expressor_frac, count)
cur_dat[is.na(cur_dat$n),]$n <- 0

ggplot(cur_dat, aes(x=log10(fraction), y=log10(n))) + 
  geom_point(size=2) + 
  geom_smooth(method="lm") +
  stat_poly_eq(formula = y ~ x, 
                aes(label =  ..rr.label..), 
                parse = TRUE, size=5, label.y = 0.01, label.x = 1) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("Chemokine Fraction (log10)") +
  ylab("Number of CD8/Tumor Interactions (log10)") +
  facet_wrap(~expressor)
```
