---
title: "Supplementary Figure 6"
author: "Tobias Hoch and Daniel Schulz"
date: "2021-09-22"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction
This script generates plots for Supplementary Figure 6. 

# Preparations 

## Load libraries

```{r}
library(SingleCellExperiment)
library(gridExtra)
library(grid)
library(ggplot2)
library(dplyr)
library(scater)
library(ggpubr)
library(rstatix)
library(ggrastr)
library(ggridges)
library(ggsci)
library(scater)
library(viridis)
library(RColorBrewer)
library(cowplot)
library(dittoSeq)
library(scales)
library(tidyverse)
```



## CD20 

```{r Supp_Fig_6C_myeloid_Bcells, fig.height=6, fig.width=6, dev=("png")}
cur_sce <- sce_prot[,colData(sce_prot)$celltype %in% c("B cell", "Macrophage", "Neutrophil", "pDC")]

ggcells(cur_sce, aes(x=CD20, y=CD11c), exprs_values = "asinh") + 
  geom_point(alpha=.1) + 
  facet_wrap(~celltype) +
  theme_bw() +
  theme(text = element_text(size=16))

ggcells(cur_sce, aes(x=CD68, y=HLADR), exprs_values = "asinh") + 
  geom_point(alpha=.1) + 
  facet_wrap(~celltype) +
  theme_bw() +
  theme(text = element_text(size=16)) +
  geom_smooth(method = "lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..rr.label.., sep = "~`,`~")),
           size = 3, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left")

ggcells(cur_sce, aes(x=CD11c, y=HLADR), exprs_values = "asinh") + 
  geom_point(alpha=.1) + 
  facet_wrap(~celltype) +
  theme_bw() +
  theme(text = element_text(size=16)) +
  geom_smooth(method = "lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..rr.label.., sep = "~`,`~")),
           size = 3, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left")

ggcells(cur_sce, aes(x=CD11c, y=CD68), exprs_values = "asinh") + 
  geom_point(alpha=.1) + 
  facet_wrap(~celltype) +
  theme_bw() +
  theme(text = element_text(size=16)) +
  geom_smooth(method = "lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..rr.label.., sep = "~`,`~")),
           size = 3, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left")
```

## UMAP B cells vs. myeloid

```{r Supp_Fig_6D_myeloid_Bcells, fig.height=5, fig.width=5, dev=("pdf")}
cur_sce <- runUMAP(cur_sce, exprs_values = "asinh", subset_row = c("CD20", "CD11c", "HLADR", "CD68"))

plotReducedDim(cur_sce, dimred = "UMAP", colour_by = "celltype", point_alpha = .2) 
```

## B cell Score Median Splits

```{r}
noPatches <- sce_prot[,sce_prot$bcell_patch_score %in% c("No B cells", "No B cell Patches")]
patches <- sce_prot[,sce_prot$bcell_patch_score %in% c("Small B cell Patches", "B cell Follicles")]

cellcount_noPatches <- data.frame(colData(noPatches)) %>%
  filter(celltype %in% c("B cell", "BnT cell")) %>%
  group_by(Description, bcell_patch_score) %>%
  summarise(n=n()) %>%
  arrange(n)

im_order <- cellcount_noPatches %>%
  arrange(n) %>%
  pull(Description)

ggplot(cellcount_noPatches, aes(x = factor(Description,levels = im_order),
                                     y = n, fill=bcell_patch_score))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle = 90))

cellcount_Patches <- data.frame(colData(patches)) %>%
  group_by(Description, bcell_patch_score,bcell_patch) %>%
  summarise(n=n()) %>%
  filter(bcell_patch > 0) %>%
  group_by(Description, bcell_patch_score) %>%
  summarise(min_patch_size = max(n)) %>%
  arrange(min_patch_size)

im_order <- cellcount_Patches %>%
  arrange(min_patch_size) %>%
  pull(Description)

ggplot(cellcount_Patches, aes(x = factor(Description,levels = im_order),y = min_patch_size, fill=bcell_patch_score))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle = 90))
```


