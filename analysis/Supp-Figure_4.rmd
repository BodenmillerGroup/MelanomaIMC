---
title: "Supplementary Figure 4"
author: "Tobias Hoch and Daniel Schulz"
date: "2020-11-18"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction
This script generates plots for Supplementary Figure 4.

# Preparations

## Load libraries

First, we will load the libraries needed for this part of the analysis.

```{r, message=FALSE}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(SingleCellExperiment)
library(reshape2)
library(tidyverse)
library(dplyr)
library(data.table) 
library(ggplot2)
library(ComplexHeatmap)
library(rms)
library(ggrepel)
library(ggbeeswarm)
library(circlize)
library(ggpubr)
library(ggridges)
library(gridExtra)
library(rstatix)
```

## Read the data

```{r}
sce_rna = readRDS(file = "data/data_for_analysis/sce_RNA.rds")
sce_prot = readRDS(file = "data/data_for_analysis/sce_protein.rds")
```

# Supp Figure 4A

## Heatmap showing marker expression of celltypes subclusters

```{r Supp_Fig_4A_Scaled_Heatmap_Protein, fig.width=11, fig.height=11, dev=c('pdf')}
# add marker expression to cells
marker_expression <- data.frame(t(assay(sce_prot[rowData(sce_prot)$good_marker,], "asinh")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(sce_prot))[,c("cellID", "celltype_clustered")]
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL

# aggregate the groups
dat_aggr <- dat %>%
  group_by(celltype_clustered) %>%
  summarise_all(funs(mean))

# number of cells per group
dat_sum <- dat %>%
  group_by(celltype_clustered) %>%
  summarise(n=n())

dat_sum <- data.frame(t(dat_sum))

# scale and center expression
dat_aggr[,-c(1)] <- scale(dat_aggr[,-c(1)])

# create matrix
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$celltype_clustered

# top annotation with number of cells
ha <- HeatmapAnnotation("Number of Cells" = anno_barplot(ifelse(as.numeric(dat_sum[2,])>25000, 25100, as.numeric(dat_sum[2,])),
                                                         height = unit(2,"cm"),
                                                         ylim = range(0,25000),
                                                         gp = gpar(fill = ifelse(as.numeric(dat_sum[2,]) > 25000, "white", "black"),
                                                                   col = "white")),
                        "Numbers" = anno_text(round(as.numeric(dat_sum[2,])), 
                                                   which = "column", 
                                                   rot = 90, 
                                                   just = "center", 
                                                   location = 0.5,
                                                   gp = gpar(fontsize=8,col = ifelse(as.numeric(dat_sum[2,]) > 25000, "red", "black"))))

# row_split for markers
rowData(sce_prot)$heatmap_relevance <- ""
rowData(sce_prot[rowData(sce_prot)$good_marker,])$heatmap_relevance <- "lineage"
rowData(sce_prot[grepl("PDL1|CD11b|CD206|PARP|CXCR2|CD11c|pS6|GrzB|IDO1|CD45RA|H3K27me3|TCF7|CD45RO|PD1|pERK|ICOS|Ki67", rownames(sce_prot)),])$heatmap_relevance <- "other"

# plot heatmap
h <- Heatmap(m, name = "Scaled Expression",
             row_split = rowData(sce_prot[rowData(sce_prot)$good_marker,])$heatmap_relevance,
             cluster_columns = FALSE,
             show_column_dend = FALSE,
             column_names_gp = gpar(fontsize=12),
             column_names_rot = 90,
             column_names_centered = TRUE,
             show_column_names = TRUE,
             top_annotation = ha,
             col = colorRamp2(c(-3, 0, 3), c("blue", "white", "red")),
             heatmap_legend_param = list(at = c(-3:3),legend_width = unit(6,"cm"), direction="horizontal"),
             column_names_side = "top",
             height = unit(20, "cm"),
             width = unit(20,"cm"))

draw(h, heatmap_legend_side = "bottom")
```

# Supp Figure 4B

## Tumor Marker Profile for different Dysfunction Scoring Groups per Image

```{r Supp_Fig_4B_tumor_profile_per_image, fig.height=8, fig.width=7, dev=c('pdf')}
tumor_marker_protein <- c("pS6", "bCatenin", "H3K27me3", "HLADR", "Sox9", "pERK", "p75", "PDL1", "Ki67", "SOX10", "PARP")
tumor_marker_rna <- c("B2M")

# rna data 
dat_rna <- data.frame(t(assay(sce_rna[tumor_marker_rna, sce_rna$celltype == "Tumor"], "asinh")))
dat_rna$cellID <- rownames(dat_rna)
dat_rna <- left_join(dat_rna, data.frame(colData(sce_rna))[,c("cellID", "dysfunction_score", "Description", "MM_location")])

# filter
dat_rna <- dat_rna %>%
  filter(dysfunction_score %in% c("high dysfunction", "low dysfunction"))

# mean per image
dat_rna <- dat_rna %>%
  select(-cellID) %>%
  group_by(Description, dysfunction_score) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# melt
dat_rna <- dat_rna %>%
  reshape2::melt(id.vars = c("Description", "dysfunction_score"), variable.name = "channel", value.name = "asinh")

# protein data
dat_prot <- data.frame(t(assay(sce_prot[tumor_marker_protein,, sce_prot$celltype == "Tumor"], "asinh")))
dat_prot$cellID <- rownames(dat_prot)
dat_prot <- left_join(dat_prot, data.frame(colData(sce_prot))[,c("cellID", "dysfunction_score", "Description", "MM_location")])

# filter
dat_prot <- dat_prot %>%
  filter(dysfunction_score %in% c("high dysfunction", "low dysfunction"))

# mean per image
dat_prot <- dat_prot %>%
  select(-cellID) %>%
  group_by(Description, dysfunction_score) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# melt
dat_prot <- dat_prot %>%
  reshape2::melt(id.vars = c("Description", "dysfunction_score"), variable.name = "channel", value.name = "asinh")

# join both data sets
comb <- rbind(dat_prot, dat_rna)

stat.test <- comb %>%
  group_by(channel) %>%
  wilcox_test(data = ., asinh ~ dysfunction_score) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance("p.adj",cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1)) %>%
  add_xy_position(x = "celltype", dodge = 0.8)


# plot 
p <- ggplot(comb, aes(x=dysfunction_score, y=asinh)) + 
  geom_boxplot(alpha=0.2, lwd=1, aes(fill=dysfunction_score)) +
  geom_quasirandom(alpha=0.6, size=2, aes(col=dysfunction_score)) +
  scale_color_discrete(guide = FALSE) +
  theme_bw() +
  theme(text = element_text(size=18),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank()) +
  facet_wrap(~channel, scales = "free", ncol = 3) + 
  stat_pvalue_manual(stat.test, label = "p.adj.signif", size = 7) + 
  xlab("") + 
  ylab("Mean Count per Image (asinh)") +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.2))) +
  guides(fill=guide_legend(title="Dysfunction Score", override.aes = c(lwd=0.5, alpha=1)))

leg <- get_legend(p)

grid.arrange(p + theme(legend.position = "none"))
```

```{r Supp_Fig_4B_tumor_profile_per_image_legend, fig.height=2, fig.width=2, dev=c('pdf')}
grid.arrange(leg)
```

# Supp Figure 4C

## Define S100+ cells

```{r signal_strength_distrubution_S100, eval = F}
y <- c(rep(1:10,16),rep(11,7))

# add the group information to the sce object
sce_rna$groups <- y[colData(sce_rna)$ImageNumber]

# now we use the function written by Nils
plotDist(sce_rna["S100", sce_rna$celltype == "Tumor"], plot_type = "ridges", 
         colour_by = "groups", split_by = "rows", 
         exprs_values = "asinh") +
  geom_vline(xintercept = 3)
```

```{r Supp_Fig_4C_S100_manual, fig.height=5, fig.width=5, dev=c('pdf')}
# manual gating 
sce_rna$S100 <- ifelse(assay(sce_rna["S100",], "asinh") > 3, "positive", "negative")

# fraction of S100 tumor cells per image
s100 <- data.frame(colData(sce_rna)) %>%
  filter(celltype == "Tumor") %>%
  group_by(ImageNumber, dysfunction_score, S100) %>%
  summarise(n=n()) %>%
  mutate(fraction = n/sum(n)) %>%
  filter(is.na(dysfunction_score) == F & S100 == "positive")

s100$dysfunction_score <- factor(s100$dysfunction_score)

stat.test <- s100 %>%
  group_by(S100) %>%
  wilcox_test(data = ., fraction ~ dysfunction_score) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance("p.adj",cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1)) %>%
  add_x_position(dodge = 0.8)

ggplot(s100, aes(x=dysfunction_score, y=fraction)) + 
  geom_boxplot(alpha=0.2, lwd=1.5, aes(fill = dysfunction_score)) + 
  geom_quasirandom(aes(col=dysfunction_score), size=3) +
  stat_pvalue_manual(stat.test, label = "p.adj.signif", size = 7, y.position = 1) + 
  xlab("") + 
  ylab("Fraction of S100+ Tumor Cells") +
  theme_bw() +
  theme(text = element_text(size=16),
        legend.position = "none") +
  ylim(0,1.05)
```

# Supp Figure 4D 

## Heatmap with Community Modules

```{r prepare_heatmap_data}
cur_dt <- data.frame(colData(sce_rna))
clust <- data.frame()

## wide table for communities 
for(i in names(cur_dt[,grepl(glob2rx("*pure"),names(cur_dt))])) {
  cur_dt_sub <- cur_dt[cur_dt[,i] > 0,]
  cur_dt_sub <- cbind(cur_dt_sub[,c(i, "Description")],
                      cur_dt_sub[,grepl(glob2rx("C*L*"),names(cur_dt_sub))])
  
  # count numbers of chemokine-expressing cells per patch
  cur_dt_sub <- cur_dt_sub %>%
    group_by(Description) %>%
    group_by_at(i, .add = TRUE) %>%
    summarise_each(funs(sum))
  
  cur_dt_sub$cluster_type <- i
  
  cur_dt_sub <- cur_dt_sub[,-2]
  
  clust <- rbind(clust, cur_dt_sub)
}

# remove pure clusters with low abundance (CCL22, CCL4, CCL8)
clust <- clust[!(clust$cluster_type %in% c("ccl22_pure", "ccl4_pure", "ccl8_pure")),]

# number of patches by image
clust <- clust %>%
  group_by(Description, cluster_type) %>%
  summarise(n=n()) %>%
  reshape2::dcast(Description ~ cluster_type, value.var = "n", fill = 0)

# add images with 0 clusters and add more information
to_add <- data.frame(colData(sce_rna)) %>%
  distinct(Description, .keep_all = TRUE)

clust <- left_join(to_add[,c("Description", "dysfunction_score", "Tcell_density_score_image")], clust)

# repalce NA with 0 
cur_dt_wide <- clust %>%
  mutate_if(is.numeric,coalesce,0)

# order according to image infiltration score
cur_dt_wide <- cur_dt_wide[order(cur_dt_wide$dysfunction_score),]

# chemokines per image
total_chemokines <- cur_dt %>%
  group_by(Description, chemokine) %>%
  summarise(n=n()) %>%
  group_by(Description) %>%
  mutate(fraction = n/sum(n)) %>%
  filter(chemokine == TRUE)

# is a expressing cell part of a milieu?
cur_dt$in_community <- ifelse(rowSums(cur_dt[,grepl(glob2rx("*pure"),names(cur_dt))]) > 0 & cur_dt$chemokine == TRUE, TRUE, FALSE)

# fraction in_community 1vs.0 per image
fractions <- cur_dt %>%
  filter(chemokine == TRUE) %>%
  group_by(Description, in_community) %>%
  summarise(n=n()) %>%
  group_by(Description) %>%
  mutate(fraction = n / sum(n)) %>%
  reshape2::dcast(Description ~ in_community, value.var = "fraction", fill = 0)

names(fractions)[2:3] <- c("single", "community")
fractions[, 2:3][is.na(fractions[, 2:3])] <- 0

# chemokines per image (regardless of combination, multi-producing cells count more than once)
chemokines <- cbind(cur_dt[,c("Description", "in_community")], cur_dt[,grepl(glob2rx("C*L*"),names(cur_dt))])

# long table - chemokine / in_community info and count (n) per image
chemokines <- reshape2::melt(chemokines, id.vars = c("Description", "in_community"), variable.name = "chemokine", value.name = "n") %>%
  group_by(Description, in_community, chemokine) %>%
  summarise(total = sum(n)) %>%
  reshape2::dcast(Description + chemokine ~ in_community, value.var = "total") %>%
  replace(is.na(.), 0) %>%
  reshape2::melt(id.vars = c("Description", "chemokine"), variable.name = "in_community", value.name = "n")

# combine all information
cur_dt_wide <- left_join(cur_dt_wide, fractions)
cur_dt_wide <- left_join(cur_dt_wide, total_chemokines)
```

## Plot Heatmap

```{r Supp_Fig_4D_heatmap_modules_infiltration, fig.height=8, fig.width=14, dev=c('pdf')}
# remove controls and only keep images with dysfunction score
cur_dt_wide_sub <- cur_dt_wide[cur_dt_wide$Description %in% unique(sce_rna[,sce_rna$Location != "CTRL"]$Description),]
cur_dt_wide_sub <- cur_dt_wide[cur_dt_wide$dysfunction_score %in% c("high dysfunction", "low dysfunction"),]

# define subgroups to split  heatmap
subgroup = cur_dt_wide_sub[,"dysfunction_score"]

# heatmap annotation
row_ha2 = rowAnnotation("Production Mode of\nChemokine-Expressing Cells" = 
                          anno_barplot(cur_dt_wide_sub[,c("single", "community")], 
                                       gp = gpar(fill = c("#F8766D", "#00BFC4")), width = unit(1.5, "cm")),
                        "Fraction of Chemokine- \n Expressing Cells" = 
                          anno_barplot(cur_dt_wide_sub[,"fraction"],
                                       width = unit(1.5, "cm")),
                        annotation_name_rot = 90, gap = unit(3, "mm"),
                        col = list(Relapse = c("no relapse" = "orange", "relapse" = "black", "untreated/lost" = "grey")))

# function for the zoom-in plot
panel_fun_chemokines = function(index, nm) {
    image_number = cur_dt_wide_sub[index,"Description"]
    if(length(unique(image_number)) > 9){
      df = chemokines[chemokines$Description %in% image_number, ]
      g = ggplot(df, aes(x = factor(chemokine), y = log10(n+1), fill=in_community)) + 
        geom_boxplot() + 
        xlab("Chemokine") + 
        ylab("# Cells [log10(n+1)]") +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
              legend.position = "none") +
        ylim(0,3)
      g = grid.grabExpr(print(g))
      pushViewport(viewport())
      grid.rect()
      grid.draw(g)
      popViewport()
    }
}

# create zoom-in 
zoom = anno_zoom(align_to = subgroup, 
                 which = "row", panel_fun = panel_fun_chemokines, 
                 size = unit(6, "cm"), 
                 gap = unit(1, "cm"), 
                 width = unit(10, "cm"))

# heatmap
m <- as.matrix(cur_dt_wide_sub[,grepl(glob2rx("*pure"),names(cur_dt_wide_sub))])
col_names <- c()
for(i in (1:length(colnames(m)))){col_names <- c(col_names,(toupper(str_split(colnames(m), "_")[[i]][1])))}
colnames(m) <- col_names

col_fun = viridis::inferno(max(m)+1)

ht1 = Heatmap(m, 
        col = col_fun,
        left_annotation = row_ha2,
        right_annotation = rowAnnotation(foo = zoom, gap = unit(3,"cm")),
        row_split = subgroup,
        row_title_side = "left",
        border = T,
        row_gap = unit(3, "mm"),
        cluster_rows = T,
        cluster_columns = F,
        cluster_row_slices = F,
        show_heatmap_legend = F,
        show_row_dend = F,
        name = "Detected Patches",
        column_title = "Chemokine Milieu", 
        column_title_side = "bottom",
        column_title_gp = gpar(fontsize=20),
        show_row_names = F,
        width = unit(15,"cm"))

draw(ht1)
```

```{r Supp_Fig_4D_legend, dev=c('pdf'), fig.width=3, fig.height=1}
# manual legends
lgd1 = Legend(labels = c("Stand-alone", "Milieu"), title = "Production Mode", legend_gp = gpar(fill = c("#F8766D", "#00BFC4")))
lgd2 = Legend(col_fun = colorRamp2(c(0:max(m)), colors = col_fun), 
              at = seq(0, max(m)+2, by=5), title = "Detected Milieus", direction = "horizontal", grid_width = unit(2, "cm"))

# Draw Legend
draw(packLegend(lgd2, lgd1, direction = "horizontal"))
```
