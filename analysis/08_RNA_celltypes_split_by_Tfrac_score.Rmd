---
title: "celltypes and chemokine expression split by Tfrac score"
author: "Daniel"
date: "18 08 2020"
output: html_document
---

## here we compare the fractions of cell type clusters and marker expressions for T cell score

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# load packages

```{r load packages, message=FALSE}
sapply(list.files("~/bbvolume/Git/imcRtools/R/", full.names = TRUE), source)
sapply(list.files("~/bbvolume/Git/melanoma_publication/code/helper_functions/", full.names = TRUE), source)
library(LSD)
library(SingleCellExperiment)
library(ggplot2)
library(scater)
library(viridis)
library(igraph)
library(CATALYST)
library(reshape2)
library(cowplot)
library(tidyverse)
```


# load data

```{r load data}
sce = readRDS(file = "../../bbvolume/server_homes/thoch/Git/melanoma_publication/data/sce_RNA.rds")

colour_vector <- readRDS("~/bbvolume/Git/ZTMA256_protein_data/data/colour_vector.rds")

# import T_frac_score and add to sce object
T_frac_score <- readRDS("data/T_frac_score_per_Description")

sce$T_frac_score_per_ImageNumber   <- T_frac_score[sce$Description]

# import also the T cell score per BlockID
T_frac_score <- readRDS("data/T_frac_score_per_BlockID")

sce$T_frac_score_per_BlockID   <- T_frac_score[sce$BlockID]
```


```{r adapt T cell score to numbers, fig.height=10, fig.width=10}

sce[,which(sce$T_frac_score_per_ImageNumber == "low" & sce$Location != "CTRL")]$T_frac_score_per_ImageNumber <- 0
sce[,which(sce$T_frac_score_per_ImageNumber == "med" & sce$Location != "CTRL")]$T_frac_score_per_ImageNumber <- 1
sce[,which(sce$T_frac_score_per_ImageNumber == "high" & sce$Location != "CTRL")]$T_frac_score_per_ImageNumber <- 2

  # subset sce to not contain CTRL samples
sce <- sce[,sce$Location != "CTRL"]
```



## celltypes per T_frac score
the fraction score defined on the protein dataset does also nicely split up the RNA data

```{r celltype fractions per T_frac_score_per_ImageNumber, fig.height=12, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",scale = "percent")+theme(legend.position = "none")

p3 <- plotCellFracGroups(sce,CellClass = "celltype",color_by = "T_frac_score_per_ImageNumber")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

__essentially no plasma cells (CD38+) in images with no cytotoxic T cells__


## Tcytotoxic cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r Tcytotoxic cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_col = "celltype",celltype_subset ="Tcytotoxic", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_col = "celltype",celltype_subset ="Tcytotoxic", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",color_by = "T_frac_score_per_ImageNumber",celltype_subset = "Tcytotoxic",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

## Tcell cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r Tcell cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_col = "celltype",celltype_subset ="Tcell", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_col = "celltype",celltype_subset ="Tcell", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",color_by = "T_frac_score_per_ImageNumber",celltype_subset = "Tcell",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

__this plot changed from the previous version. way less CD38 positive cells as producers.__

## Macrophage cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r Macrophage cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_col = "celltype",celltype_subset ="Macrophage", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_col = "celltype",celltype_subset ="Macrophage", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",color_by = "T_frac_score_per_ImageNumber",celltype_subset = "Macrophage",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

## Tumor cluster fractions and marker profile for T_frac_score_per_ImageNumber

```{r Tumor cluster fractions for T_frac_score_per_ImageNumber, fig.height=15, fig.width=20, message=FALSE}
p1 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_col = "celltype",celltype_subset ="Tumor", celltype_cluster_col="celltype_clustered",scale = "count")
p2 <- plotBarFracCluster(sce,colour_by = "celltype",split_by = "T_frac_score_per_ImageNumber",celltype_col = "celltype",celltype_subset ="Tumor", celltype_cluster_col="celltype_clustered",scale = "percent")+theme(legend.position = "none")
p3 <- plotCellFracGroupsSubset(sce,CellClass = "celltype",color_by = "T_frac_score_per_ImageNumber",celltype_subset = "Tumor",cluster_col = "celltype_clustered")

bottom_row <- plot_grid(p1, p2, ncol = 2, rel_widths = c(1,1))
plot_grid(p3,bottom_row, ncol = 1, rel_heights = c(2,1))
```

