---
title: "Distance analysis"
author: "Nils Eling"
date: "10/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here, we will observe the distance of each celltype to chemokine expressing cells.

## Read data

First, we will read in the data.

```{r read-data, message = FALSE}
library(BiocParallel)
library(tidyverse)
library(SingleCellExperiment)
sce <- readRDS("~/Desktop/REDSEA_test/sce_RNA.rds")
```

## Define distance function

Next, we will build a helper function to compute the minimum distance of each cell
to a pattern of interest. Here, the diagonal will be ignored.

```{r min-distance-function}
min_dist <- function(x, pattern, img_id, coords, BPPARAM = MulticoreParam()){
    
    cur_out <- bplapply(unique(x[[img_id]]), function(y){
        cur_sce <- x[,x[[img_id]] == y]
        cur_pattern <- pattern[x[[img_id]] == y]
        
        if (sum(cur_pattern) == 0) {
            cur_vec <- rep(NA, length(cur_pattern))
        } else {
            cur_dist <- as.matrix(dist(colData(cur_sce)[,coords]))
            diag(cur_dist) <- NA
            
            cur_vec <- apply(cur_dist[,cur_pattern,drop=FALSE], 1, min, na.rm = TRUE)
        }
        names(cur_vec) <- colnames(cur_sce)
        
        return(cur_vec)
    }, BPPARAM = BPPARAM)
    
    cur_out <- do.call(c, cur_out)
    cur_out[is.infinite(cur_out)] <- NA
    
    return(cur_out[colnames(x)])
}

```

## Apply function

```{r apply-function}
chemokine_list <- c("CCL4", "CCL18", "CXCL8", "CXCL10", "CXCL12", "CXCL13", "CCL2", 
                    "CCL22", "CXCL9", "CCL8", "CCL19")

cur_dist <- list()
for (i in chemokine_list) {
        cur_dist[[i]] <- min_dist(sce, sce[[i]] == 1, "ImageNumber", 
                                  coords = c("Center_X", "Center_Y")) 
}
```

## Visualize results

Now, we will visualize the distance distributions for each celltype and each
chemokine.

### By chemokine

```{r viz, message=FALSE, fig.height=25, fig.width=7}
library(ggridges)
library(cowplot)
library(ggplot2)
p_list <- list()

for (i in names(cur_dist)) {
    cur_df <- data.frame(celltype = sce$celltype,
                         dist = cur_dist[[i]])
    
    p_list[[i]] <- ggplot(cur_df) + geom_density_ridges(aes(x = dist, y = celltype, 
                                                    fill = celltype)) + ggtitle(i)
}

p <- plot_grid(plotlist = p_list, ncol = 2)
p
ggsave(filename = "~/Desktop/distance.pdf", p, width = 15, height = 20)
```

### By celltype

```{r viz-celltype}
cur_dist_celltype <- vector(mode = "list", length = length(unique(sce$celltype)))
names(cur_dist_celltype) <- unique(sce$celltype)

for (i in names(cur_dist)) {
    for (j in names(cur_dist_celltype)) {
        cur_dist_celltype[[j]] <- rbind(cur_dist_celltype[[j]], 
                                        data.frame(dist = cur_dist[[i]][sce$celltype == j],
                                                   chemokine = i))
    }
}

p_list <- lapply(names(cur_dist_celltype), function(x){
    ggplot(cur_dist_celltype[[x]]) + geom_density_ridges(aes(x = dist, y = chemokine, 
                                                    fill = chemokine)) + ggtitle(x)
})

p <- plot_grid(plotlist = p_list, ncol = 2)
p
ggsave(filename = "~/Desktop/distance_celltype.pdf", p, width = 15, height = 20)
```

## Normalized by number of cells

Here, we will plot the mean cell-type to chemokine distance per image against 
the fractyion of cell-type A and the chemokine expressing cells out of all cells.

```{r calculate-density-per-image}
cur_frac_cells <- list()

for (i in chemokine_list) {
    for (j in unique(sce$celltype)) {
        cur_df <- colData(sce) %>% as_tibble() %>%
            group_by(ImageNumber) %>%
            summarize(count = n(),
                      frac_total = sum(!!sym(i) == 1 | celltype == j)/count,
                      frac_chemokine = sum(!!sym(i) == 1)/count,
                      frac_celltype = sum(celltype == j)/count)
        
        cur_frac_cells[[paste0(i, "_", j)]] <- cur_df
    }
}
```

Now we add the mean minimum distance per image and cell-type/chemokine combination.

```{r add-mean-distance}
cur_frac_cells <- lapply(names(cur_frac_cells),
                         function(x){
                             cur_out <- cur_frac_cells[[x]]
                             cur_d <- cur_dist[[strsplit(x, "_")[[1]][1]]]
                             cur_df <- cbind(colData(sce), cur_d)
                             cur_df <- cur_df %>% as_tibble() %>%
                                 filter(celltype == strsplit(x, "_")[[1]][2]) %>%
                                 group_by(ImageNumber) %>%
                                 summarize(mean_dist = mean(cur_d)) %>%
                                 as.data.frame()
                             rownames(cur_df) <- as.character(cur_df$ImageNumber)
                             cur_out$mean_dist <- cur_df[as.character(cur_out$ImageNumber),"mean_dist"]
                             
                             cur_out$chemokine <- strsplit(x, "_")[[1]][1]
                             cur_out$celltype <- strsplit(x, "_")[[1]][2]
                             
                             return(cur_out)
                         })

cur_frac_cells <- do.call("rbind", cur_frac_cells)
```

Visualize data and fit loess regression per chemokine.

```{r visualize-data}
library(rgl)
library(broom)

loess_list <- list()

for (i in chemokine_list) {
    cur_dat <- cur_frac_cells[cur_frac_cells$chemokine == i,]
    cur_loess <- loess(mean_dist ~ frac_celltype + frac_chemokine, 
                       data = cur_dat)
    cur_out <- augment(cur_loess)
    cur_out$scaled_residuals <- scale(cur_out$.resid, scale = FALSE)
    
    cur_out$ImageNumber <- cur_dat$ImageNumber[as.numeric(cur_out$.rownames)]
    cur_out$chemokine <- cur_dat$chemokine[as.numeric(cur_out$.rownames)]
    cur_out$celltype <- cur_dat$celltype[as.numeric(cur_out$.rownames)]
    
    loess_list[[i]] <- cur_out
}

plot3d(loess_list$CCL4$frac_celltype, loess_list$CCL4$frac_chemokine, 
       loess_list$CCL4$.fitted)
```

Compute mean residual across all images per celltype/chemokine combination.

```{r mean-residuals}
cur_dat <- do.call("rbind", loess_list)

cur_dat %>% group_by(celltype, chemokine) %>%
    summarize(mean_residual = mean(scaled_residuals)) %>%
    ggplot() + geom_tile(aes(celltype, chemokine, fill = mean_residual)) +
    scale_fill_gradient2(low = "dark blue", mid = "white", high = "dark red")
```

