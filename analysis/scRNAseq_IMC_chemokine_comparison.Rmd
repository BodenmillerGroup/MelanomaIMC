---
title: "scRNA chemokine validation"
output: html_document
---

In this script we will sequentially load all melanoma datasets from http://tisch.comp-genomics.org/

we will then calculate the proportions of each cell type expressing individual chemokines. under the hypothesis that the scRNAseq data is the ground truth. We will then compare these proportions to the observed proportions in IMC and thereby estimate whether we likely observe spatial spill over in IMC.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
set.seed(12345)

library(Seurat)
library(hdf5r)
library(SingleCellExperiment)
library(scater)
library(dittoSeq)
library(scran)
library(ComplexHeatmap)
library(data.table)
library(dplyr)
library(tidyr)
library(cowplot)
```

## SKCM_GSE123139 - Li et al., 2019

```{r}
dat <- Seurat::Read10X_h5("../Downloads/SKCM_GSE123139_expression.h5")

dim(dat)
max(rowSums(dat))

seurat<-CreateSeuratObject(counts = dat, project = "Mel_GSE123139")
sce <- as.SingleCellExperiment(seurat)
head(colnames(sce))

metadata <- read.delim("../Downloads/SKCM_GSE123139_CellMetainfo_table.tsv")
colnames(metadata)
# add the metadata to the sce object
colData(sce) <- cbind(colData(sce),metadata)

sce$UMAP_1 <- NULL
sce$UMAP_2 <- NULL

UMAP_dat <- metadata[,c("UMAP_1","UMAP_2")]
rownames(UMAP_dat) <- metadata$Cell

reducedDim(sce, "UMAP",) <- UMAP_dat
```

```{r}
col_vec <- c("springgreen3","deeppink2","deepskyblue","palegreen","tomato","yellow3","darkgreen","darkblue")
names(col_vec) <- unique(sce$Celltype..major.lineage.)

pie(rep(1,length(col_vec)),col = col_vec,labels = names(col_vec))
```

```{r}
# find cells with chemokines expression > 1
targets <- rownames(sce)[grepl("CCL2$|CCL4$|CCL8|CCL18|CCL19|CCL22|CXCL8|CXCL9|CXCL10|CXCL12|CXCL13",rownames(sce))]

for (i in targets) {
  colData(sce)[i] <- ifelse(t(counts(sce))[,i]>1,yes = 1,no = 0)
}

chem_dat <- as.data.table(colData(sce))
chem_dat$CellID <- sapply(chem_dat$Cell,FUN = function(x){strsplit(x,"_")[[1]][1]})

chemokines <- chem_dat[,c("Celltype..major.lineage.", "CellID",..targets)]
chemokines$celltype <- chemokines$Celltype..major.lineage.
chemokines$Celltype..major.lineage. <- NULL

# here we calculate the total number of chemokine expressing cells and then the number per celltype. we then caculate the fraction of each celltype expressing a given chemokine of all of the chemokine positive cells of that type
GSE123139 <- chemokines %>%
  pivot_longer(cols = targets) %>%
  group_by(name,.drop = FALSE) %>%
  mutate(chem_count = sum(value)) %>%
  ungroup() %>%
  group_by(celltype,name) %>%
  mutate(celltype_sum = sum(value)) %>%
  select(celltype,name,chem_count,celltype_sum) %>%
  distinct() %>%
  mutate(frac = celltype_sum/chem_count)%>%
  ungroup()

GSE123139$dataset <- "GSE123139"
GSE123139$author <- "Li et al., 2019"
GSE123139$sorting <- "immune"

p1 <- GSE123139 %>%
  ggplot(aes(x=celltype,y=frac))+
  geom_boxplot()+
  facet_wrap(.~name)+
  theme(axis.text.x = element_text(angle = 90))

p2 <- GSE123139 %>%
  select(chem_count,name) %>%
  distinct() %>%
  ggplot(aes(x=name,y=chem_count))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90))
plot_grid(p1,p2,rel_widths = c(2,1))
```



## SKCM_GSE115978 - Jerby-Arnon et al., 2018

```{r}
dat <- Seurat::Read10X_h5("../Downloads/SKCM_GSE115978_aPD1_expression.h5")

dim(dat)
max(rowSums(dat))

seurat<-CreateSeuratObject(counts = dat, project = "SKCM_GSE115978")
sce <- as.SingleCellExperiment(seurat)
head(colnames(sce))

metadata <- read.delim("../Downloads/SKCM_GSE115978_aPD1_CellMetainfo_table.tsv")
colnames(metadata)
# add the metadata to the sce object
colData(sce) <- cbind(colData(sce),metadata)

sce$UMAP_1 <- NULL
sce$UMAP_2 <- NULL

UMAP_dat <- metadata[,c("UMAP_1","UMAP_2")]
rownames(UMAP_dat) <- metadata$Cell

reducedDim(sce, "UMAP",) <- UMAP_dat

# find cells with chemokines expression > 1
targets <- rownames(sce)[grepl("CCL2$|CCL4$|CCL8|CCL18|CCL19|CCL22|CXCL8|CXCL9|CXCL10|CXCL12|CXCL13",rownames(sce))]

for (i in targets) {
  colData(sce)[i] <- ifelse(t(counts(sce))[,i]>1,yes = 1,no = 0)
}

chem_dat <- as.data.table(colData(sce))
chem_dat$CellID <- sapply(chem_dat$Cell,FUN = function(x){strsplit(x,"_")[[1]][1]})

chemokines <- chem_dat[,c("Celltype..major.lineage.", "CellID",..targets)]
chemokines$celltype <- chemokines$Celltype..major.lineage.
chemokines$Celltype..major.lineage. <- NULL

# here we calculate the total number of chemokine expressing cells and then the number per celltype. we then caculate the fraction of each celltype expressing a given chemokine of all of the chemokine positive cells of that type
GSE115978 <- chemokines %>%
  pivot_longer(cols = targets) %>%
  group_by(name,.drop = FALSE) %>%
  mutate(chem_count = sum(value)) %>%
  ungroup() %>%
  group_by(celltype,name) %>%
  mutate(celltype_sum = sum(value)) %>%
  select(celltype,name,chem_count,celltype_sum) %>%
  distinct() %>%
  mutate(frac = celltype_sum/chem_count)%>%
  ungroup()

GSE115978$dataset <- "GSE115978"
GSE115978$author <- "Jerby-Arnon et al., 2018"
GSE115978$sorting <- "all"

p1 <- GSE115978 %>%
  ggplot(aes(x=celltype,y=frac))+
  geom_boxplot()+
  facet_wrap(.~name)+
  theme(axis.text.x = element_text(angle = 90))

p2 <- GSE115978 %>%
  select(chem_count,name) %>%
  distinct() %>%
  ggplot(aes(x=name,y=chem_count))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90))
plot_grid(p1,p2,rel_widths = c(2,1))
```

## SKCM_GSE120575 - Sade-Feldman et al

```{r}
dat <- Seurat::Read10X_h5("../Downloads/SKCM_GSE120575_aPD1aCTLA4_expression.h5")

dim(dat)
max(rowSums(dat))

seurat<-CreateSeuratObject(counts = dat, project = "SKCM_GSE120575")
sce <- as.SingleCellExperiment(seurat)
head(colnames(sce))

metadata <- read.delim("../Downloads/SKCM_GSE120575_aPD1aCTLA4_CellMetainfo_table.tsv")
colnames(metadata)
# add the metadata to the sce object
colData(sce) <- cbind(colData(sce),metadata)

sce$UMAP_1 <- NULL
sce$UMAP_2 <- NULL

UMAP_dat <- metadata[,c("UMAP_1","UMAP_2")]
rownames(UMAP_dat) <- metadata$Cell

reducedDim(sce, "UMAP",) <- UMAP_dat

targets <- rownames(sce)[grepl("CCL2$|CCL4$|CCL8|CCL18|CCL19|CCL22|CXCL8|CXCL9|CXCL10|CXCL12|CXCL13",rownames(sce))]

# find cells with chemokines expression > 1
for (i in targets) {
  colData(sce)[i] <- ifelse(t(counts(sce))[,i]>1,yes = 1,no = 0)
}

chem_dat <- as.data.table(colData(sce))
chem_dat$CellID <- sapply(chem_dat$Cell,FUN = function(x){strsplit(x,"_")[[1]][1]})

chemokines <- chem_dat[,c("Celltype..major.lineage.", "CellID",..targets)]
chemokines$celltype <- chemokines$Celltype..major.lineage.
chemokines$Celltype..major.lineage. <- NULL

# here we calculate the total number of chemokine expressing cells and then the number per celltype. we then caculate the fraction of each celltype expressing a given chemokine of all of the chemokine positive cells of that type
GSE120575 <- chemokines %>%
  pivot_longer(cols = targets) %>%
  group_by(name,.drop = FALSE) %>%
  mutate(chem_count = sum(value)) %>%
  ungroup() %>%
  group_by(celltype,name) %>%
  mutate(celltype_sum = sum(value)) %>%
  select(celltype,name,chem_count,celltype_sum) %>%
  distinct() %>%
  mutate(frac = celltype_sum/chem_count) %>%
  ungroup()

GSE120575$dataset <- "GSE120575"
GSE120575$author <- "Sade-Feldman et al., 2018"
GSE120575$sorting <- "immune"

p1 <- GSE120575 %>%
  ggplot(aes(x=celltype,y=frac))+
  geom_boxplot()+
  facet_wrap(.~name)+
  theme(axis.text.x = element_text(angle = 90))

p2 <- GSE120575 %>%
  select(chem_count,name) %>%
  distinct() %>%
  ggplot(aes(x=name,y=chem_count))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90))
plot_grid(p1,p2,rel_widths = c(2,1))
```

## SKCM_GSE148190 - Mahuron KM et al 2019

```{r}
dat <- Seurat::Read10X_h5("../Downloads/SKCM_GSE148190_expression.h5")

dim(dat)
max(rowSums(dat))

seurat<-CreateSeuratObject(counts = dat, project = "SKCM_GSE148190")
sce <- as.SingleCellExperiment(seurat)
head(colnames(sce))

metadata <- read.delim("../Downloads/SKCM_GSE148190_CellMetainfo_table.tsv")
colnames(metadata)
# add the metadata to the sce object
colData(sce) <- cbind(colData(sce),metadata)

sce$UMAP_1 <- NULL
sce$UMAP_2 <- NULL

UMAP_dat <- metadata[,c("UMAP_1","UMAP_2")]
rownames(UMAP_dat) <- metadata$Cell

reducedDim(sce, "UMAP",) <- UMAP_dat

targets <- rownames(sce)[grepl("CCL2$|CCL4$|CCL8|CCL18|CCL19|CCL22|CXCL8|CXCL9|CXCL10|CXCL12|CXCL13",rownames(sce))]

# find cells with chemokines expression > 1
for (i in targets) {
  colData(sce)[i] <- ifelse(t(counts(sce))[,i]>1,yes = 1,no = 0)
}

chem_dat <- as.data.table(colData(sce))
chem_dat$CellID <- sapply(chem_dat$Cell,FUN = function(x){strsplit(x,"_")[[1]][1]})

chemokines <- chem_dat[,c("Celltype..major.lineage.", "CellID",..targets)]
chemokines$celltype <- chemokines$Celltype..major.lineage.
chemokines$Celltype..major.lineage. <- NULL

# here we calculate the total number of chemokine expressing cells and then the number per celltype. we then caculate the fraction of each celltype expressing a given chemokine of all of the chemokine positive cells of that type
GSE148190 <- chemokines %>%
  pivot_longer(cols = targets) %>%
  group_by(name,.drop = FALSE) %>%
  mutate(chem_count = sum(value)) %>%
  ungroup() %>%
  group_by(celltype,name) %>%
  mutate(celltype_sum = sum(value)) %>%
  select(celltype,name,chem_count,celltype_sum) %>%
  distinct() %>%
  mutate(frac = celltype_sum/chem_count) %>%
  ungroup()

GSE148190$dataset <- "GSE148190"
GSE148190$author <- "Mahuron et al., 2020"
GSE148190$sorting <- "immune"

p1 <- GSE148190 %>%
  ggplot(aes(x=celltype,y=frac))+
  geom_boxplot()+
  facet_wrap(.~name)+
  theme(axis.text.x = element_text(angle = 90))

p2 <- GSE148190 %>%
  select(chem_count,name) %>%
  distinct() %>%
  ggplot(aes(x=name,y=chem_count))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90))
plot_grid(p1,p2,rel_widths = c(2,1))
```

## SKCM_GSE72056 - Tirosh et al., 2016

```{r}
dat <- Seurat::Read10X_h5("../Downloads/SKCM_GSE72056_expression.h5")

dim(dat)
max(rowSums(dat))

seurat<-CreateSeuratObject(counts = dat, project = "SKCM_GSE72056")
sce <- as.SingleCellExperiment(seurat)
head(colnames(sce))

metadata <- read.delim("../Downloads/SKCM_GSE72056_CellMetainfo_table.tsv")
colnames(metadata)
# add the metadata to the sce object
colData(sce) <- cbind(colData(sce),metadata)

sce$UMAP_1 <- NULL
sce$UMAP_2 <- NULL

UMAP_dat <- metadata[,c("UMAP_1","UMAP_2")]
rownames(UMAP_dat) <- metadata$Cell

reducedDim(sce, "UMAP",) <- UMAP_dat

targets <- rownames(sce)[grepl("CCL2$|CCL4$|CCL8|CCL18|CCL19|CCL22|CXCL8|CXCL9|CXCL10|CXCL12|CXCL13",rownames(sce))]

# find cells with chemokines expression > 1
for (i in targets) {
  colData(sce)[i] <- ifelse(t(counts(sce))[,i]>1,yes = 1,no = 0)
}

chem_dat <- as.data.table(colData(sce))
chem_dat$CellID <- sapply(chem_dat$Cell,FUN = function(x){strsplit(x,"_")[[1]][1]})

chemokines <- chem_dat[,c("Celltype..major.lineage.", "CellID",..targets)]
chemokines$celltype <- chemokines$Celltype..major.lineage.
chemokines$Celltype..major.lineage. <- NULL

# here we calculate the total number of chemokine expressing cells and then the number per celltype. we then caculate the fraction of each celltype expressing a given chemokine of all of the chemokine positive cells of that type
GSE72056 <- chemokines %>%
  pivot_longer(cols = targets) %>%
  group_by(name,.drop = FALSE) %>%
  mutate(chem_count = sum(value)) %>%
  ungroup() %>%
  group_by(celltype,name) %>%
  mutate(celltype_sum = sum(value)) %>%
  select(celltype,name,chem_count,celltype_sum) %>%
  distinct() %>%
  mutate(frac = celltype_sum/chem_count) %>%
  ungroup()

GSE72056$dataset <- "GSE72056"
GSE72056$author <- "Tirosh et al., 2016"
GSE72056$sorting <- "all"

p1 <- GSE72056 %>%
  ggplot(aes(x=celltype,y=frac))+
  geom_boxplot()+
  facet_wrap(.~name)+
  theme(axis.text.x = element_text(angle = 90))

p2 <- GSE72056 %>%
  select(chem_count,name) %>%
  distinct() %>%
  ggplot(aes(x=name,y=chem_count))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90))
plot_grid(p1,p2,rel_widths = c(2,1))
```

## IMC data

```{r}
sce_rna <- readRDS(file = "/media/dan/Data/data_for_analysis/sce_RNA.rds")

cur_dat <- as_tibble(colData(sce_rna))

cur_dat <- cur_dat %>%
  select(celltype,cellID, CCL2,CCL4,CCL8,CCL18,CCL19,CCL22,CXCL8,CXCL9,CXCL10,CXCL12,CXCL13)

cur_long <- cur_dat %>%
  pivot_longer(cols = c(CCL2,CCL4,CCL8,CCL18,CCL19,CCL22,CXCL8,CXCL9,CXCL10,CXCL12,CXCL13))

cur_long <- cur_long %>%
  group_by(name,.drop = FALSE) %>%
  mutate(chem_count = sum(value)) %>%
  ungroup() %>%
  group_by(celltype,name,.drop = FALSE) %>%
  mutate(count=sum(value)) %>%
  select(celltype,count,name,chem_count) %>%
  distinct() %>%
  mutate(frac = count/chem_count)%>%
  ungroup()

p1 <- cur_long %>%
  ggplot(aes(x=celltype,y=frac))+
  geom_boxplot()+
  facet_wrap(.~name)+
  theme(axis.text.x = element_text(angle = 90))

p2 <- cur_long %>%
  select(chem_count,name) %>%
  distinct() %>%
  ggplot(aes(x=name,y=chem_count))+
  geom_bar(stat = "identity")+
  theme(axis.text.x = element_text(angle = 90))
plot_grid(p1,p2,rel_widths = c(2,1))
```

## merge scRNA-seq and IMC data

we will also unify the cell type names wherever possible

```{r, fig.height=10,fig.width=10}
GSE115978
sc_dat <- rbind(GSE115978,GSE120575,GSE123139,GSE148190,GSE72056)
sc_dat %>%
  ggplot(aes(x=celltype,y=frac))+
  geom_boxplot()+
  geom_jitter(position = position_dodge(width = 1))+
  facet_wrap(.~name)+
  theme(axis.text.x = element_text(angle = 90))

sc_dat[which(sc_dat$celltype == "B"),]$celltype <- "HLA-DR"
sc_dat[which(sc_dat$celltype == "CD4Tconv"),]$celltype <- "CD8- T cell"
sc_dat[which(sc_dat$celltype == "CD8Tex"),]$celltype <- "CD8+ T cell"
sc_dat[which(sc_dat$celltype == "Endothelial"),]$celltype <- "Vasculature"
sc_dat[which(sc_dat$celltype == "Fibroblasts"),]$celltype <- "Stroma"
sc_dat[which(sc_dat$celltype == "Malignant"),]$celltype <- "Tumor"
sc_dat[which(sc_dat$celltype == "Mono/Macro"),]$celltype <- "Macrophage"
sc_dat[which(sc_dat$celltype == "CD8T"),]$celltype <- "CD8+ T cell"
sc_dat[which(sc_dat$celltype == "Plasma"),]$celltype <- "CD38"

matched_celltypes <- unique(sc_dat$celltype)[which(unique(sc_dat$celltype) %in% unique(cur_long$celltype))]

plot_dat <- sc_dat %>%
  filter(celltype %in% matched_celltypes)

# order IMC data correct for merging 
colnames(cur_long) <- c("celltype","celltype_sum","name","chem_count","frac")
cur_long <- cur_long[,c("celltype","name","chem_count","celltype_sum","frac")]
#cur_long[which(cur_long$celltype == "Tumor"),]$celltype <- "Mal"
cur_long$dataset <- "IMC"
cur_long$author <- "IMC"
cur_long$sorting <- "all"

all_dat <- rbind(plot_dat,cur_long)
all_dat$datatype <- "scRNAseq"
all_dat[which(all_dat$dataset == "IMC"),]$datatype <- "IMC"

ggplot()+
  geom_boxplot(data = plot_dat,aes(x=celltype,y=frac))+
  geom_point(data = plot_dat,aes(x=celltype,y=frac),color="black")+
  geom_point(data = cur_long,aes(x=celltype,y=frac),color="red")+
  facet_wrap(.~name)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```
## Grubbs test for outlier detection

```{r}
library(outliers)

test_dat <- all_dat %>%
  group_by(name, celltype) %>%
  nest() %>%         
  mutate(n = map_dbl(data, ~ nrow(.x)), # number of entries
         G = map(data, ~ grubbs.test(.x$frac)$statistic[[1]]), # G statistic
         U = map(data, ~ grubbs.test(.x$frac)$statistic[[2]]), # U statistic
         grubbs = map(data, ~ grubbs.test(.x$frac)$alternative), # Alternative hypotesis
         p_grubbs = map_dbl(data, ~ grubbs.test(.x$frac)$p.value)) %>% # p-value
  mutate(G = signif(unlist(G), 3),
         U = signif(unlist(U), 3),
         grubbs = unlist(grubbs),
         p_grubbs = signif(p_grubbs, 3)) %>%
  select(-data) %>%
  arrange(p_grubbs)

# merge the test_dat data with the IMC data
test_dat <- left_join(test_dat,cur_long[,c("celltype","name","frac")],by=c("celltype","name"))

# define whether a detected outlier is an IMC datapoint and apply 0.05 significant value cut-off
sig_dat <- test_dat %>%
  mutate(value = gsub("[^0-9.]", "",  grubbs),
         is_IMC = value == frac,
         sig = p_grubbs <= 0.05) %>%
  filter(sig == TRUE,is_IMC == TRUE)


```
## add significance to plot

```{r, fig.height=15,fig.width=15}
library(ggpubr)

ggplot()+
  geom_boxplot(data = plot_dat,aes(x=celltype,y=frac))+
  geom_point(data = plot_dat,aes(x=celltype,y=frac),color="black")+
  geom_point(data = cur_long,aes(x=celltype,y=frac),color="red")+
  geom_label(data = sig_dat,aes(x=celltype,y=0.95,label = p_grubbs), color= "red") +
  facet_wrap(.~name)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

