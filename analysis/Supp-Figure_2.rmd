---
title: "Supplementary Figure 2"
author: "Tobias Hoch and Daniel Schulz"
date: "2020-10-13"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction
This script generates plots for Supplementary Figure 2. Panel B was created manually. 

# Preparations

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Load libraries

```{r load libraries}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(data.table)
library(survival)
library(ggplot2)
library(broom)
library(dplyr)
library(RColorBrewer)
library(ggalluvial)
library(tidyverse)
library(cowplot)
library(ggbeeswarm)
library(gridExtra)
library(SingleCellExperiment)
library(scater)
library(cba)
library(ComplexHeatmap)
library(reshape2)
library(rms)
library(ggrepel)
library(circlize)
library(coxme)
library(rstatix)
library(corrplot)
library(ggpubr)
```

## Load Data

```{r}
# clinical data
dat <- read_csv("data/data_for_analysis/protein/clinical_data_protein.csv")

# SCE object
sce_prot = readRDS(file = "data/data_for_analysis/sce_protein.rds")
sce_rna = readRDS(file = "data/data_for_analysis/sce_RNA.rds")

clincial = read.csv(file = "data/data_for_analysis/protein/clinical_data_protein.csv")

targets <- metadata(sce_rna)$chemokines_morethan600_withcontrol
```

# Supp Figure 2A

## Fraction of Tumor Cells that express chemokines

```{r Supp_Fig_2A_tumor_cells_chemokine, dev=("pdf"), fig.width=9, fig.height=5}
cur_dat <- data.frame(colData(sce_rna))
cur_dat <- cur_dat %>%
  filter(celltype == "Tumor") %>%
  filter(Location != "CTRL")

cur_dat <- cur_dat[,c("ImageNumber", "Mutation", colnames(cur_dat)[grepl(glob2rx("C*L*"),names(cur_dat))])]

# colSums of Chemokines in Tumor Cells (Multiple Producer count more than once)
cur_dat <- cur_dat %>%
  group_by(ImageNumber, Mutation) %>%
  mutate(cells = n()) %>%
  group_by(ImageNumber, cells, Mutation) %>%
  summarise_each(funs(sum))

# compute fractions
cur_dat[,4:14] <- cur_dat[,4:14] / t(cur_dat$cells)

cur_dat <- cur_dat %>%
  filter(cells > 200) %>%
  reshape2::melt(id.vars=c("ImageNumber", "cells", "Mutation"), variable.name="chemokine", value.name="fraction")

ggplot(cur_dat,aes(x=fct_reorder(chemokine, fraction, .fun = median, .desc = TRUE), y=fraction+0.001)) + 
  geom_boxplot(alpha=.5) +
  geom_quasirandom(alpha=.2) +
  theme_bw() + 
  theme(text=element_text(size=16)) +
  ylab("Fraction of Expressing Tumor Cells\n(fraction + 0.001)") +
  xlab("") +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  geom_hline(yintercept = median(cur_dat$fraction+0.001), linetype = 2) 
```

# Supp Figure 2C

## Patients per Location

```{r}
sce_rna$MM_location <- ifelse(sce_rna$MM_location %in% c("skin", "skin_undefine"), "skin_undefined", sce_rna$MM_location)

groups <- data.frame(colData(sce_rna)) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(MM_location) %>%
  distinct(PatientID, .keep_all = T) %>%
  summarise(n=n()) %>%
  filter(n>=10) %>%
  arrange(-n)
```

## Boxplot/Barplot per Location for every chemokine combination

```{r}
fractions_per_image <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, MM_location, expressor, celltype) %>%
  summarise(n = n()) %>%
  group_by(ImageNumber) %>%
  mutate(fraction_per_image = n / sum(n)) %>%
  group_by(ImageNumber, expressor) %>%
  mutate(group_fraction = sum(fraction_per_image)) %>%
  ungroup() %>%
  filter(expressor %in% targets & MM_location %in% groups$MM_location)

# fraction of expressor cells per image 
fraction_expressor_per_image <- fractions_per_image %>%
  distinct(ImageNumber, MM_location, expressor, .keep_all = T) %>%
  reshape2::dcast(ImageNumber + MM_location ~ expressor, value.var = "group_fraction", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber", "MM_location"), variable.name = "expressor", 
                 value.name = "fraction_per_image")

# fraction of celltype expressing a certain combi per image
celltype_fractions <- fractions_per_image %>%
  distinct(ImageNumber, celltype, expressor, .keep_all = T) %>%
  reshape2::dcast(ImageNumber + MM_location + expressor ~ celltype, value.var = "fraction_per_image", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber", "MM_location", "expressor"), 
                 variable.name = "celltype", value.name = "fraction_per_image") %>%
  reshape2::dcast(ImageNumber + MM_location + celltype ~ expressor, value.var = "fraction_per_image", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber", "MM_location", "celltype"), 
                 variable.name = "expressor", value.name = "fraction_per_image") %>%
  group_by(MM_location, expressor, celltype) %>%
  summarise(sum_fraction = sum(fraction_per_image)) %>% # sum-up fractions over all images 
  group_by(MM_location, expressor) %>%
  mutate(proportions = sum_fraction / sum(sum_fraction)) # calculate proportions for each expressor
```

## Plot

```{r Supp_Fig_2C_expression_per_location, dev=c('pdf')}
# calculate signif of expressor-fractions per MM_location
fraction_expressor_per_image %>%
  group_by(expressor) %>%
  wilcox_test(fraction_per_image ~ MM_location) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance("p.adj",cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1)) %>%
  arrange(p.adj)

plot_list <- list()
for(i in groups$MM_location) {
  a <- fraction_expressor_per_image %>%
    filter(MM_location == i) %>%  
    group_by(ImageNumber, expressor) %>%
    ggplot(., aes(y=as.factor(expressor), x=fraction_per_image)) + 
    geom_boxplot() + 
    geom_point(alpha=0.2) +
    theme_bw() +
    theme(axis.title.y = element_blank(),
          axis.text.y = element_text(hjust=0.5)) +
    xlab("Cell Fraction per Image") + 
    coord_cartesian(xlim = c(0,0.05))
  
  b <- celltype_fractions %>%
    filter(MM_location == i) %>%  
    ggplot(., aes(y=expressor, x=-proportions, fill=celltype)) + 
    geom_bar(stat = "identity") +
    theme_bw() +
    theme(axis.text.y = element_blank(),
          axis.title.y = element_blank()) +
    guides(fill=guide_legend(title = "Cell Type",nrow=2,byrow=TRUE)) +
    xlab("Producing Cell Types") +
          scale_fill_manual(values = unname(metadata(sce_rna)$colour_vectors$celltype),
                        breaks = names(metadata(sce_rna)$colour_vectors$celltype),
                        labels = names(metadata(sce_rna)$colour_vectors$celltype)) +
    scale_x_continuous(breaks=c(-1.00,-0.75,-0.5, -0.25, 0.00),
                     labels=c("100%", "75%", "50%", "25%", "0%"))
  
  leg <- get_legend(b)
  
  grid.arrange(b+theme(legend.position = "none"),a,nrow=1,
               widths = c(.75,1),
               top = i)
}
```


```{r Supp_Fig_2C_legend, dev=c('pdf'), fig.width=5, fig.height=2}
grid.arrange(leg)
```

# Supp Figure 2D

## Mutation split by Location

```{r Supp_Fig_2D_mutation, dev=c('pdf'), fig.width=15, fig.height=9.5}
# add control location to sce
sce_rna$MM_location_simplified2 <- sce_rna$MM_location_simplified
sce_rna[,sce_rna$Location == "CTRL" & sce_rna$TissueType == "Skin"]$MM_location_simplified2 <- "control skin"
sce_rna[,sce_rna$Location == "CTRL" & sce_rna$TissueType == "Lymphnode"]$MM_location_simplified2 <- "control LN"
sce_rna[,sce_rna$Location == "CTRL" & sce_rna$TissueType == "PSO"]$MM_location_simplified2 <- "control psoriasis"

targets <- metadata(sce_rna)$chemokines_morethan600_withcontrol

# subset sce_rna
group_size <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, Mutation) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(Mutation) %>%
  summarise(n=n()) %>%
  filter(n>10 & Mutation != "")

sce_rna_sub <- sce_rna[,sce_rna$Mutation %in% group_size$Mutation]

a <- plotCellCounts(sce = sce_rna_sub, 
                     sce_sub = sce_rna_sub[,which(sce_rna_sub$expressor %in% targets)],
                     cellID = "cellID",
                     colour_by = "expressor",
                     split_by = "Mutation",
                     imageID = "ImageNumber",
                     normalize = TRUE,
                    show_n = FALSE,
                     colour_vector = metadata(sce_rna)$colour_vectors$chemokine_combinations) + 
  guides(fill=guide_legend("Chemokine")) +
  theme(text = element_text(size=18))

b <- plotCellCounts(sce = sce_rna_sub[,which(sce_rna_sub$expressor %in% targets)],
                     cellID = "cellID",
                     colour_by = "celltype",
                     split_by = "Mutation",
                     imageID = "ImageNumber",
                     proportion = TRUE,
                    show_n = FALSE,
                     colour_vector = metadata(sce_rna)$colour_vectors$celltype) + 
  guides(fill=guide_legend("Cell Type")) +
  theme(text = element_text(size=18))

# fraction of chemokine-expressing cells per image
chemo <- data.frame(colData(sce_rna_sub)) %>%
  #filter(MM_location_simplified2 %in% c("skin_subcutaneous", "LN")) %>%
  group_by(ImageNumber, Mutation, chemokine, MM_location_simplified2) %>%
  summarise(n=n()) %>%
  group_by(ImageNumber) %>%
  mutate(fraction = n / sum(n)) %>%
  reshape2::dcast(ImageNumber + Mutation + MM_location_simplified2 ~ chemokine, value.var = "fraction")

median_expression <- median(chemo$`TRUE`)

stat.test <- chemo %>%
  wilcox_test(`TRUE` ~ Mutation) %>%
  adjust_pvalue(method="BH") %>%
  add_significance("p.adj",cutpoints = c(0, 1e-04, 0.001, 0.01, 0.1, 1)) %>%
  add_xy_position(x = "Mutation")

stat.test$y.position <- stat.test$y.position - 0.125

c <- ggplot(chemo, aes(x=Mutation, y=`TRUE`)) + 
  geom_boxplot(alpha=0.2, lwd=1.5) + 
  geom_quasirandom(aes(col=MM_location_simplified2), size=2, alpha=.8) +
  #geom_hline(yintercept = median_expression, linetype=2, size=2) + 
  stat_pvalue_manual(stat.test, label = "p.adj.signif", size = 7) + 
  xlab("") + 
  ylab("Fraction of Chemokine-Expressing Cells") +
  theme_bw() +
  theme(text = element_text(size=16),
        axis.text.x = element_text(angle=45, hjust=1, vjust=1)) +
  guides(col=guide_legend("Location")) + 
  coord_cartesian(ylim=c(0,0.35))

p <- grid.arrange(a,b, ncol=2, nrow=1)

grid.arrange(p,c,nrow=1, widths = c(0.65,0.35))

# MM_location for Mutations
data.frame(colData(sce_rna_sub)) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(Mutation, MM_location_simplified) %>%
  summarise(n=n()) %>%
  group_by(Mutation) %>%
  mutate(percentage = n / sum(n) * 100)
```

# Supp Figure 2E

## Chemokines cross-correlation

```{r Supp_Fig_2E_correlation_chemokines, fig.width=9, fig.height=9, dev=c('pdf')}
# top abundant chemokines
cur_rna <- data.frame(colData(sce_rna))

# sum
rna_sum <- cur_rna %>%
  group_by(Description, expressor) %>%
  summarise(n = n()) %>%
  reshape2::dcast(Description ~ expressor, value.var = "n", fill = 0) 

# only keep highly abundant chemokines
rna_sum <- rna_sum[,colnames(rna_sum) %in% targets]

# correlation
cor <- cor(rna_sum, rna_sum, method = "pearson")

corrplot(cor, 
         order = "FPC",
         addCoef.col = "black",
         method = "circle",
         tl.col="black",
         tl.cex = 1.5)
```
