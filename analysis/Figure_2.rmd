---
title: "Figure_2"
author: "toobiwankenobi"
date: "2020-08-04"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction
This script generates plots for Figure 2.

# Preparation

```{r setup}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Load libraries
```{r, message=F}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(SingleCellExperiment)
library(ComplexHeatmap)
library(data.table)
library(dplyr)
library(janitor)
library(tidyr)
library(ggpmisc)
library(cowplot)
library(corrplot)
library(gridExtra)
library(ggalluvial)
library(ggbeeswarm)
library(ggpubr)
library(RColorBrewer)
library(colorRamps)
library(circlize)
library(forcats)
library(ggpmisc)
```

## Load data

```{r}
sce_rna <- readRDS(file = "data/sce_RNA.rds")
sce_prot <- readRDS(file= "data/sce_protein.rds")
```

# Plots

## UpSet plot with ComplexHeatmap - including CellType Annotation and Met Location (with controls)

```{r Fig_2B_upset_plot, message=F, fig.width=10, fig.height=12, dev=c('pdf')}
cur_dt <- as.data.table(colData(sce_rna))

# combinations with more than 600 occurrences
targets <- metadata(sce_rna)$chemokines_morethan600_withcontrol
targets_no_control <- replace(targets, match(c("CXCL8", "CCL18"),targets), c("CCL18", "CXCL8"))

# remove control samples
cur_dt <- cur_dt[MM_location_simplified != "control",]

# extract chemokine columns
chemokines <- cbind(cur_dt[,c("ImageNumber", "MM_location_simplified", "celltype")], cur_dt[,grepl(glob2rx("C*L*"),names(cur_dt)), with = F])

# create combination matrix
m <- make_comb_mat(chemokines, top_n_sets = 11)

# filter based on combination size and combination degree
m <- m[comb_size(m) >= 600 & comb_degree(m) > 0]

# sort according to abundance
m <- m[order(-comb_size(m))]

# extract comb names
comb_names <- comb_name(m)

# count celltypes for each combination
celltypes <- data.table()
location <- data.table()

# summarize statistics for each combination (celltype fractions, location)
for (i in comb_names){
  # subset
  set <- chemokines[extract_comb(m, i)]
  
  # chemokines celltypes
  set1 <- set %>%
    group_by(celltype) %>%
    summarise(n=n()) %>%
    reshape2::dcast(.,i ~ celltype, value.var = "n")
  
  # chemokines by location
  set2 <- set %>%
    group_by(ImageNumber, MM_location_simplified) %>%
    summarise(n=n())
  
  # add images with no combinations to not distort median
  set2_add <- distinct(cur_dt[,c("ImageNumber", "MM_location_simplified")], ImageNumber, .keep_all = T)
  set2_add$n <- 0
  
  # subset to only contain images which are not already part of set2
  set2_add <- set2_add[!(ImageNumber %in% set2$ImageNumber),]
  
  set2 <- set2 %>%
    rbind(., set2_add) %>%
    group_by(MM_location_simplified) %>%
    mutate(median = median(n)) %>%
    distinct(MM_location_simplified, median) %>%
    reshape2::dcast(.,i ~ MM_location_simplified, value.var = "median")
  
  # add to data.frame
  celltypes <- rbind(celltypes, set1, fill = TRUE)
  location <- rbind(location, set2, fill = TRUE)
}

# replace NA
celltypes[is.na(celltypes)] <- 0
location[is.na(location)] <- 0

# properties of combination matrix
ss = set_size(m)
cs = comb_size(m)

# create plot
ht = UpSet(m, 
    set_order = order(ss),
    comb_order = order(cs, decreasing = T),
    top_annotation = HeatmapAnnotation(
        "Number of\nExpressing Cells" = anno_barplot(celltypes[,-1], 
            ylim = c(0, max(cs)*1.1),
            border = FALSE, 
            gp = gpar(fill = metadata(sce_rna)$colour_vectors$celltype[colnames(celltypes[,-1])]), 
            axis_param = list(gp = gpar(fontsize=20)),
            height = unit(12, "cm")), 
        annotation_name_side = "left", 
        annotation_name_rot = 0,
        annotation_name_gp = gpar(fontsize=20)),
    left_annotation = rowAnnotation(
        "Total Number of\nExpressing Cells" = anno_barplot(-ss, 
            baseline = 0,
            axis_param = list(
                at = c(0, -5000, -10000, -15000),
                labels = c(0, 5000, 10000, 15000),
                labels_rot = 0,
                gp = gpar(fontsize = 15)),
            border = FALSE, 
            gp = gpar(fill = "black"), 
            width = unit(5, "cm"),
        ),
        set_name = anno_text(set_name(m), 
            location = 0.5, 
            gp = gpar(fontsize=15),
            just = "center",
            width = max_text_width(set_name(m)) + unit(4, "mm")),
        annotation_name_gp = gpar(fontsize=20)),
    right_annotation = NULL,
    show_row_names = FALSE,
    pt_size = unit(5, "mm"),
    lwd = 2,
    width = unit(14, "cm"),
    height = unit(14, "cm")
    )

# draw heatmap
ht = draw(ht)

# add absolute numbers on top of barplot
od = column_order(ht)
row_od = row_order(ht)
decorate_annotation("Number of\nExpressing Cells", {
  grid.text(cs[od], x = seq_along(cs), y = unit(cs[od], "native") + unit(2, "pt"), 
            default.units = "native", just = c("left", "bottom"), 
            gp = gpar(fontsize = 15, col = "#404040"), rot = 45)
  })
decorate_annotation("Total Number of\nExpressing Cells", {
	grid.text(ss[row_od], 
		x = unit(-ss[row_od], "native") + unit(-0.75, "cm"), 
		y = rev(seq_len(length(-ss))), 
		default.units = "native", rot = 0,
		gp = gpar(fontsize = 13))
})
```

## Legend for Figure

```{r Fig_2B_legend, dev=c('pdf'), fig.height=1, fig.width=2}
# legend for celltypes
lgd1 = Legend(labels = colnames(celltypes[,-1]), 
             title = "Celltypes", 
             legend_gp = gpar(fill = metadata(sce_rna)$colour_vectors$celltype[colnames(celltypes[,-1])],
                              fontsize = 18),
             nrow = 5)

draw(packLegend(lgd1,column_gap = unit(0.5, "cm"),
                max_height = unit(7, "cm")))
```

## Heatmap Marker Expression

```{r, Fig_2C_heatmap_marker_producing_cells, fig.width=12, fig.height=12, dev=("pdf")}
# add marker expression to cells
marker_expression <- data.frame(t(assay(sce_rna[rowData(sce_rna)$good_marker,], "asinh")))
marker_expression$cellID <- rownames(marker_expression)

# chemokine info
chemo <- data.frame(colData(sce_rna))[,c("cellID", "expressor", "celltype")] 

dat <- left_join(chemo, marker_expression, by = "cellID")
dat$cellID <- NULL

# aggregate data
dat_aggr <- dat %>%
  filter(expressor %in% colnames(colData(sce_rna))[grepl("CXCL|CCL", colnames(colData(sce_rna)))]) %>%
  group_by(celltype, expressor) %>%
  summarise_all(funs(mean))

# prepare matrix for heatmap
dat_aggr <- dat_aggr %>%
  arrange(celltype, expressor)

stats <- dat %>%
  filter(expressor %in% colnames(colData(sce_rna))[grepl("CXCL|CCL", colnames(colData(sce_rna)))]) %>%
  group_by(celltype, expressor) %>%
  summarise(n=n()) %>%
  filter(n>1000) %>%
  arrange(celltype, expressor)

dat_aggr <- dat_aggr %>%
  filter(paste0(celltype,expressor) %in% paste0(stats$celltype,stats$expressor))

# factorize expressor for column sorting in heatmap
dat_aggr$expressor <- factor(dat_aggr$expressor, levels = c("CCL4", "CCL18", "CCL22", "CXCL8", 
                                                            "CCL8", "CXCL9", "CXCL10", "CXCL13", "CCL2", "CXCL12", "CCL19"))
stats$expressor <- factor(stats$expressor, levels = c("CCL4", "CCL18", "CCL22", "CXCL8", 
                                                            "CCL8", "CXCL9", "CXCL10", "CXCL13", "CCL2", "CXCL12", "CCL19"))

dat_aggr <- dat_aggr %>%
  arrange(celltype, expressor)

stats <- stats %>%
  arrange(celltype, expressor)

# create and scale scale matrix
m <- as.matrix(t(dat_aggr[,-c(1:2)]))
m <- t(scale(t(m)))
colnames(m) <- dat_aggr$celltype

# create top annotations
ha <- HeatmapAnnotation("Chemokine" = dat_aggr$expressor,
                        "Cells" = anno_barplot(stats[,3],
                                               height = unit(1.5,"cm"),
                                               axis_param = list(gp = gpar(fontsize=14))),
                        "Cell Numbers" = anno_text(t(stats[,3]), 
                                                   which = "column", 
                                                   rot = 90, 
                                                   just = "center", 
                                                   location = 0.5,
                                                   gp = gpar(fontsize=10)),
                        col = list("Chemokine" = metadata(sce_rna)$colour_vectors$chemokine_single),
                        show_legend = FALSE,
                        annotation_name_gp = gpar(fontsize = 16))


# row_split for markers
rowData(sce_rna)$heatmap_relevance <- ""
rowData(sce_rna[rowData(sce_rna)$good_marker,])$heatmap_relevance <- "lineage"
rowData(sce_rna[grepl("CXCL|CCL|DapB", rownames(sce_rna)),])$heatmap_relevance <- "chemokine"
rowData(sce_rna[grepl("B2M|GLUT1|CD134|Lag3|CD163|cleavedPARP|pRB", rownames(sce_rna)),])$heatmap_relevance <- "other"
             
# create heatmap
h <- Heatmap(m, name = "Scaled\nExpression",
             row_split = rowData(sce_rna[rowData(sce_rna)$good_marker,])$heatmap_relevance,
             cluster_columns = FALSE,
             show_column_names = FALSE,
             top_annotation = ha,
             show_heatmap_legend = FALSE,
             column_split = colnames(m),
             column_title_rot = 90,
             cluster_column_slices = TRUE,
             row_names_gp = gpar(fontsize = 16),
             column_title_gp = gpar(fontsize = 23),
             row_title_gp = gpar(fontsize = 23),
             col = colorRamp2(c(-3, 0, 3), c("blue", "white", "red")),
             height = unit(20, "cm"),
             width = unit(25,"cm"))

# draw heatmap
draw(h)
```

## Legend heatmap

```{r Fig_2C_legend_heatmap, dev="pdf", fig.height=2, fig.width=7}
lgd1 = color_mapping_legend(h@matrix_color_mapping, plot = FALSE, legend_direction = "horizontal", legend_width=unit(3,"cm"), at = c(-3:3))
lgd2 = color_mapping_legend(ha@anno_list$Chemokine@color_mapping, plot = FALSE, legend_direction = "horizontal", nrow = 4)

lgd_list = packLegend(lgd1,lgd2,direction = "horizontal", gap = unit(1,"cm"))
draw(lgd_list)
```

## Fraction of Tumor Cells that express chemokines

```{r Fig_2D_tumor_cells_chemokine, dev=("pdf"), fig.width=9}
cur_dat <- data.frame(colData(sce_rna))
cur_dat <- cur_dat %>%
  filter(celltype == "Tumor") %>%
  filter(Location != "CTRL")

cur_dat <- cur_dat[,c("ImageNumber", "Mutation", colnames(cur_dat)[grepl(glob2rx("C*L*"),names(cur_dat))])]

# colSums of Chemokines in Tumor Cells (Multiple Producer count more than once)
cur_dat <- cur_dat %>%
  group_by(ImageNumber, Mutation) %>%
  mutate(cells = n()) %>%
  group_by(ImageNumber, cells, Mutation) %>%
  summarise_each(funs(sum))

# compute fractions
cur_dat[,4:14] <- cur_dat[,4:14] / t(cur_dat$cells)

cur_dat <- cur_dat %>%
  filter(cells > 200) %>%
  reshape2::melt(id.vars=c("ImageNumber", "cells", "Mutation"), variable.name="chemokine", value.name="fraction")

ggplot(cur_dat,aes(x=fct_reorder(chemokine, fraction, .fun = median, .desc = TRUE), y=fraction+0.001)) + 
  geom_boxplot(alpha=.5) +
  geom_quasirandom(alpha=.2) +
  theme_bw() + 
  theme(text=element_text(size=16)) +
  ylab("Fraction of Expressing Tumor [log10 + 0.001]") +
  xlab("") +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  geom_hline(yintercept = median(cur_dat$fraction+0.001), linetype = 2)
```

# Correlations

## Correlation of Chemokines with Celltypes

```{r Fig_2E_correlation_chemokines, fig.width=9, fig.height=9, dev=c('pdf')}
# top abundant chemokines
cur_rna <- data.frame(colData(sce_rna))

# sum
rna_sum <- cur_rna %>%
  group_by(Description, expressor) %>%
  summarise(n = n()) %>%
  reshape2::dcast(Description ~ expressor, value.var = "n", fill = 0) 

# only keep highly abundant chemokines
rna_sum <- rna_sum[,colnames(rna_sum) %in% targets]

# correlation
cor <- cor(rna_sum, rna_sum, method = "pearson")

corrplot(cor, 
         order = "FPC",
         addCoef.col = "white",
         method = "circle",
         tl.col="black",
         tl.cex = 1.5)
```

## Correlation of Chemokines with Celltypes (based on fractions)

```{r Fig_2F_pearson_correlation_chemokines_prot_data, fig.width=9, fig.height=9, dev=c('pdf')}
# top abundant chemokines
cur_rna <- data.frame(colData(sce_rna))

# protein data
cur_prot <- data.frame(colData(sce_prot))

# sum
rna_sum <- cur_rna %>%
  group_by(Description) %>%
  mutate(total_cells=n()) %>%
  ungroup() %>%
  group_by(Description, total_cells, expressor) %>%
  summarise(n=n()) %>%
  mutate(fraction=n/total_cells) %>%
  reshape2::dcast(Description ~ expressor, value.var = "fraction", fill = 0) 

# only keep highly abundant chemokines
rna_sum <- rna_sum[,c("Description", targets)]

prot_sum <- cur_prot %>%
  group_by(Description, celltype) %>%
  summarise(n = n()) %>%
  group_by(Description) %>%
  mutate(fraction = n/sum(n)) %>%
  reshape2::dcast(Description ~ celltype, value.var = "fraction", fill = 0)

# equal images
all(rna_sum$Description == prot_sum$Description)

# correlation
cor <- cor(rna_sum[,-1], prot_sum[,-1], method = "pearson")

corrplot(cor, 
         addCoef.col = "white",
         method = "circle",
         tl.col="black",
         tl.cex = 1.5)
```

## Scatter Plot for CD8+ and Chemokine Selection

```{r Fig_2F_cd8_chemokine_correlation, fig.width=11, fig.height=14, dev=("pdf")}
# sum
chemokines <- data.frame(colData(sce_rna)) %>%
  group_by(Description) %>%
  mutate(total_cells=n()) %>%
  ungroup() %>%
  group_by(Description, total_cells, expressor) %>%
  summarise(n=n()) %>%
  mutate(fraction=n/total_cells) %>%
  reshape2::dcast(Description ~ expressor, value.var = "fraction", fill = 0) %>%
  select(Description, CXCL12, CXCL9, CCL22)

celltypes <- data.frame(colData(sce_prot)) %>%
  group_by(Description, celltype) %>%
  summarise(n=n()) %>%
  mutate(fraction=n/sum(n)) %>%
  reshape2::dcast(Description ~ celltype, value.var = "fraction", fill = 0) %>%
  select(Description, Tcytotoxic, pDC, Tregulatory) %>%
  reshape2::melt(id.vars = "Description", variable.name = "celltype", value.name = "cell_fraction")

sum <- left_join(celltypes, chemokines, by = "Description") %>%
  reshape2::melt(id.vars = c("Description", "celltype", "cell_fraction"), variable.name = "expressor", value.name = "chemo_fraction")

sum <- sum %>%
  mutate(celltype_chemo = paste(celltype, expressor, sep = " ~ ")) %>%
  filter(celltype_chemo %in% c("Tcytotoxic ~ CXCL9", "pDC ~ CXCL12", "Tregulatory ~ CCL22"))

sum$celltype_chemo <- factor(sum$celltype_chemo, levels = c("Tcytotoxic ~ CXCL9", "pDC ~ CXCL12", "Tregulatory ~ CCL22"))

ggplot(sum, aes(x=chemo_fraction, y=cell_fraction)) + 
  geom_point() + 
  geom_smooth(method="lm") +
  scale_x_log10() + 
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  annotation_logticks(sides = "b") +
  ylab("Celltype Fraction\n") +
  xlab("Chemokine Fraction") +
  scale_y_continuous(position = "right") +
  theme_bw() + 
  theme(text=element_text(size=35)) +
  guides(col=guide_legend(title="Chemokines")) +
  stat_poly_eq(formula = y ~ x, size=13,
               aes(label = ..rr.label..), 
               parse = TRUE) + 
  facet_wrap(~celltype_chemo, ncol = 1, scales = "free")
```

