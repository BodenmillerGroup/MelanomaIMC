---
title: "XX_RNA_Protein_survival_analysis"
author: "toobiwankenobi"
date: "2020-09-08"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

# Preparations

## Load libraries

```{r}
library(lme4)
library(ggplot2)
library(coxme)
library(survminer)
library(dplyr)
library(SingleCellExperiment)
```

## Load data
```{r}
# load the data that contains the time to event and censoring
data <- read.csv("data/survdat_for_modelling.csv")
sce_rna <- readRDS(file = "data/sce_RNA.rds")
```


##Simple mixed models

Here is a simple mixed model. Model terms are divided between "fixed" and "random" effects. Fixed effects are the normal main effects that we want to subject to hypothesis testing, while random effects are used to account for unwanted structure in the data. Random effects are most often used to account for repeated measures on an individual, heirarchical sample collection (like multiple patients per center), or any other experimental detail that divides samples into unwanted groups. Random effects can also be nested within each other, like BlockID within patient ID. 

 
Without the random factors: 

```{r mod1, echo=TRUE, warning=FALSE}
mod <- coxph(Surv(time = Time_to_death_or_last_PET, event = censoring_death) ~ Fraction_Tcyt, data = data)
anova(mod)
```
 
 
 This is misleading because it uses multiple death / no death measurements per patient. 
 
 
We can introduce a random factor to account for multiple measure per patient / block. Below, the random effect syntax is (1 | patient ID / Block ID). The "1" is a place holder - this location can also be used to specify a "random slope" which we won't need here. The bar separates the next part, the "random intercept". In this case there are two, with the block ID nested within the patient ID. If you have multiple un-nested random effects, the random term can be specified multiple times, like  Surv() ~ normal_effect + (1 | factor_a) + (1 | factor_b). 
 
```{r mod2, echo=TRUE, warning=FALSE}
mod2 <- coxme(Surv(time = Time_to_death_or_last_PET, event = censoring_death) ~ Fraction_Tcyt +
                (1 | Internal.Pat..ID / Block.ID), data = data)
anova(mod2)
```
 
 This is a better result. The variance associated with individual patients / blocks has been removed to the random component, and so the association with Tcyt score is better revealed. 
 
 We can also see that the number of events has been properly accounted for: 
 
```{r echo=TRUE}
summary(mod2)
```

## Model 3 - include number of treatments before surgery as fixed effect

```{r mod3, echo=TRUE, warning=FALSE}
data$number_of_treatments_before_grouping <- ifelse(data$Number.of.treatments.before.surgery == 0, "naive", "non-naive")

mod3 <- coxme(Surv(time = Time_to_death_or_last_PET, event = censoring_death) ~ number_of_treatments_before_grouping + 
                Fraction_Tcyt +
                (1 | Internal.Pat..ID / Block.ID), data = data)

summary(mod3)
anova(mod3)
```

To check if we really need the random effect we can do a log-liklihood test: 
 
```{r echo=TRUE, warning=FALSE}
anova(mod, mod3)
```

# Treatment-naive Patients

## Model 4 - only consider treatment naive patients for outcome (relapse) analysis

```{r mod4, echo=TRUE, warning=FALSE}
data_sub <- data[data$number_of_treatments_before_grouping == "naive",]

mod4 <- coxme(Surv(time = Time_to_.progression_or_last_PET, event = censoring_progression) ~ 
                Fraction_Tcyt +
                (1 | Internal.Pat..ID / Block.ID), data = data_sub)

anova(mod4)
```

The cytotoxic T cell fraction is significant for relapse outcome. 

## Model 5 - cytotoxic T cell fraction per image 

```{r mod5}
# define CXCL13+CD8+ fraction
frac <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber) %>%
  mutate(n_image = n()) %>%
  filter(celltype == "Tcytotoxic") %>%
  group_by(ImageNumber, BlockID, celltype, n_image) %>%
  summarise(n = n()) %>%
  mutate(Fraction_Tcyt_image = n / n_image)

names(data)[3] <- "BlockID"

frac <- left_join(frac[,c("ImageNumber", "BlockID", "Fraction_Tcyt_image")], data)

# only naive patients
frac <- frac[frac$number_of_treatments_before_grouping == "naive",]

# random effect: multiple images per block/patient
mod5 <- coxme(Surv(time = Time_to_.progression_or_last_PET, event = censoring_progression) ~
               Fraction_Tcyt_image + 
               (1 | Internal.Pat..ID / BlockID / ImageNumber), data = frac)
anova(mod5)
```

# Visualization

## Kaplan-Meier for whole data set

```{r, KM_whole_data_set, fig.height=8, fig.width=7}
data$Frac_Tcyt_score <- factor(data$Frac_Tcyt_score, levels = c("high", "med", "low"))

fit <- survfit(Surv(time = Time_to_death_or_last_PET, event = censoring_death) ~ Frac_Tcyt_score, data = data)

ggsurvplot(fit, data = data,
 conf.int = TRUE,
 pval = TRUE,
 fun = "pct",
 risk.table = TRUE,
 size = 1,
 linetype = "strata",
 legend = "bottom",
 legend.title = "cytotoxic T cell Fraction",
 legend.labs = c("high",
 "medium", "low"))
```

## Hazard Ratios for whole data set

```{r HR_whole_data_set, fig.height=7, fig.width=13}
fit <- coxph(Surv(time = Time_to_death_or_last_PET, event = censoring_death) ~ Frac_Tcyt_score +
               number_of_treatments_before_grouping, data = data)
class(fit)
ggforest(fit, data=data)
```

## Kaplan-Meier for treatment-naive patients only

```{r KM_treatment_naive, fig.height=8, fig.width=7}
data_sub$Frac_Tcyt_score <- factor(data_sub$Frac_Tcyt_score, levels = c("high", "med", "low"))

fit <- survfit(Surv(time = Time_to_.progression_or_last_PET, event = censoring_progression) ~ 
                 Frac_Tcyt_score, data = data_sub)

ggsurvplot(fit, data = data_sub,
 conf.int = FALSE,
 pval = TRUE,
 fun = "pct",
 risk.table = TRUE,
 size = 1,
 linetype = "strata",
 legend = "bottom",
 legend.title = "cytotoxic T cell Fraction",
 legend.labs = c("high",
 "medium", "low"))
```

## Hazard Ratios for treatment-naive patients only

```{r HR_treatment_naive}
fit <- coxph(Surv(time = Time_to_.progression_or_last_PET, event = censoring_progression) ~ 
               Frac_Tcyt_score,
             data = data_sub)
ggforest(fit, data=data_sub)
```
