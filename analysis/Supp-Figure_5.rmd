---
title: "Supplementary Figure 5"
author: "Tobias Hoch and Daniel Schulz"
date: "2021-01-30"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction
This script generates plots for Supplementary Figure 5.

# Preparations

```{r setup}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Load libraries

```{r load-libraries, message=FALSE}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(cytomapper)
library(SingleCellExperiment)
library(reshape2)
library(tidyverse)
library(dplyr)
library(data.table) 
library(ggplot2)
library(colorRamps)
library(RColorBrewer)
library(gridExtra)
library(ggpmisc)
library(ComplexHeatmap)
library(scater)
library(dittoSeq)
library(ggbeeswarm)
library(corrplot)
library(ggpubr)
library(cowplot)
library(circlize)
library(ggrepel)
library(rstatix)
```

# Supp Fig 5A

```{r Supp_Fig_5A_gatedCells_Protein, fig.width=7.5, fig.height=4.8, dev=("png")}
# sample 300 cells per cell type
sce_prot_sub <- sce_prot[,sce_prot$layer_1_gated != "unlabelled"]

set.seed(2345)
# sub-sample 500 cells
sample <- data.frame(colData(sce_prot_sub)) %>%
  group_by(celltype) %>%
  slice_sample(n=300)

# unique cellIDs
sample <- sample[sample$cellID %in% unique(sample$cellID),]

cur_sce <- sce_prot[,sce_prot$cellID %in% sample$cellID]

good_markers <- rownames(sce_prot)[rowData(sce_prot)$good_marker]

colors <- metadata(sce_prot)$colour_vector$celltype
colors <- colors[c("B cell", "BnT cell", "CD4+ T cell", "CD8+ T cell", "FOXP3+ T cell", "Macrophage", "Neutrophil", "pDC", "Stroma", "Tumor", "unknown")]

dittoHeatmap(cur_sce,
             genes = good_markers, 
             assay = "asinh",
            annot.by = c("celltype"),
            show_colnames = FALSE,
            cluster_rows = TRUE,
            annot.colors = colors,
            heatmap.colors = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            breaks = seq(-3,3, length.out = 101),
            use_raster=TRUE)
```

# Supp Figure 5B

```{r Supp_Fig_5B_gatedCells_RNA, fig.width=8, fig.height=4.8, dev=("png")}
set.seed(2345)

sce_rna_sub <- sce_rna[,sce_rna$layer_1_gated != "unlabelled"]

# remove unkown - not enough cells
sce_rna_sub <- sce_rna_sub[,sce_rna_sub$celltype != "unknown"]

# sub-sample 500 cells
sample <- data.frame(colData(sce_rna_sub)) %>%
  group_by(celltype) %>%
  slice_sample(n=300)

# unique cellIDs
sample <- sample[sample$cellID %in% unique(sample$cellID),]

cur_sce <- sce_rna[,sce_rna$cellID %in% unique(sample$cellID)]

good_markers <- rownames(sce_rna)[rowData(sce_rna)$good_marker]
colors <- metadata(sce_rna)$colour_vector$celltype[]
colors <- colors[c("CD38", "CD8- T cell", "CD8+ T cell", "HLA-DR", "Macrophage", "Neutrophil", "Stroma", "Tumor", "Vasculature")]

dittoHeatmap(cur_sce, genes = good_markers, assay = "asinh",
            annot.by = c("celltype"),
            show_colnames = FALSE,
            cluster_rows = TRUE,
            annot.colors = colors,
            heatmap.colors = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            breaks = seq(-3,3, length.out = 101),
            use_raster=TRUE)
```

# Supp Figure 5C and 5D
These plots are generated after the randomForest classification. For this, see files XY...

# Supp Figure 5E

```{r Supp_Fig_5E_cross_correlation, fig.width=9, fig.height=9, dev=c('pdf')}
# rna data
cur_rna <- data.frame(colData(sce_rna))

# protein data
cur_prot <- data.frame(colData(sce_prot))

# rna data set - cell type fractions
rna_sum <- cur_rna %>%
  group_by(Description, celltype) %>%
  summarise(n = n()) %>%
  group_by(Description) %>%
  mutate(fraction = n/sum(n)) %>%
  reshape2::dcast(Description ~ celltype, value.var = "fraction", fill = 0)

# protein data set - cell type fractions
prot_sum <- cur_prot %>%
  group_by(Description, celltype) %>%
  summarise(n = n()) %>%
  group_by(Description) %>%
  mutate(fraction = n/sum(n)) %>%
  reshape2::dcast(Description ~ celltype, value.var = "fraction", fill = 0)

# equal images
all(rna_sum$Description == prot_sum$Description)

# correlation
cor <- cor(rna_sum[,-1], prot_sum[,-1], method = "pearson")

# reorder cor matrix
cor <- cor[c("CD38", "HLA-DR", "Stroma", "Vasculature", "unknown", "CD8- T cell", "CD8+ T cell", "Macrophage", "Neutrophil", "Tumor"),
           c("B cell", "BnT cell", "pDC", "Stroma", "unknown", "FOXP3+ T cell", "CD4+ T cell", "CD8+ T cell", "Macrophage", "Neutrophil", "Tumor") ]

corrplot(cor, 
         addCoef.col = "black",
         method = "circle",
         tl.col="black",
         tl.cex = 1.5)

# correlation and p-value
common_cells <- c("Macrophage", "Neutrophil", "Tumor", "CD8+ T cell")

# mean correlation for celltype specific correlation
round(mean(cor(rna_sum[,"Macrophage"], prot_sum[,"Macrophage"]),
     cor(rna_sum[,"Neutrophil"], prot_sum[,"Neutrophil"]),
     cor(rna_sum[,"Tumor"], prot_sum[,"Tumor"]),
     cor(rna_sum[,"CD8+ T cell"], prot_sum[,"CD8+ T cell"])),2)

# p-values
cor.test(rna_sum[,"Macrophage"], prot_sum[,"Macrophage"])
cor.test(rna_sum[,"Neutrophil"], prot_sum[,"Neutrophil"])
cor.test(rna_sum[,"Tumor"], prot_sum[,"Tumor"])
cor.test(rna_sum[,"CD8+ T cell"], prot_sum[,"CD8+ T cell"])
```
