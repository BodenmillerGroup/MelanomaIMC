---
title: "XX_Protein_NeighbouRhood_analysis"
author: "toobiwankenobi"
date: "2020-10-13"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Preparations

## Load packages and helper functions

```{r message=F}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(SingleCellExperiment)
library(ggplot2)
library(reshape2)
library(cowplot)
library(dplyr)
library(sf)
library(gridExtra)
library(scater)
library(dittoSeq)
library(RColorBrewer)
library(neighbouRhood)
library(ComplexHeatmap)
```

## Load data

```{r load data}
sce_protein = readRDS(file = "data/sce_protein.rds")
```

# NeighbouRhood analysis

## Specify the input

```{r}
# Load and prepare
dat_cells = fread(file = "data/protein/cell.csv",stringsAsFactors = FALSE)
dat_relation = fread(file = "data/protein/Object relationships.csv",stringsAsFactors = FALSE)

n_perm = 1000

# Number of cores used for multicore:
ncores=7
```

## Start the analysis

```{r}
# add same cellID to dat_cells as in sce object
dat_cells$cellID <- paste("protein_", paste(dat_cells$ImageNumber, dat_cells$ObjectNumber, sep = "_"), sep = "")

# add p75 status to celltype annotaiton
sce_info <- as.data.frame(colData(sce_protein))[,c("cellID", "celltype", "Description")]
sce_info <- sce_info %>%
  select(c("cellID", "celltype", "Description"))

# add celltype information
dat_cells <- left_join(dat_cells, sce_info, by = "cellID")

#assign labels and groups
dat_cells <- as.data.table(dat_cells)
dat_cells[, label := celltype]
dat_cells[, group := ImageNumber]

# Prepare the data
d = prepare_tables(dat_cells, dat_relation)

# Calculate the baseline statistics
dat_baseline = apply_labels(d[[1]], d[[2]]) %>%
  aggregate_classic()

# Calculate the permutation statistics
# This will run the test using parallel computing. The name of the idcol does actually not matter.

set.seed(12312)
dat_perm = rbindlist(mclapply(1:n_perm, function(x){
  dat_labels = shuffle_labels(d[[1]])
  apply_labels(dat_labels, d[[2]]) %>%
    aggregate_classic()
},mc.cores = ncores
), idcol = 'run') 
```

## Heatmap per Sample (FirstLabel == Tumor)

```{r}
# calc p values
dat_p <- calc_p_vals(dat_baseline, dat_perm, n_perm = 1000, p_tresh = 0.01) 

dat_p$first_second <- paste(dat_p$FirstLabel, dat_p$SecondLabel, sep = "__")

# only keep Tumor cells as FirstLabel
#dat_p <- dat_p[dat_p$FirstLabel %in% c("Tumor")]

pmat = dcast(dat_p, 'group ~ first_second', value.var = 'sigval', fill=0, drop=F)
names(pmat)[1] <- "ImageNumber"

# add Description
pmat <- left_join(data.frame(pmat),distinct(dat_cells[,c("ImageNumber", "Description")], ImageNumber, .keep_all = TRUE))

# add class info 
pmat$class <- ""
pmat[pmat$Description %in% sce_protein[,sce_protein$T_frac_score_per_ImageNumber == "low"]$Description,]$class <- "low"
pmat[pmat$Description %in% sce_protein[,sce_protein$T_frac_score_per_ImageNumber == "med"]$Description,]$class <- "med"
pmat[pmat$Description %in% sce_protein[,sce_protein$T_frac_score_per_ImageNumber == "high"]$Description,]$class <- "high"
#pmat[pmat$Description %in% sce_protein[,sce_protein$infiltration == "Control"]$Description,]$class <- "Control"

pmat$ImageNumber <- as.character(pmat$ImageNumber)

pmat_num <- pmat %>%
  select_if(is.numeric) %>%
  colnames(.)

m <- t(pmat[,pmat_num])
ha1 <- HeatmapAnnotation("Sample ID" = anno_text(pmat$Description, which = "column", gp = gpar(cex=0.3)))

pdf("~/Desktop/neighboRhood_celltype.pdf", width = 9, height = 10)
Heatmap(m = m, name = "+1 Attraction, \n-1 Avoidance",
        row_names_gp = gpar(cex=0.5),
        top_annotation = ha1,
        column_split = pmat$class,
        cluster_columns = TRUE)
dev.off()
```
