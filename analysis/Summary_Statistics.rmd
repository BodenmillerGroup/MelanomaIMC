---
title: "Summary Statistics for hte Manuscript"
author: "toobiwankenobi"
date: "2020-10-26"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction
This script gives an overview over the clinical data and generates statistics used in the manuscript. 

# Preparations

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Load libraries

```{r load libraries}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(data.table)
library(dplyr)
library(SingleCellExperiment)
library(readr)
```

## Load Data

```{r}
# clinical data
dat <- read_csv("data/protein/clinical_data_protein.csv")

# SCE object
sce_protein = readRDS(file = "data/sce_protein.rds")
sce_rna = readRDS(file = "data/sce_RNA.rds")
```

# Statistics

## Number of Samples and Patients

```{r}
# Number of Samples without control samples
data.frame(colData(sce_protein)) %>%
  filter(Location != "CTRL") %>%
  distinct(Description) %>%
  summarise(n=n())

# Number of Patients
data.frame(colData(sce_protein)) %>%
  filter(Location != "CTRL") %>%
  distinct(PatientID) %>%
  summarise(n=n())
```

## Number of Celltypes

```{r}
# Protein data
data.frame(colData(sce_protein)) %>%
  filter(Location != "CTRL") %>%
  group_by(celltype) %>%
  summarise(n=n())

# RNA data
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  group_by(celltype) %>%
  summarise(n=n())
```

## Number of Chemokine Expressing Cells

```{r}
# Percentage of Chemokine Producing Cells
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  group_by(chemokine) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))

# Chemokines by Celltype
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(chemokine == 1) %>%
  group_by(celltype) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))

# Sum of major expressing cell types
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(chemokine == 1) %>%
  group_by(celltype) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1)) %>%
  filter(percentage > 15) %>%
  summarise(sum <- sum(percentage))

# CXCL13 experssion by Tcells
# Chemokines by Celltype
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(expressor == "CXCL13") %>%
  group_by(celltype) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1)) %>%
  filter(percentage > 30) %>%
  summarise(sum <- sum(percentage))
```

## Co-Expression of Chemokines

```{r}
data.frame(colData(sce_rna)) %>%
  rowwise() %>%
  mutate(coexpression = ifelse(length(strsplit(expressor, "_")[[1]]) > 2, 1, 0)) %>%
  filter(Location != "CTRL") %>%
  filter(chemokine == 1) %>%
  group_by(coexpression) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))
```

## Chemokine Expression in Tumor Cells

```{r}
# Percentage of Tumor Cells that Express a Chemokine
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(celltype == "Tumor") %>%
  group_by(chemokine) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))

# CXCL10 in Tumor cells
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(CXCL10 == 1) %>%
  group_by(celltype) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))

data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(celltype == "Tumor") %>%
  group_by(CXCL10) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))

# CCL2 in Tumor cells
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(CCL2 == 1) %>%
  group_by(celltype) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))

data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(celltype == "Tumor") %>%
  group_by(CCL2) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))

# CXCL8 in Tumor cells
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(CXCL8 == 1) %>%
  group_by(celltype) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))

data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(celltype == "Tumor") %>%
  group_by(CXCL8) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))

# CXCL12 in Tumor cells
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(CXCL12 == 1) %>%
  group_by(celltype) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))

data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  filter(celltype == "Tumor") %>%
  group_by(CXCL12) %>%
  summarise(n=n()) %>%
  mutate(percentage = round((n / sum(n)) *100,1))
```

## Chemokine Expression in Locations

```{r}
# overall chemokine expression
data.frame(colData(sce_rna)) %>%
  filter(Location == "CTRL") %>%
  group_by(chemokine, TissueType) %>%
  summarise(n=n()) %>%
  reshape2::dcast(TissueType ~ chemokine, value.var = "n", fill = 0) %>%
  mutate(percentage_expressing = round(`TRUE` / (`FALSE`+`TRUE`) * 100,1))

# CXCL13 expression in control samples
data.frame(colData(sce_rna)) %>%
  filter(Location == "CTRL") %>%
  group_by(CXCL13, TissueType) %>%
  summarise(n=n()) %>%
  reshape2::dcast(TissueType ~ CXCL13, value.var = "n", fill = 0) %>%
  mutate(percentage_expressing = round(`1` / (`0`+`1`) * 100,1))

# CXCL13 expression in tumor samples
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  group_by(CXCL13, MM_location) %>%
  summarise(n=n()) %>%
  reshape2::dcast(MM_location ~ CXCL13, value.var = "n", fill = 0) %>%
  mutate(percentage_expressing = round(`1` / (`0`+`1`) * 100,1))

# CXCL10 expression in control samples
data.frame(colData(sce_rna)) %>%
  filter(Location == "CTRL") %>%
  group_by(CXCL10, TissueType) %>%
  summarise(n=n()) %>%
  reshape2::dcast(TissueType ~ CXCL10, value.var = "n", fill = 0) %>%
  mutate(percentage_expressing = round(`1` / (`0`+`1`) * 100,1))

# CXCL10 expression in tumor samples
data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  group_by(CXCL10, MM_location) %>%
  summarise(n=n()) %>%
  reshape2::dcast(MM_location ~ CXCL10, value.var = "n", fill = 0) %>%
  mutate(percentage_expressing = round(`1` / (`0`+`1`) * 100,1))
```

