---
title: "Supp-Figure_4"
author: ""
date: "2020-11-18"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction
This script generates plots for Supplementary Figure 4.

# Preparations

## Load libraries

First, we will load the libraries needed for this part of the analysis.

```{r, message=FALSE}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(SingleCellExperiment)
library(reshape2)
library(tidyverse)
library(dplyr)
library(data.table) 
library(ggplot2)
library(ComplexHeatmap)
library(rms)
library(ggrepel)
library(ggbeeswarm)
```

## Read the data

```{r}
sce_rna = readRDS(file = "data/sce_RNA.rds")
sce_prot = readRDS(file = "data/sce_protein.rds")

# meta data
dat_survival = fread(file = "data/survdat_for_modelling.csv",stringsAsFactors = FALSE)
dat_inflammation = fread(file = "data/manual_infiltration_scoring_BlockID.csv", header = TRUE)
```

# Cytotoxic T cell abundance per BlockID

## Barplot with Clinical Annotation 

```{r Supp_Fig_4A_barplot_clinical_annotation, dev=c('pdf'), fig.height=10, fig.width=15}
# cytotoxic density scoring per BlockID (mean over images)
cur_sce <- data.frame(colData(sce_prot)) %>%
  group_by(BlockID) %>%
  mutate(cyto_density_block = mean(cyotoxic_density_image))

# add manual scoring for tumor core (highest scoring)
cur_sce <- left_join(cur_sce, dat_inflammation[,c("BlockID", "highest_scoring")])

sce_prot$manual_scoring_core <- cur_sce$highest_scoring
sce_prot$cytotoxic_density_block <- cur_sce$cyto_density_block

set.seed(362)
patient_meta <- data.frame(BlockID = sce_prot$BlockID,
                     Tcell_score = sce_prot$T_frac_score_per_BlockID,
                     cytotoxic_density_block = sce_prot$cytotoxic_density_block,
                     Death = sce_prot$Death,
                     treatment_status_before_surgery = sce_prot$treatment_status_before_surgery,
                     relapse = sce_prot$relapse,
                     manual_scoring_core = sce_prot$manual_scoring_core)

# remove control and bad images
patient_meta <- patient_meta %>%
  filter(manual_scoring_core != "no assessment possible" & relapse != "control") %>%
  distinct(BlockID, .keep_all = TRUE)

# construct matrix with fractions and sort from lowest to highest  
matrixrownames <- as.character(patient_meta$BlockID)
m <- as.matrix(patient_meta$cytotoxic_density_block)
rownames(m) <- matrixrownames
m <- m[order(m[,1]),]

# construct color vector for Tcell score

# plot Fractions as barplot
ha <- rowAnnotation(`Mean Cytotoxic T cells / mm2` = anno_barplot(m,gp=gpar(fill="grey"),
                                                                   bar_width = 1,
                                                                   height = unit(30,"cm"),
                                                                   width = unit(15,"cm"),
                                                                   show_row_names =FALSE))
# create patient_meta matrix
mrownames <- patient_meta$BlockID 
patient_meta_matrix <- as.matrix(patient_meta)
rownames(patient_meta_matrix) <- mrownames
patient_meta_matrix <- patient_meta_matrix[names(m),]

# heatmap consisting of BlockIDs
h1 = Heatmap(patient_meta_matrix[,"Death"],
             col = structure(c("gainsboro", "deepskyblue"), names = c("no", "yes")),
             width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = FALSE, 
             heatmap_legend_param = list(title = "Death"),
             show_row_names = FALSE,
             column_labels = "Death")

h2 = Heatmap(patient_meta_matrix[,"treatment_status_before_surgery"], 
             col = structure(c("gainsboro", "deepskyblue"), names = c("naive", "non-naive")),
             width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = FALSE,
             heatmap_legend_param = list(title = "Treatment Status before Surgery"),
             show_row_names = FALSE,
             column_labels = "Treatment Status")

h3 = Heatmap(patient_meta_matrix[,"relapse"], 
             col = structure(c("gainsboro", "deepskyblue", "black"), names = c("no relapse", "relapse", "untreated/lost")),
             width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             show_heatmap_legend = FALSE,
             heatmap_legend_param = list(title = "Relapse Status"),
             show_row_names = FALSE,
             column_labels = "Relapse")

h4 = Heatmap(patient_meta_matrix[,"manual_scoring_core"], 
             col = structure(c("grey", "greenyellow", "indianred1", "green4", "indianred4"), 
                             names = c("deserted", "low-inflamed", "low-excluded", "high-inflamed", "high-excluded")),
             width = unit(0.5, "cm"), 
             height = unit(30, "cm"),
             heatmap_legend_param = list(title = "Scoring Tumor Core"),
             show_row_names = FALSE,
             column_labels = "Scoring Tumor Core",
             right_annotation =  ha,
             show_heatmap_legend = FALSE)

ht = grid.grabExpr(draw(h2+h3+h1+h4))
grid.newpage()
pushViewport(viewport(angle = 270))
grid.draw(ht)
```

```{r Supp_Fig_4A_legend, dev=c("pdf")}
# create legend for tumor subclusters
lgd1 = Legend(labels = c("deserted", "low-inflamed", "low-excluded", "high-inflamed", "high-excluded"), 
              title = "Scoring Tumor Core", 
              ncol = 2,
              legend_gp = gpar(fill = c("grey", "greenyellow", "indianred1", "green4", "indianred4")))

lgd2 = Legend(labels = c("no relapse", "relapse", "untreated/lost"), 
              title = "Relapse Status", 
              legend_gp = gpar(fill = c("gainsboro", "deepskyblue", "black")))

lgd3 = Legend(labels = c("naive", "non-naive"), 
              title = "Treatment Status", 
              legend_gp = gpar(fill = c("gainsboro", "deepskyblue")))
 
lgd4 = Legend(labels = c("no", "yes"), 
              title = "Death", 
              legend_gp = gpar(fill = c("gainsboro", "deepskyblue")))


# Draw Legend
draw(packLegend(lgd2, lgd3, lgd4, lgd1, column_gap = unit(0.5, "cm"),
                max_height = unit(2, "cm")))
```

## Define Tcytotoxic density per Image

```{r}
# cytotoxic density per image
frac <- data.frame(colData(sce_rna)) %>%
  distinct(ImageNumber, .keep_all = TRUE) %>%
  group_by(BlockID) %>%
  mutate(cyto_density_block = mean(cyotoxic_density_image)) %>%
  distinct(BlockID, cyto_density_block)

names(dat_survival)[3] <- "BlockID"

frac <- left_join(frac[,c("BlockID", "cyto_density_block")], dat_survival)

#
frac$number_of_treatments_before_grouping <- ifelse(frac$Number.of.treatments.before.surgery == 0, "naive", "non-naive")
```

## Cox Proportional Hazard Model
The (mean) density score per Block is "restricted cubic spline" (rcs) transformed which is used for non-linear continuous predictive variables (in this case Cytotoxic T cell density). 

```{r Hazard_Ratio , dev=("pdf"), fig.width=14, fig.height=4}
dd <- datadist(frac)
options(datadist="dd")

cph_rcs <- cph(formula = Surv(time = Time_to_death_or_last_PET, event = censoring_death) ~ 
                      rcs(cyto_density_block,3) + 
                      number_of_treatments_before_grouping, 
                    x = TRUE, y = TRUE, data = frac)

summary <- as.data.frame(summary(cph_rcs))
rownames(summary) <- c("Cytotoxic T Cell Density", "Hazard-Ratio Density", "Treatment Status", "Hazard-Ratio Treatment")
dat <- summary[summary$Type == 2,]
dat$var <- c("Cytotoxic T Cell Density", "Treatment Status")

densityRange <- paste(paste(round(dat$High[1]), round(dat$Low[1]), sep = ":"), "cells/mm2", sep = " ")

y_axis1 <- paste(paste(dat$var[1], 
                 paste("CI95", paste(round(dat$`Lower 0.95`,2)[1], round(dat$`Upper 0.95`,2)[1], sep = " - "), sep = " "),
                 sep = "\n"), 
                 densityRange , sep = "\n")
y_axis2 <- paste(paste(dat$var[2], 
                 paste("CI95", paste(round(dat$`Lower 0.95`,2)[2], round(dat$`Upper 0.95`,2)[2], sep = " - "), sep = " "),
                 sep = "\n"), 
                 paste("non-naive", "naive", sep = ":") , sep = "\n")

ggplot(dat,aes(x=Effect, y=var, label=round(Effect,2))) +
  geom_point(size=10) +
  geom_errorbar(mapping=aes(y=var, xmin=`Lower 0.95`, xmax=`Upper 0.95`), 
                width=0.2, 
                size=2, 
                color="deepskyblue") +
  geom_label_repel(box.padding = 5, size=10) +
  geom_vline(xintercept = 1) +
  theme_bw() +
  theme(text=element_text(size=20)) + 
  ylab("") + 
  xlab("Hazard Ratio") +
  scale_y_discrete(labels= c(y_axis1, y_axis2)) +
  scale_x_log10()
```

# Subpopulations

## CD8 Subcluster Differences

```{r Supp_Fig_4B_CD8_Subcluster, dev=c("pdf"), fig.width=7}
plotCellFractions(sce_prot[,sce_prot$manual_scoring %in% c("high-inflamed", "high-excluded")], 
                  imageID = "ImageNumber", 
                  celltype_column = "celltype_clustered", 
                  celltype_subsets = unique(sce_prot[,sce_prot$celltype == "Tcytotoxic"]$celltype_clustered),
                  split_by = "manual_scoring",
                  facet_wrap = TRUE) +
  guides(fill=guide_legend("CD8+ Subcluster")) + 
  theme(text = element_text(size=18))
```

## Marker Profile of CD8 Cells 

```{r Supp_Fig_4B_CD8_Marker, dev=c("pdf"), fig.height=7}
cur_sce <- sce_prot[,sce_prot$manual_scoring %in% c("high-excluded", "high-inflamed") & sce_prot$celltype == "Tcytotoxic"]

cyto_marker <- c("H3K27me3", "GrzB", "Ki67", "ICOS", "TOX1", "TCF7", "CD45RO", "PD1", "pS6")

cyot_dat <- data.frame(t(assay(cur_sce[cyto_marker,], "asinh")))
cyot_dat$cellID <- rownames(cyot_dat)
cyot_dat <- left_join(cyot_dat, data.frame(colData(sce_prot))[,c("cellID", "manual_scoring")])

# melt
cyot_dat <- cyot_dat %>%
  reshape2::melt(id.vars = c("cellID", "manual_scoring"), variable.name = "channel", value.name = "asinh")

ggplot(cyot_dat, aes(x=manual_scoring, y=asinh, fill=manual_scoring)) + 
  geom_boxplot(alpha=0.2) +
  geom_violin(alpha=0.1) +
  theme_bw() +
  theme(text = element_text(size=20),
        legend.position = "none",
        axis.text.x = element_text(angle=90),) +
  facet_wrap(~channel) +
  xlab("") + 
  ylab("Mean Count per Cell (asinh)")
```

## Macrophage Subclusters

```{r Supp_Fig_4C_Macrophage_Subcluster, dev=c("pdf"), fig.width=7}
plotCellFractions(sce_prot[,sce_prot$manual_scoring %in% c("high-inflamed", "high-excluded")], 
                  imageID = "ImageNumber", 
                  celltype_column = "celltype_clustered", 
                  celltype_subsets = unique(sce_prot[,sce_prot$celltype == "Macrophage"]$celltype_clustered),
                  split_by = "manual_scoring",
                  facet_wrap = TRUE) +
  guides(fill=guide_legend("Macrophage Subcluster")) + 
  theme(text = element_text(size=18))
```

## Marker Profile of Macrophages  

```{r Supp_Fig_4C_Macrophage_Marker, dev=c("pdf"), fig.height=7}
cur_sce <- sce_prot[,sce_prot$manual_scoring %in% c("high-excluded", "high-inflamed") & sce_prot$celltype == "Macrophage"]

cyto_marker <- c("CD11b", "PDL1", "pS6", "CD11c", "CD68", "Ki67", "CD206", "HLADR")

cyot_dat <- data.frame(t(assay(cur_sce[cyto_marker,], "asinh")))
cyot_dat$cellID <- rownames(cyot_dat)
cyot_dat <- left_join(cyot_dat, data.frame(colData(sce_prot))[,c("cellID", "manual_scoring")])

# melt
cyot_dat <- cyot_dat %>%
  reshape2::melt(id.vars = c("cellID", "manual_scoring"), variable.name = "channel", value.name = "asinh")

ggplot(cyot_dat, aes(x=manual_scoring, y=asinh, fill=manual_scoring)) + 
  geom_boxplot(alpha=0.2) +
  geom_violin(alpha=0.1) +
  theme_bw() +
  theme(text = element_text(size=20),
        legend.position = "none",
        axis.text.x = element_text(angle=90),) +
  facet_wrap(~channel) +
  xlab("") + 
  ylab("Mean Count per Cell (asinh)")
```

