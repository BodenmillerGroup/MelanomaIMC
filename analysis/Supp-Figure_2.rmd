---
title: "Supplementary Figure 2"
author: "Tobias Hoch and Daniel Schulz"
date: "2020-10-13"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction
This script generates plots for Supplementary Figure 2.

# Preparations

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Load libraries

```{r load libraries}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(data.table)
library(survival)
library(ggplot2)
library(broom)
library(dplyr)
library(RColorBrewer)
library(ggalluvial)
library(tidyverse)
library(cowplot)
library(ggbeeswarm)
library(gridExtra)
library(SingleCellExperiment)
library(scater)
library(cba)
library(ComplexHeatmap)
library(reshape2)
library(rms)
library(ggrepel)
library(circlize)
library(coxme)
library(rstatix)
library(ggpubr)
```

## Load Data

```{r}
# clinical data
dat <- read_csv("data/data_for_analysis/protein/clinical_data_protein.csv")

# SCE object
sce_prot = readRDS(file = "data/data_for_analysis/sce_protein.rds")
sce_rna = readRDS(file = "data/data_for_analysis/sce_RNA.rds")

targets <- metadata(sce_rna)$chemokines_morethan600_withcontrol
```

# Supp Figure 2B

## Clinical features of the cohort 

Note: as the cohort is very diverse, we are using the BlockID as the minimal unit since clinical parameters are described per BlockID. However, sometimes we do have patients of which we have multiple FFPE blocks (BlockIDs). Nonetheless, clinical parameters are not given per patient but per patient FFPE block and are therefore considered the minimial unit.

## Number of Samples

```{r Supp_Fig_2B_number_of_samples, fig.height=6, fig.width=15, dev=c('pdf')}
dat[dat$BlockID %in% unique(sce_prot[,sce_prot$Location == "CTRL"]$BlockID),]$MM_location <- "Control"

# remove control samples
dat <- dat[dat$BlockID %in% unique(sce_prot[,sce_prot$Location != "CTRL"]$BlockID),]

p1 <- unique(dat[,c("BlockID","MM_location")]) %>%
  ggplot()+
  geom_bar(aes(y=MM_location),stat ="count") +
  xlab("BlockIDs per Location") +
  ylab("Metastasis Location") +
  theme_bw()+
  theme(text = element_text(size=16))
  
p2 <- dat %>%
  ggplot()+
  geom_bar(aes(x=BlockID, fill=(MM_location)),stat="count")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 90,vjust = 0.5)) + 
  ylab("Number of Samples") +
  guides(fill=guide_legend(title="Metasis Location")) +
  theme(text = element_text(size=16),
        axis.text.x = element_text(size=7))

plot_grid(p1,p2,rel_widths = c(1.25,3))  
```

# Supp Figure 2C

## Patients per Location

```{r}
sce_rna$MM_location <- ifelse(sce_rna$MM_location %in% c("skin", "skin_undefine"), "skin_undefined", sce_rna$MM_location)

groups <- data.frame(colData(sce_rna)) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(MM_location) %>%
  distinct(PatientID, .keep_all = T) %>%
  summarise(n=n()) %>%
  filter(n>=10) %>%
  arrange(-n)
```

## Boxplot/Barplot per Location for every chemokine combination

```{r}
fractions_per_image <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, MM_location, expressor, celltype) %>%
  summarise(n = n()) %>%
  group_by(ImageNumber) %>%
  mutate(fraction_per_image = n / sum(n)) %>%
  group_by(ImageNumber, expressor) %>%
  mutate(group_fraction = sum(fraction_per_image)) %>%
  ungroup() %>%
  filter(expressor %in% targets & MM_location %in% groups$MM_location)

# fraction of expressor cells per image 
fraction_expressor_per_image <- fractions_per_image %>%
  distinct(ImageNumber, MM_location, expressor, .keep_all = T) %>%
  reshape2::dcast(ImageNumber + MM_location ~ expressor, value.var = "group_fraction", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber", "MM_location"), variable.name = "expressor", 
                 value.name = "fraction_per_image")

# fraction of celltype expressing a certain combi per image
celltype_fractions <- fractions_per_image %>%
  distinct(ImageNumber, celltype, expressor, .keep_all = T) %>%
  reshape2::dcast(ImageNumber + MM_location + expressor ~ celltype, value.var = "fraction_per_image", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber", "MM_location", "expressor"), 
                 variable.name = "celltype", value.name = "fraction_per_image") %>%
  reshape2::dcast(ImageNumber + MM_location + celltype ~ expressor, value.var = "fraction_per_image", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber", "MM_location", "celltype"), 
                 variable.name = "expressor", value.name = "fraction_per_image") %>%
  group_by(MM_location, expressor, celltype) %>%
  summarise(sum_fraction = sum(fraction_per_image)) %>% # sum-up fractions over all images 
  group_by(MM_location, expressor) %>%
  mutate(proportions = sum_fraction / sum(sum_fraction)) # calculate proportions for each expressor

#median_celltype_fraction <- fractions_per_image %>%
  #distinct(ImageNumber, celltype, expressor, .keep_all = T) %>%
  #reshape2::dcast(ImageNumber + MM_location + expressor ~ celltype, value.var = "fraction_per_image", fill = 0) %>%
  #reshape2::melt(id.vars = c("ImageNumber", "MM_location", "expressor"), 
                 #variable.name = "celltype", value.name = "fraction_per_image") %>%
  #reshape2::dcast(ImageNumber + MM_location + celltype ~ expressor, value.var = "fraction_per_image", fill = 0) %>%
  #reshape2::melt(id.vars = c("ImageNumber", "MM_location", "celltype"), 
                 #variable.name = "expressor", value.name = "fraction_per_image") %>%
  #group_by(MM_location, expressor, celltype) %>%
  #summarise(median_fraction = median(fraction_per_image)) %>%
  #group_by(MM_location, expressor) %>%
  #mutate(proportions = median_fraction / sum(median_fraction))
```

## Plot

```{r Supp_Fig_2C_expression_per_location, dev=c('pdf')}
plot_list <- list()
for(i in groups$MM_location) {
  a <- fraction_expressor_per_image %>%
    filter(MM_location == i) %>%  
    group_by(ImageNumber, expressor) %>%
    ggplot(., aes(y=expressor, x=fraction_per_image)) + 
    geom_boxplot() + 
    geom_point(alpha=0.2) +
    theme_bw() +
    theme(axis.title.y = element_blank(),
          axis.text.y = element_text(hjust=0.5)) +
    #scale_x_log10() +
    #annotation_logticks(sides = "bottom") + 
    xlab("Cell Fraction per Image") + 
    coord_cartesian(xlim = c(0,0.05))
  
  b <- celltype_fractions %>%
    filter(MM_location == i) %>%  
    ggplot(., aes(y=expressor, x=-proportions, fill=celltype)) + 
    geom_bar(stat = "identity") +
    theme_bw() +
    theme(axis.text.y = element_blank(),
          axis.title.y = element_blank(),
          legend.position = "none") +
    xlab("Producing Cell Types") +
          scale_fill_manual(values = unname(metadata(sce_rna)$colour_vectors$celltype),
                        breaks = names(metadata(sce_rna)$colour_vectors$celltype),
                        labels = names(metadata(sce_rna)$colour_vectors$celltype)) +
    scale_x_continuous(breaks=c(-1.00,-0.75,-0.5, -0.25, 0.00),
                     labels=c("100%", "75%", "50%", "25%", "0%"))
  
  grid.arrange(b,a,nrow=1,
               widths = c(.75,1),
               top = i)
}
```

# Supp Figure 2D

## Expressor in MM_location

```{r Supp_Fig_2D_expressor_per_location, fig.width=10, fig.height=5, dev=("pdf")}
# add control location to sce
sce_rna$MM_location_simplified2 <- sce_rna$MM_location_simplified
sce_rna[,sce_rna$Location == "CTRL" & sce_rna$TissueType == "Skin"]$MM_location_simplified2 <- "control skin"
sce_rna[,sce_rna$Location == "CTRL" & sce_rna$TissueType == "Lymphnode"]$MM_location_simplified2 <- "control LN"
sce_rna[,sce_rna$Location == "CTRL" & sce_rna$TissueType == "PSO"]$MM_location_simplified2 <- "control psoriasis"

frac <- data.frame(colData(sce_rna)) %>%
  filter(MM_location_simplified2 != "control psoriasis") %>%
  group_by(Description, MM_location_simplified2, expressor) %>%
  summarise(n=n()) %>%
  mutate(fraction = n / sum(n)) %>%
  filter(expressor %in% targets) %>%
  reshape2::dcast(Description + MM_location_simplified2 ~ expressor, value.var = "fraction", fill = 0) %>%
  reshape2::melt(id.vars = c("Description", "MM_location_simplified2"), variable.name = "expressor", value.name = "fraction")

ggplot(frac, aes(x=expressor, y = fraction, fill = MM_location_simplified2)) + 
  geom_boxplot(alpha=1, outlier.size = 0.5) +
  #geom_jitter(size = 0.75, alpha=0.6, position = position_jitterdodge(dodge.width = 0.75,jitter.width = 0.05), aes(col=MM_location_simplified2)) + 
  scale_color_discrete(guide=FALSE) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + 
  guides(fill=guide_legend(title="Met Location", override.aes = aes(lwd=0.5))) +
  xlab("") + 
  ylab("Fractions") +
  coord_cartesian(ylim = c(0,0.075))
```

# Supp Figure 2E

## Mutation

```{r Supp_Fig_2E_mutation, dev=c('pdf'), fig.width=12, fig.height=6.35}
targets <- metadata(sce_rna)$chemokines_morethan600_withcontrol

# subset sce_rna
group_size <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, Mutation) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(Mutation) %>%
  summarise(n=n()) %>%
  filter(n>10 & Mutation != "")

sce_rna_sub <- sce_rna[,sce_rna$Mutation %in% group_size$Mutation]

a <- plotCellCounts(sce = sce_rna_sub, 
                    sce_sub = sce_rna_sub[,which(sce_rna_sub$expressor %in% targets)],
                    cellID = "cellID",
                    colour_by = "expressor",
                    split_by = "Mutation",
                    imageID = "ImageNumber",
                    normalize = TRUE,
                    show_n = FALSE,
                    colour_vector = metadata(sce_rna)$colour_vectors$chemokine_combinations) + 
  guides(fill=guide_legend("Chemokine")) +
  theme(text = element_text(size=16))

b <- plotCellCounts(sce = sce_rna_sub[,which(sce_rna_sub$expressor %in% targets)],
                    cellID = "cellID",
                    colour_by = "celltype",
                    split_by = "Mutation",
                    imageID = "ImageNumber",
                    proportion = TRUE,
                    show_n = FALSE,
                    colour_vector = metadata(sce_rna)$colour_vectors$celltype) + 
  guides(fill=guide_legend("Cell Type")) +
  theme(text = element_text(size=16))

# fraction of chemokine-expressing cells per image
t <- data.frame(colData(sce_rna_sub)) %>%
  group_by(ImageNumber, Mutation, chemokine, MM_location_simplified) %>%
  summarise(n=n()) %>%
  group_by(ImageNumber) %>%
  mutate(fraction = n / sum(n)) %>%
  reshape2::dcast(ImageNumber + Mutation + MM_location_simplified ~ chemokine, value.var = "fraction")

median_expression <- median(t$`TRUE`)

stat.test <- t %>%
  group_by(Mutation) %>%
  t_test(data = ., mu = median_expression, `TRUE` ~ 1, alternative = "greater") %>%
  adjust_pvalue(method="BH") %>%
  add_significance() %>%
  add_x_position(x = "Mutation", dodge = 0.8)

c <- ggplot(t, aes(x=Mutation, y=`TRUE`)) + 
  geom_boxplot(alpha=0.2, lwd=1.5) + 
  geom_quasirandom(aes(col=MM_location_simplified), size=2, alpha=.8) +
  geom_hline(yintercept = median_expression, linetype=2, size=2) + 
  stat_pvalue_manual(stat.test, x = "x", label = "p.adj.signif", size = 7, y.position = 0.3) + 
  xlab("") + 
  ylab("Fraction of Chemokine-Expressing Cells") +
  theme_bw() +
  theme(text = element_text(size=16),
        axis.text.x = element_text(angle=45, hjust=1, vjust=1)) +
  guides(col=guide_legend("Location")) +
  coord_cartesian(ylim=c(0,0.3))

grid.arrange(a,b,c,nrow=1,
             widths = c(1,1,1))

# MM_location for Mutations
data.frame(colData(sce_rna_sub)) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(Mutation, MM_location_simplified) %>%
  summarise(n=n()) %>%
  group_by(Mutation) %>%
  mutate(percentage = n / sum(n) * 100)
```
