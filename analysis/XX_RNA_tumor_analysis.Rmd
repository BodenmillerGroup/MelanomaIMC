---
title: "XX_RNA_tumor_analysis"
author: "toobiwankenobi"
date: "2020-10-02"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Preparations

## Load packages and helper functions

```{r message=F}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(SingleCellExperiment)
library(ggplot2)
library(reshape2)
library(cowplot)
library(dplyr)
library(gridExtra)
library(ggpmisc)
library(survival)
library(survminer)
library(scater)
library(dittoSeq)
library(tidyr)
library(data.table)
library(stringr)
library(grDevices)
```

## Load data

```{r load data}
sce_rna = readRDS(file = "data/sce_rna.rds")
```

# Tumor Analysis

## Tumor Markers in Samples with CXCL13+CD8+ cells (dysfunctional T cells)

```{r}
cur_df <- data.frame(colData(sce_rna)) %>%
  filter(celltype == "Tcytotoxic" & Location != "CTRL") %>%
  group_by(Description,T_frac_score_per_ImageNumber, CXCL13, celltype, BlockID) %>%
  summarise(n=n()) %>%
  reshape2::dcast(Description + T_frac_score_per_ImageNumber + celltype + BlockID ~ CXCL13, value.var = "n", fill = 0) %>%
  mutate(cxcl13_cyto_fraction = `1` / (`0` + `1`))

# cxcl13 score
cur_df$cxcl13_score <- ""
cur_df$cxcl13_score <- ifelse(cur_df$T_frac_score_per_ImageNumber %in% c("med", "high") & cur_df$cxcl13_cyto_fraction > 0.05 & cur_df$`1` > 20, "CXCL13+", "CXCL13-")

tumor_dat <- data.frame(t(assay(sce_rna["B2M", sce_rna$celltype == "Tumor" & sce_rna$Location != "CTRL"], "asinh")))
tumor_dat$cellID <- rownames(tumor_dat)
tumor_dat <- left_join(tumor_dat, data.frame(colData(sce_rna))[,c("cellID", "Description")])

# left_join with scoring data
tumor_dat <- left_join(tumor_dat, cur_df[,c("Description", "T_frac_score_per_ImageNumber", "cxcl13_score")])

# images with no Tcytoxotic cells
tumor_dat[is.na(tumor_dat$T_frac_score_per_ImageNumber), ]$T_frac_score_per_ImageNumber <- "low"
tumor_dat[is.na(tumor_dat$cxcl13_score), ]$cxcl13_score <- "CXCL13-"

tumor_dat$T_frac_score_per_ImageNumber <- factor(tumor_dat$T_frac_score_per_ImageNumber, levels = c("low", "med", "high"))

# boxplot
ggplot(tumor_dat, aes(x=T_frac_score_per_ImageNumber, y=B2M, fill=cxcl13_score)) + 
  geom_boxplot() +
  theme(text = element_text(size=20)) +
  guides(fill=guide_legend(title="CXCL13 Scoring")) +
  xlab("Cytotoxic T cell Score per Image") + 
  ylab("Mean B2M in Tumor Cells (asinh)")
```

Clearly, B2M expression on tumor cells is associated with cytotoxic T cell infiltration and potentialy also with the abundance of dysfunctinal cytotoxic T cells. 

## Tumor Markers and Cancer Stage

```{r}
tumor_dat <- data.frame(t(assay(sce_rna["S100", sce_rna$celltype == "Tumor" & sce_rna$Location != "CTRL"], "asinh")))
tumor_dat$cellID <- rownames(tumor_dat)
tumor_dat <- left_join(tumor_dat, data.frame(colData(sce_rna))[,c("cellID", "Cancer_Stage")])

ggplot(tumor_dat, aes(x=Cancer_Stage, y=S100)) + 
  geom_boxplot() +
  theme(text = element_text(size=20)) +
  xlab("Cancer Stage") + 
  ylab("Mean B2M in Tumor Cells (asinh)")
```

## Correlation with mean B2M expression and T cell density

```{r}
tumor_dat <- data.frame(t(assay(sce_rna["B2M", sce_rna$celltype == "Tumor" & sce_rna$Location != "CTRL"], "asinh")))
tumor_dat$Description <- sce_rna[, sce_rna$celltype == "Tumor" & sce_rna$Location != "CTRL"]$Description

tumor_dat <- tumor_dat %>%
  group_by(Description) %>%
  summarise(mean_B2M = mean(B2M))

cur_df <- data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  group_by(Description, celltype, BlockID) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  complete(Description, celltype, fill = list(n = 0)) %>%
  filter(celltype == "Tcytotoxic")

tumor_dat <- left_join(tumor_dat, cur_df)

# boxplot
ggplot(tumor_dat, aes(y=mean_B2M, x=log10(n+1))) + 
  geom_point() +
  geom_smooth(method = "lm") +
  stat_poly_eq(formula = y ~ x, 
                aes(label =  ..rr.label..), 
                parse = TRUE) +
  ylab("Mean B2M Expression on Tumor Cells per Image (asinh)") +
  xlab("Number of Cytotoxic T cells per Image (log10+1)") +
  theme(text = element_text(size=20))
```

## Check Survival of Patients with B2M high tumors

```{r}
# create CXCL13+ per BlockID
block_score <- tumor_dat %>%
  group_by(BlockID) %>% 
  summarise(mean_B2M_block = mean(mean_B2M)) %>%
  mutate(block_score = ifelse(mean_B2M_block > 2, "B2M_high", "B2M_low")) %>%
  mutate(Block.ID = BlockID)

data <- read.csv("data/survdat_for_modelling.csv")

data_sub <- data#[data$number_of_treatments_before_grouping == "naive",]

# add block score
data_sub <- left_join(data_sub, block_score[,c("Block.ID", "block_score")])

data_sub$block_score <- factor(data_sub$block_score, levels = c("B2M_low", "B2M_high"))

fit <- survfit(Surv(time = Time_to_.progression_or_last_PET, event = censoring_progression) ~ 
                 block_score, data = data_sub)

fit <- coxph(Surv(time = Time_to_.progression_or_last_PET, event = censoring_progression) ~ 
               block_score,
             data = data_sub)
ggforest(fit, data=data_sub)
```

# Tumor and Chemokine Analysis

## UMAP 

```{r UMAP_chemokine_tumor, dev=('pdf'), fig.width=8, fig.height=6}
tumor_chemokine <- data.frame(colData(sce_rna[, sce_rna$celltype == "Tumor" & sce_rna$chemokine == 1]))[,"cellID"]
control_tumor <- data.frame(colData(sce_rna[, sce_rna$celltype == "Tumor" & sce_rna$chemokine == 0]))

# sample same amount of control tumor cells
control_tumor <- control_tumor[sample(nrow(control_tumor), length(tumor_chemokine)), "cellID"]
cur_sce <- sce_rna[,sce_rna$cellID %in% cbind(tumor_chemokine, control_tumor)]

# tumor marker
tumor_marker <- c("HLADR", "S100", "B2M", "GLUT1", "SOX10", "Mart1", "pRB", "cleavedPARP")

# UMAP
cur_sce <- runUMAP(cur_sce, exprs_values = "asinh", 
               subset_row = (rownames(cur_sce) %in% tumor_marker),
               n_neighbors = 10)

# plot UMAP
a <- dittoDimPlot(cur_sce,
             reduction.use = "UMAP",
             var = "chemokine", 
             size = 2,
             legend.show = TRUE,
             opacity = 0.5,
             max.color = "red", min.color = "azure3",
             main = NULL) +
    theme_minimal() +
    theme(text = element_text(size=25)) +
    guides(color = guide_legend(override.aes = list(alpha=1, size=5))) +
    guides(fill=guide_legend("Chemokine"))

# plot marker on UMAP
p.list <- list()
for(i in tumor_marker){
  p.list[[i]] <- dittoDimPlot(cur_sce, i, size = 1, assay = "asinh")
}

b <- plot_grid(plotlist = p.list, ncol = 2)

grid.arrange(a,b, ncol = 2)
```

It seems that HLADR and B2M is elevated in cells that produce chemokines. Lets check this with a boxplot.

```{r boxplot_HLADR_B2M, dev=('pdf'), fig.width=8, fig.height=6}
cur_sce <- sce_rna[,sce_rna$cellID %in% cbind(tumor_chemokine, control_tumor)]

tumor_dat <- data.frame(t(assay(cur_sce["HLADR", cur_sce$celltype == "Tumor" & cur_sce$Location != "CTRL"], "asinh")))
tumor_dat$cellID <- rownames(tumor_dat)
tumor_dat <- left_join(tumor_dat, data.frame(colData(sce_rna))[,c("cellID", "chemokine")])

a <- ggplot(tumor_dat, aes(x=chemokine, y=HLADR)) + 
  geom_boxplot() +
  theme(text = element_text(size=20)) +
  xlab("Chemokine Production in Tumor Cells") + 
  ylab("Mean HLA-DR in Tumor Cells (asinh)")

tumor_dat <- data.frame(t(assay(cur_sce["B2M", cur_sce$celltype == "Tumor" & cur_sce$Location != "CTRL"], "asinh")))
tumor_dat$cellID <- rownames(tumor_dat)
tumor_dat <- left_join(tumor_dat, data.frame(colData(sce_rna))[,c("cellID", "chemokine")])

b <- ggplot(tumor_dat, aes(x=chemokine, y=B2M)) + 
  geom_boxplot() +
  theme(text = element_text(size=20)) +
  xlab("Chemokine Production in Tumor Cells") + 
  ylab("Mean B2M in Tumor Cells (asinh)")

grid.arrange(a,b, ncol =2)
```

Clearly, chemokine+ tumor cells have a different marker profile than chemokine- cells. What does this mean biologically? Do they really produce chemokines or is this tumor profile associated with immune cell infiltration and upon contact with a tumor cell with chemokine expression? Maybe the expression happens in vicinicty to tumor cells and tumor cells are then falsely detected as chemokine+ cell. We can check this if we look at direct neighbours of chemokine+ cells. 

## Neighbourhood of chemokine+ tumor cells

```{r}
dat_relation = fread(file = "data/rna/Object relationships.csv",stringsAsFactors = FALSE)

dat_relation$cellID_first <- paste("RNA", paste(dat_relation$`First Image Number`, dat_relation$`First Object Number`, sep = "_"), sep = "_")
dat_relation$cellID_second <- paste("RNA", paste(dat_relation$`Second Image Number`, dat_relation$`Second Object Number`, sep = "_"), sep = "_")

# only chemokine+ tumor cells as first object
dat_relation_sub <- dat_relation[dat_relation$cellID_first %in% tumor_chemokine,]
interacting_cells <- dat_relation_sub$cellID_second

data.frame(colData(sce_rna[,sce_rna$cellID %in% interacting_cells])) %>%
  group_by(celltype, chemokine) %>%
  summarise(n=n()) %>%
  reshape2::dcast(celltype ~ chemokine, value.var = "n", fill=0) %>%
  mutate(percentage_chemokine = round(`TRUE` / (`FALSE` + `TRUE`)*100,1))

# subset relation table
dat_relation_sub <- dat_relation[dat_relation$cellID_first %in% tumor_chemokine,]
interacting_cells <- dat_relation_sub$cellID_second

data.frame(colData(sce_rna[,sce_rna$cellID %in% interacting_cells])) %>%
  group_by(celltype, chemokine) %>%
  summarise(n=n()) %>%
  reshape2::dcast(celltype ~ chemokine, value.var = "n", fill=0) %>%
  mutate(percentage_chemokine = round(`TRUE` / (`FALSE` + `TRUE`)*100,1))
```

## What kind of chemokine do the neighbouring cells "produce"? 
If it is a different chemokine, than we know that tumor cells really produce a certain chemokine. Alternatively, we could also only take tumor cells that produce a chemokine but not its neighbours as "ground truth" for analyses such as marker expression comparison etc. 

```{r}
cur_df <- colData(sce_rna)
cur_df <- as_tibble(cur_df)
cur_df <- cur_df[,grepl("CCL|CXCL|Dap",colnames(cur_df))]

for(i in colnames(cur_df)){
  cur_df[[i]] <- ifelse(cur_df[[i]]== 1,i,"NA")
}

cur_df <- cur_df %>%
  unite(expressor,sep = "_",na.rm =TRUE,remove=FALSE)

cur_df$expressor <- gsub("NA_","",cur_df$expressor)
cur_df$expressor <- gsub("_NA","",cur_df$expressor)

# summary table of all combinations
summary_cur_df <- table(cur_df$expressor)

# order table according to abundance of combinations
summary_cur_df<- summary_cur_df[order(-as.numeric(summary_cur_df))]

# combinations with more than 600 occurrences
targets <- names(which(summary_cur_df > 600))
targets <- targets[!targets == "NA"]

# add expressor info to sce object
sce_rna$expressor <- cur_df$expressor
```


```{r}
dat_relation_sub <- dat_relation[dat_relation$cellID_first %in% tumor_chemokine,]
dat_relation_sub <- dat_relation_sub[!(dat_relation_sub$cellID_second %in% tumor_chemokine),]
dat_relation_sub <- dat_relation_sub[dat_relation_sub$cellID_second %in% sce_rna[,sce_rna$chemokine == 1]$cellID, ]

# add expressor status to first and second label
expressor_first <- data.frame(colData(sce_rna))[,c("cellID", "expressor")]
colnames(expressor_first) <- c("cellID_first", "expressor_tumor")
expressor_second <- data.frame(colData(sce_rna))[,c("cellID", "expressor")]
colnames(expressor_second) <- c("cellID_second", "expressor_neighbour")
dat_relation_sub <- left_join(dat_relation_sub, expressor_first, by = "cellID_first")
dat_relation_sub <- left_join(dat_relation_sub, expressor_second, by = "cellID_second")

# count occurences of case where first label has (partially) same chemokine as non-tumor neighbouring cell
shared_chemokine <- dat_relation_sub %>%
  group_by(cellID_first) %>%
  mutate(shared_chemokine = ifelse(all(str_split(expressor_tumor, "_")[[1]] %in% str_split(expressor_neighbour, "_")[[1]]), TRUE, FALSE))
  
# what are the most abundant combinations of chemokines in tumor cells that only occur in this tumor cell but not in neighbouring non-tumor cells?  
shared_chemokine %>%
  group_by(shared_chemokine) %>%
  filter(shared_chemokine == FALSE) %>%
  group_by(expressor_tumor) %>%
  summarise(n=n()) %>%
  arrange(-n)

ids <- shared_chemokine %>%
  filter(shared_chemokine == FALSE) %>%
  select(cellID_first)

cur_col <- data.frame(colData(sce_rna))
cur_col$standalone_tumor <- ifelse(cur_col$cellID %in% ids$cellID_first, TRUE, FALSE)
colData(sce_rna)$standalone_tumor <- cur_col$standalone_tumor
```

## run UMAP again on stand-alone expressing tumor cells and control group

```{r}
tumor_chemokine <- data.frame(colData(sce_rna[, sce_rna$standalone_tumor == TRUE]))[,"cellID"]
control_tumor <- data.frame(colData(sce_rna[, sce_rna$celltype == "Tumor" & sce_rna$chemokine == 0]))

# sample same amount of control tumor cells
control_tumor <- control_tumor[sample(nrow(control_tumor), length(tumor_chemokine)), "cellID"]
cur_sce <- sce_rna[,sce_rna$cellID %in% cbind(tumor_chemokine, control_tumor)]

# UMAP
cur_sce <- runUMAP(cur_sce, exprs_values = "asinh", 
               subset_row = (rownames(cur_sce) %in% tumor_marker),
               n_neighbors = 15)

# plot UMAP
a <- dittoDimPlot(cur_sce,
             reduction.use = "UMAP",
             var = "standalone_tumor", 
             size = 2,
             legend.show = TRUE,
             opacity = 1,
             max.color = "red", min.color = "azure3",
             main = NULL) +
    theme_minimal() +
    theme(text = element_text(size=25)) +
    guides(color = guide_legend(override.aes = list(alpha=1, size=5))) +
    guides(fill=guide_legend("Chemokine"))

p.list <- list()
for(i in tumor_marker){
  p.list[[i]] <- dittoDimPlot(cur_sce, i, size = 1, assay = "asinh")
}

b <- plot_grid(plotlist = p.list, ncol = 2)

grid.arrange(a,b, ncol = 2)
```

It seems that HLADR and B2M is elevated in cells that produce chemokines. Lets check this with a boxplot.

```{r boxplot_HLADR_B2M_no_shared, dev=('pdf'), fig.width=8, fig.height=6}
cur_sce <- sce_rna[,sce_rna$cellID %in% cbind(tumor_chemokine, control_tumor)]

tumor_dat <- data.frame(t(assay(cur_sce["HLADR", cur_sce$celltype == "Tumor" & cur_sce$Location != "CTRL"], "asinh")))
tumor_dat$cellID <- rownames(tumor_dat)
tumor_dat <- left_join(tumor_dat, data.frame(colData(sce_rna))[,c("cellID", "standalone_tumor")])

tumor_dat$standalone_tumor <- as.character(tumor_dat$standalone_tumor)

a <- ggplot(tumor_dat, aes(x=standalone_tumor, y=HLADR)) + 
  geom_boxplot() +
  theme(text = element_text(size=20)) +
  xlab("Chemokine Production in Tumor Cells") + 
  ylab("Mean HLA-DR in Tumor Cells (asinh)") +
  stat_compare_means(comparison = list(c("FALSE", "TRUE")), method = "t.test", aes(label=..p.adj..),
                     p.adjust.methods = "fdr")



tumor_dat <- data.frame(t(assay(cur_sce["B2M", cur_sce$celltype == "Tumor" & cur_sce$Location != "CTRL"], "asinh")))
tumor_dat$cellID <- rownames(tumor_dat)
tumor_dat <- left_join(tumor_dat, data.frame(colData(sce_rna))[,c("cellID", "standalone_tumor")])

b <- ggplot(tumor_dat, aes(x=standalone_tumor, y=B2M)) + 
  geom_boxplot() +
  theme(text = element_text(size=20)) +
  xlab("Chemokine Production in Tumor Cells") + 
  ylab("Mean B2M in Tumor Cells (asinh)") +
  stat_compare_means(comparison = list(c("FALSE", "TRUE")), method = "wilcox.test", aes(label=..p.adj..))

grid.arrange(a,b, ncol =2)
```

## Analyse (non-tumor) Neighbouring Cells of Producing vs Non Tumor Cells

```{r}
standalone_tumor <- data.frame(colData(sce_rna[, sce_rna$standalone_tumor == TRUE & sce_rna$chemokine == 1]))[,"cellID"]
standalone_neighbours <- dat_relation[dat_relation$cellID_first %in% standalone_tumor,]$cellID_second

control_tumor <- data.frame(colData(sce_rna[, sce_rna$celltype == "Tumor" & sce_rna$chemokine == 0]))
control_tumor <- control_tumor[sample(nrow(control_tumor), length(standalone_tumor)), "cellID"]
control_neighbours <- dat_relation[dat_relation$cellID_first %in% control_tumor,]$cellID_second

# sample same amount of control tumor cells
cur_sce <- sce_rna[,sce_rna$cellID %in% c(standalone_neighbours, control_neighbours)]

# add info if the tumor cell is producing a chemokine or not (STANDALONE)
cur_df <- data.frame(colData(cur_sce))
cur_df$tumor_producing <- ifelse(cur_df$cellID %in% standalone_neighbours, "producing neighbour", "non-producing neighbour")
colData(cur_sce)$tumor_producing <- cur_df$tumor_producing

# plot proportions
plotCellCounts(cur_sce, proportion = TRUE, 
               colour_by = "celltype", 
               split_by = "tumor_producing",
               imageID = "ImageNumber",
               colour_vector = metadata(cur_sce)$colour_vector$celltype)
```

## UMAP of non-tumor cells only

````{r}
# remove tumor neighbouring cells - we are only interested in non-tumor cells
cur_sce <- cur_sce[,cur_sce$celltype != "Tumor"]

# UMAP
cur_sce <- runUMAP(cur_sce, exprs_values = "asinh", 
               subset_row = rowData(cur_sce)$good_marker,
               n_neighbors = 10)

# plot UMAP
a <- dittoDimPlot(cur_sce,
             reduction.use = "UMAP",
             var = "celltype", 
             size = 2,
             legend.show = TRUE,
             opacity = 0.5,
             max.color = "red", min.color = "azure3",
             main = NULL) +
    theme_minimal() +
    theme(text = element_text(size=25)) +
    guides(color = guide_legend(override.aes = list(alpha=1, size=5))) +
    guides(fill=guide_legend("Celltype"))

b <- dittoDimPlot(cur_sce,
             reduction.use = "UMAP",
             var = "tumor_producing", 
             size = 1,
             legend.show = TRUE,
             opacity = 0.5,
             max.color = "red", min.color = "azure3",
             main = NULL) +
    theme_minimal() +
    theme(text = element_text(size=25)) +
    guides(color = guide_legend(override.aes = list(alpha=1, size=5))) +
    guides(fill=guide_legend("Celltype"))

grid.arrange(a,b, ncol =2)
```

