---
title: "Figure 4"
author: "toobiwankenobi"
date: "2020-08-04"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction
This script generates plots for Figure 4.

# Preparations

```{r setup}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Load libraries

First, we will load the libraries needed for this part of the analysis.

```{r, message=FALSE}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(SingleCellExperiment)
library(reshape2)
library(tidyverse)
library(dplyr)
library(data.table) 
library(ggplot2)
library(cba)
library(ComplexHeatmap)
library(colorRamps)
library(circlize)
library(RColorBrewer)
library(ggpubr)
library(ggbeeswarm)
library(gridExtra)
library(tidyr)
library(ggpmisc)
library(circlize)
library(coxme)
library(dittoSeq)
library(scater)
library(cowplot)
library(survminer)
library(ggalluvial)
library(cytomapper)
library(ggrepel)
```

## Read the data

```{r}
sce_rna = readRDS(file = "data/sce_RNA.rds")
sce_prot = readRDS(file = "data/sce_protein.rds")

# meta data
dat_relation = fread(file = "data/protein/Object relationships.csv",stringsAsFactors = FALSE)
dat_relation_rna = fread(file = "data/RNA/Object relationships.csv",stringsAsFactors = FALSE)
dat_inflammation = fread(file = "data/manual_infiltration_scoring_BlockID.csv", header = TRUE)

# image
image_mat <- read.csv("data/protein/Image.csv")

# surv_dat
dat_survival_prot <- fread(file = "data/protein/clinical_data_protein.csv")
```

## Prepare Relation Data Protein

```{r}
# prepare data and add cellID
dat_relation$cellID_first <- paste("protein", paste(dat_relation$`First Image Number`, dat_relation$`First Object Number`, sep = "_"), sep = "_")
dat_relation$cellID_second <- paste("protein", paste(dat_relation$`Second Image Number`, dat_relation$`Second Object Number`, sep = "_"), sep = "_")

# add celltype status to first and second label
celltype_first <- data.frame(colData(sce_prot))[,c("cellID", "celltype", "celltype_clustered")]
colnames(celltype_first) <- c("cellID_first", "celltype_first", "celltype_clust_first")
celltype_second <- data.frame(colData(sce_prot))[,c("cellID", "celltype", "celltype_clustered")]
colnames(celltype_second) <- c("cellID_second", "celltype_second", "celltype_clust_second")

dat_relation <- left_join(dat_relation, celltype_first, by = "cellID_first")
dat_relation <- left_join(dat_relation, celltype_second, by = "cellID_second")

colnames(dat_relation)[5] <- "FirstImageNumber"
```

## Prepare Relation Data RNA

```{r}
# prepare data and add cellID
dat_relation_rna$cellID_first <- paste("RNA", paste(dat_relation_rna$`First Image Number`, dat_relation_rna$`First Object Number`, sep = "_"), sep = "_")
dat_relation_rna$cellID_second <- paste("RNA", paste(dat_relation_rna$`Second Image Number`, dat_relation_rna$`Second Object Number`, sep = "_"), sep = "_")

# add celltype status to first and second label
celltype_first <- data.frame(colData(sce_rna))[,c("cellID", "celltype_rf", "celltype_clustered")]
colnames(celltype_first) <- c("cellID_first", "celltype_first", "celltype_clust_first")
celltype_second <- data.frame(colData(sce_rna))[,c("cellID", "celltype_rf", "celltype_clustered")]
colnames(celltype_second) <- c("cellID_second", "celltype_second", "celltype_clust_second")

dat_relation_rna <- left_join(dat_relation_rna, celltype_first, by = "cellID_first")
dat_relation_rna <- left_join(dat_relation_rna, celltype_second, by = "cellID_second")

colnames(dat_relation_rna)[5] <- "FirstImageNumber"
```

## Tumor Marker Profile for different Tcell Scoring Groups

```{r Fig_4A_tumor_profile_tcell, fig.height=6, fig.width=9, dev=c('pdf')}
tumor_marker_protein <- c("pS6", "H3K27me3", "HLADR", "PDL1")
tumor_marker_rna <- c("B2M")

# rna data 
dat_rna <- data.frame(t(assay(sce_rna[tumor_marker_rna, sce_rna$celltype == "Tumor"], "asinh")))
dat_rna$cellID <- rownames(dat_rna)
dat_rna <- left_join(dat_rna, data.frame(colData(sce_rna))[,c("cellID", "Tcell_density_score_image", "Description", "MM_location", "Location")])

# filter
dat_rna <- dat_rna %>%
  filter(Location != "CTRL")

# mean per image
dat_rna <- dat_rna %>%
  select(-cellID) %>%
  group_by(Description, Tcell_density_score_image) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# melt
dat_rna <- dat_rna %>%
  reshape2::melt(id.vars = c("Description", "Tcell_density_score_image"), variable.name = "channel", value.name = "asinh")

# protein data
dat_prot <- data.frame(t(assay(sce_prot[tumor_marker_protein,, sce_prot$celltype == "Tumor"], "asinh")))
dat_prot$cellID <- rownames(dat_prot)
dat_prot <- left_join(dat_prot, data.frame(colData(sce_prot))[,c("cellID", "Tcell_density_score_image", "Description", "MM_location", "Location")])

# filter
dat_prot <- dat_prot %>%
  filter(Location != "CTRL")

# mean per image
dat_prot <- dat_prot %>%
  select(-cellID) %>%
  group_by(Description, Tcell_density_score_image) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# melt
dat_prot <- dat_prot %>%
  reshape2::melt(id.vars = c("Description", "Tcell_density_score_image"), variable.name = "channel", value.name = "asinh")

# join both data sets
comb <- rbind(dat_prot, dat_rna)

group_comparison <- list(c("absent", "high"), c("med", "high"))

# plot 
p <- ggplot(comb, aes(x=Tcell_density_score_image, y=asinh, fill=Tcell_density_score_image)) + 
  geom_boxplot(alpha=0.2, lwd=1) +
  geom_quasirandom(alpha=0.6, size=2, aes(col=Tcell_density_score_image)) +
  scale_color_discrete(guide = FALSE) +
  theme_bw() +
  theme(text = element_text(size=18),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank()) +
  facet_wrap(~channel, scales = "free", ncol=3) + 
  stat_compare_means(comparisons = group_comparison, label = "p.signif", size=7) +
  xlab("") + 
  ylab("Mean Count per Image (asinh)") +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
  guides(fill=guide_legend(title="Tcell Score", override.aes = c(lwd=0.5, alpha=1)))

leg <- get_legend(p)

grid.arrange(p + theme(legend.position = "none"))
```

```{r Fig_4A_tumor_profile_tcell_legend, fig.height=2, fig.width=2, dev=c('pdf')}
grid.arrange(leg)
```

# Example Images high/low B2M

## Load masks

```{r}
all_mask <- loadImages(x = "/home/ubuntu/bbvolume/Data/Analysis/melanoma_cohort_new_cp_pipeline/rna/cpout/",
                       pattern = "ilastik_s2_Probabilities_equalized_cellmask.tiff")
```

## add the ImageNumber to masks

```{r match image numbers}
# we load the metadata for the images.
image_mat <- as.data.frame(read.csv(file = "data/rna/Image.csv",stringsAsFactors = FALSE))

# we extract only the FileNames of the masks as they are in the all_masks object
cur_df <- data.frame(cellmask = image_mat$FileName_cellmask,
                     ImageNumber = image_mat$ImageNumber,
                     Description = image_mat$Metadata_Description)

# we set the rownames of the extracted data to be equal to the names of all_masks
rownames(cur_df) <- gsub(pattern = ".tiff",replacement = "",image_mat$FileName_cellmask)

# we add the extracted information via mcols in the order of the all_masks object
mcols(all_mask) <- cur_df[names(all_mask),]
```

## scale the masks

```{r scale masks}
all_mask <- scaleImages(all_mask,2^16-1)
```

## Plot two example Images

```{r Fig_4B_example_images_B2Mexpression, dev=("pdf")}
# subset masks
mask_sub <- all_mask[mcols(all_mask)$Description %in% c("L11", "N3")]
sce_rna_sub <- sce_rna[,sce_rna$Description %in% c("L11", "N3")]

plotCells(mask = mask_sub, 
          object = sce_rna_sub,
          img_id = "Description", cell_id = "CellNumber",
          colour_by = c("CD8", "Mart1", "SOX10", "B2M"),
          colour = list(CD8 = c("black", "green"),
                        Mart1 = c("black", "blue"),
                        SOX10 = c("black", "blue"),
                        B2M = c("black", "red")),
          display = "single",
          exprs_values = "scaled_asinh",
          scale = TRUE)
```

# Correlation Analysis

## Correlation with mean B2M expression and T cell density

```{r Fig_4C_B2M_correlation, fig.height=4, fig.width=10.7, dev=c('pdf')}
tumor_dat <- data.frame(t(assay(sce_rna["B2M", sce_rna$celltype == "Tumor" & sce_rna$Location != "CTRL"], "asinh")))
tumor_dat$Description <- sce_rna[, sce_rna$celltype == "Tumor" & sce_rna$Location != "CTRL"]$Description

tumor_dat <- tumor_dat %>%
  group_by(Description) %>%
  summarise(mean_B2M = mean(B2M))

cur_df <- data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  group_by(Description, BlockID, celltype) %>%
  summarise(n=n()) %>%
  mutate(fraction = n/sum(n)) %>%
  ungroup() %>%
  complete(Description, celltype, fill = list(fraction = 0)) %>%
  filter(celltype == "Tcytotoxic")

cur_df_chemokine <- data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  group_by(Description, chemokine) %>%
  summarise(n=n()) %>%
  reshape2::dcast(Description ~ chemokine, value.var = "n", fill = 0) %>%
  mutate(fraction_positive = `TRUE` / (`FALSE` + `TRUE`))
  
tumor_dat <- left_join(tumor_dat, cur_df)
tumor_dat_chemokine <- left_join(tumor_dat, cur_df_chemokine)

# remove bad images and controls
tumor_dat <- tumor_dat#[!is.na(tumor_dat$manual_scoring) & tumor_dat$manual_scoring != "no assessment possible",]
tumor_dat_chemokine <- tumor_dat_chemokine#[!is.na(tumor_dat_chemokine$manual_scoring) & tumor_dat_chemokine$manual_scoring != "no assessment possible",]

# boxplot
a <- ggplot(tumor_dat, aes(y=mean_B2M, x=log10(fraction))) + 
  geom_point(size=3) +
  geom_smooth(method = "lm", formula = y ~ poly(x,2)) +
  stat_poly_eq(formula = y ~ poly(x,2), 
                aes(label =  ..rr.label..), 
                parse = TRUE, size=10) +
  ylab("Mean B2M Expression (asinh)") +
  xlab("Cytotoxic T cell Fraction (log10)") +
  theme_bw() + 
  theme(text = element_text(size=18))

b <- ggplot(tumor_dat_chemokine, aes(y=mean_B2M, x=log10(fraction_positive))) + 
  geom_point(size=3) +
  geom_smooth(method = "lm", formula = y~poly(x,2)) +
  stat_poly_eq(formula = y ~ poly(x,2), 
                aes(label =  ..rr.label..), 
                parse = TRUE, size=10) +
  ylab("Mean B2M Expression (asinh)") +
  xlab("Chemokine-Expressing Cell Fraction (log10)") +
  theme_bw() + 
  theme(text = element_text(size=18))

grid.arrange(a,b, nrow=1)
```

# Interaction between Dysfunctional CD8 and Tumor Cells

```{r Fig_4D_corr_interaction_and_dysfunction, dev=("pdf"), fig.width=8.4, fig.height=3.5}
# number of interactions tcytotoxic and tumor per image
dat_relation_sub <- dat_relation_rna[dat_relation_rna$celltype_first %in% c("exhausted Tcytotoxic", "Tcytotoxic") & 
                                   dat_relation_rna$celltype_second == "Tumor"]

# count number of interactions
count <- dat_relation_sub %>%
  group_by(FirstImageNumber) %>%
  summarise(n=n())
names(count)[1] <- "ImageNumber"

# fraction of exhausted cd8 per image
dysfunction <- data.frame(colData(sce_rna)) %>%
  mutate(celltype2 = paste(celltype, CXCL13, sep = "_")) %>%
  group_by(ImageNumber, celltype2) %>%
  summarise(n=n()) %>%
  reshape2::dcast(ImageNumber ~ celltype2, value.var = "n", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber"), variable.name = "celltype2", value.name = "n") %>%
  group_by(ImageNumber) %>%
  mutate(fraction = n / sum(n)) %>%
  filter(celltype2 == "Tcytotoxic_1") %>%
  ungroup() %>%
  select(ImageNumber, fraction)

# correlation plot
cur_dat <- left_join(count, dysfunction)

ggplot(cur_dat, aes(x=log10(fraction), y=log10(n))) + 
  geom_point(size=3) + 
  geom_smooth(method="lm") +
  stat_poly_eq(formula = y ~ x, 
                aes(label =  ..rr.label..), 
                parse = TRUE, size=10) +
  theme_bw() +
  theme(text = element_text(size=14)) +
  xlab("Fraction of Dysfunctional Cytotoxic T Cells (log10)") +
  ylab("Number of CD8/Tumor Interactions\n(log10)")
```

# Interaction Analysis

# Generate adjacency matrix for all images

```{r Fig_4X_interaction_chord_groups, fig.height=7, fig.width=5, dev=c('pdf'), eval=F}
# subset sce for inflamed/exhausted in high samples
sce_protein_sub <- sce_prot[, sce_prot$dysfunction_density %in% c("high - high dysfunction", "high - low dysfunction")]

# sample 9 images each
images <- data.frame(colData(sce_protein_sub)) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(dysfunction_density) %>%
  filter(ImageNumber %in% sample(ImageNumber, 9)) %>%
  select(ImageNumber, dysfunction_density)

return <- list()

for (i in c("high - high dysfunction", "high - low dysfunction")){
  # title name
  title_name <- i

  # count interactions in 20 sample images
  cur_dat_relation <- data.frame(dat_relation) %>%
    filter(FirstImageNumber %in% images[images$dysfunction_density == i,]$ImageNumber) %>%
    select("celltype_first" ,"celltype_second") %>%
    dplyr::count(celltype_first,celltype_second) %>%
    data.frame()
  
  # remove tumor-tumor interactions
  cur_dat_relation <- cur_dat_relation[cur_dat_relation$celltype_first != "Tumor",]
  cur_dat_relation <- cur_dat_relation[cur_dat_relation$celltype_first != "unknown",]
  cur_dat_relation <- cur_dat_relation[cur_dat_relation$celltype_second != "unknown",]
  
    # count interactions
  cur_dat_relation_subcluster <- data.frame(dat_relation) %>%
    filter(FirstImageNumber %in% images[images$dysfunction_density == i,]$ImageNumber) %>%
    select("celltype_first" , "celltype_clust_second") %>%
    dplyr::count(celltype_first, celltype_clust_second) %>%
    data.frame()
  
  # remove tumor-tumor interactions
  cur_dat_relation_subcluster <- cur_dat_relation_subcluster[cur_dat_relation_subcluster$celltype_first == "Tcytotoxic",]
  cur_dat_relation_subcluster <- cur_dat_relation_subcluster[cur_dat_relation_subcluster$celltype_clust_second %in% 
                                                               unique(sce_prot[,sce_prot$celltype == "Tumor"]$celltype_clustered),]
  # return subcluster adj df
  return[[i]] <- cur_dat_relation_subcluster
  
  # make coord diagram
  chordDiagramFromDataFrame(cur_dat_relation,
                            grid.col = metadata(sce_prot)$colour_vectors$celltype,
                            reduce = 0.05, 
                            transparency = ifelse(cur_dat_relation[[1]] %in% c("Tcytotoxic"),0,0.6),
                            annotationTrack = c("grid"))
  
  # add percentages
  circos.track(track.index = 1, panel.fun = function(x, y) {
    xlim = get.cell.meta.data("xlim")
    ylim = get.cell.meta.data("ylim")
    sector.name = get.cell.meta.data("sector.index")
    xplot = get.cell.meta.data("xplot")
    
    circos.lines(xlim, c(mean(ylim), mean(ylim)), lty = 3) # dotted line
    by = ifelse(abs(xplot[2] - xplot[1]) > 30, 0.2, 0.5)
    for(p in seq(by, 1, by = by)) {
        circos.text(p*(xlim[2] - xlim[1]) + xlim[1], mean(ylim) + 0.1, 
            paste0(p*100, "%"), cex = 0.5, adj = c(0.5, 0), niceFacing = TRUE)
    }
}, bg.border = NA)
  
}
```

## chordPlot for Tcytotoxic and Tumor Subcluster Interactions

```{r Fig_4X_interaction_cytotoxic_tumor, fig.height=5, fig.width=7, dev=c('pdf'), eval=F}
# color vector for Tumor Subclusters
col_vec <- brewer.pal(length(unique(sce_prot[,sce_prot$celltype == "Tumor"]$celltype_clustered)), "BrBG")
names(col_vec) <- unique(sce_prot[,sce_prot$celltype == "Tumor"]$celltype_clustered)

col_vec <- c(col_vec, metadata(sce_prot)$colour_vectors$celltype["Tcytotoxic"])

# order col_vector
col_vec <- col_vec[order(names(col_vec))]

gap1 <- circlize::calc_gap(return$`high - high dysfunction`, return$`high - low dysfunction`)

# initialize
circos.clear()

# chord plot
chordDiagramFromDataFrame(return$`high - high dysfunction`,
                          transparency = 0,
                          grid.col = col_vec,
                          annotationTrack = c("grid"),
                          reduce = 0.01)
abline(h = 0, lty = 2, col = "#00000080")
circos.clear()

# initialize
circos.clear()
# chord plot
chordDiagramFromDataFrame(return$`high - low dysfunction`,
                          big.gap = gap1,
                          grid.col = col_vec,
                          transparency = 0,
                          annotationTrack = c("grid"),
                          reduce = 0.01)
abline(h = 0, lty = 2, col = "#00000080")

# end
circos.clear()
```

```{r Fig_4X_legend, dev=c('pdf'), fig.height=5, fig.width=1, eval=F}
# create legend for tumor subclusters
#lgd1 = Legend(labels = names(col_vec[grep("Tumor", names(col_vec))]), title = "Tumor\nSubclusters", legend_gp = gpar(fill = unname(col_vec[grep("Tumor", names(col_vec))])))
lgd2 = Legend(labels = names(metadata(sce_prot)$colour_vector$celltype), title = "Cell Type", legend_gp = gpar(fill = unname(metadata(sce_prot)$colour_vector$celltype)))
draw(packLegend(lgd2, 
                #lgd1, 
                gap = unit(2, "cm")))
```

## Boxplots with interaction counts per Image 

```{r Fig_4E_interaction_cytotoxic_tumor_boxplots, fig.width=8.8, fig.height=3.7, dev=("pdf")}
# add dysfunction score to dat_relation
ex_score <- data.frame(colData(sce_prot)) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  select(ImageNumber, dysfunction_score, MM_location)

ex_score$FirstImageNumber <- ex_score$ImageNumber

dat_relation <- left_join(dat_relation, ex_score[,c("FirstImageNumber", "dysfunction_score", "MM_location")])

sum <- dat_relation %>%
  filter(celltype_first == "Tcytotoxic" & celltype_second == "Tumor" & !is.na(dysfunction_score)) %>%
  group_by(FirstImageNumber, MM_location, dysfunction_score, celltype_first, celltype_clust_second) %>%
  summarise(n=n()) %>%
  reshape2::dcast(FirstImageNumber + MM_location + dysfunction_score + celltype_first ~ celltype_clust_second, value.var = "n", fill=0) %>%
  reshape2::melt(id.vars = c("FirstImageNumber", "MM_location", "dysfunction_score", "celltype_first"), variable.name = "celltype", value.name = "n")

#sum <- sum[sum$MM_location == "skin_subcutaneous",]

# calculate fractions for every image (makes it more comparable)
sum2 <- sum %>%
  group_by(FirstImageNumber) %>%
  mutate(fraction = n/sum(n)) %>%
  ungroup()

ggplot(sum2, aes(x=celltype, y=fraction, fill = dysfunction_score)) +
  geom_boxplot(alpha=.2, lwd=1) +
  geom_quasirandom(alpha=.6, dodge.width=.75, size=2, aes(col=dysfunction_score)) +
  scale_color_discrete(guide = FALSE) +
  stat_compare_means(aes(group = dysfunction_score), label = "p.signif", size=5, label.y = 0.95) +
  theme_bw() +
  theme(text = element_text(size = 16),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  guides(fill=guide_legend(title="Dysfunction Score", override.aes = aes(lwd=0.5))) +
  xlab("") + 
  ylab("Fraction of Interactions") +
  ylim(0,1)
```

## Count interactions - RNA data set (exhausted CD8 vs non-exhausted)

```{r Fig_4E_interaction_cytotoxic_tumor_boxplots_RNA, fig.width=12, fig.height=6, dev=("pdf"), eval=F}
# add dysfunction score to dat_relation
ex_score <- data.frame(colData(sce_rna)) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  select(ImageNumber, dysfunction_score, MM_location, Tcell_density_score_image)

ex_score$FirstImageNumber <- ex_score$ImageNumber

dat_relation <- left_join(dat_relation_rna, ex_score[,c("FirstImageNumber", "dysfunction_score", "MM_location", "Tcell_density_score_image")])

sum <- dat_relation %>%
  filter(celltype_first %in% c("Tcytotoxic", "exhausted Tcytotoxic") & celltype_second == "Tumor" & Tcell_density_score_image == "high") %>%
  group_by(FirstImageNumber, MM_location, dysfunction_score, celltype_first, celltype_clust_second) %>%
  summarise(n=n()) %>%
  reshape2::dcast(FirstImageNumber + MM_location + dysfunction_score + celltype_first ~ celltype_clust_second, value.var = "n", fill=0) %>%
  reshape2::melt(id.vars = c("FirstImageNumber", "MM_location", "dysfunction_score", "celltype_first"), variable.name = "celltype", value.name = "n")

#sum <- sum[sum$MM_location == "skin_subcutaneous",]

# calculate fractions for every image (makes it more comparable)
sum2 <- sum %>%
  group_by(FirstImageNumber, celltype_first) %>%
  mutate(fraction = n/sum(n)) %>%
  ungroup()

ggplot(sum2, aes(x=celltype, y=fraction, fill = celltype_first)) +
  geom_boxplot(alpha=.2, lwd=1.5) +
  geom_quasirandom(alpha=.2, dodge.width=.75, size=3, aes(col = celltype_first)) + 
  stat_compare_means(aes(group = celltype_first), label = "p.signif") +
  theme_bw() +
  theme(text = element_text(size = 16),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  guides(fill=guide_legend(title="Dysfunction Score")) +
  xlab("") + 
  ylab("Fraction of Interactions") +
  facet_wrap(~dysfunction_score)
```

# Tumor Marker Profile

## Tumor Marker Profile for different Scoring Groups per Image

```{r Fig_4F_tumor_profile_per_image, fig.height=6.3, fig.width=7.3, dev=c('pdf')}
tumor_marker_protein <- c("S100", "MiTF")
tumor_marker_rna <- c("Mart1", "pRB")

# rna data 
dat_rna <- data.frame(t(assay(sce_rna[tumor_marker_rna, sce_rna$celltype == "Tumor"], "asinh")))
dat_rna$cellID <- rownames(dat_rna)
dat_rna <- left_join(dat_rna, data.frame(colData(sce_rna))[,c("cellID", "dysfunction_score", "Description", "MM_location")])

# filter
dat_rna <- dat_rna %>%
  filter(dysfunction_score %in% c("high dysfunction", "low dysfunction"))

# mean per image
dat_rna <- dat_rna %>%
  select(-cellID) %>%
  group_by(Description, dysfunction_score) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# melt
dat_rna <- dat_rna %>%
  reshape2::melt(id.vars = c("Description", "dysfunction_score"), variable.name = "channel", value.name = "asinh")

# protein data
dat_prot <- data.frame(t(assay(sce_prot[tumor_marker_protein,, sce_prot$celltype == "Tumor"], "asinh")))
dat_prot$cellID <- rownames(dat_prot)
dat_prot <- left_join(dat_prot, data.frame(colData(sce_prot))[,c("cellID", "dysfunction_score", "Description", "MM_location")])

# filter
dat_prot <- dat_prot %>%
  filter(dysfunction_score %in% c("high dysfunction", "low dysfunction"))

# mean per image
dat_prot <- dat_prot %>%
  select(-cellID) %>%
  group_by(Description, dysfunction_score) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# melt
dat_prot <- dat_prot %>%
  reshape2::melt(id.vars = c("Description", "dysfunction_score"), variable.name = "channel", value.name = "asinh")

# join both data sets
comb <- rbind(dat_prot, dat_rna)

group_comparison <- list(c("high dysfunction", "low dysfunction"))

# plot 
ggplot(comb, aes(x=dysfunction_score, y=asinh, fill=dysfunction_score)) + 
  geom_boxplot(alpha=0.2, lwd=1) +
  geom_quasirandom(alpha=0.6, size=3, aes(col=dysfunction_score)) +
  scale_color_discrete(guide = FALSE) +
  theme_bw() +
  theme(text = element_text(size=18),
        legend.position = "none") +
  facet_wrap(~channel, scales = "free") + 
  stat_compare_means(comparisons = group_comparison, label = "p.signif", size=7) +
  ylab("Mean Expression (asinh)") + 
  xlab("") +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.2)))
```

# CD8+ Marker Profile

## CD8+ Marker Profile for different Scoring Groups per Image

```{r Fig_4X_cd8_profile_per_image, fig.height=8, fig.width=9, dev=c('pdf'), eval=F}
tumor_marker_protein <- c("GrzB", "PD1", "CD45RO")
tumor_marker_rna <- c("Lag3", "T8_CXCL13", "T5_CCL4")

# rna data 
dat_rna <- data.frame(t(assay(sce_rna[tumor_marker_rna, sce_rna$celltype == "Tcytotoxic"], "asinh")))
dat_rna$cellID <- rownames(dat_rna)
dat_rna <- left_join(dat_rna, data.frame(colData(sce_rna))[,c("cellID", "dysfunction_score", "ImageNumber")])

# filter
dat_rna <- dat_rna %>%
  filter(dysfunction_score %in% c("high dysfunction", "low dysfunction"))

# mean per image
dat_rna <- dat_rna %>%
  select(-cellID) %>%
  group_by(ImageNumber, dysfunction_score) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# melt
dat_rna <- dat_rna %>%
  reshape2::melt(id.vars = c("ImageNumber", "dysfunction_score"), variable.name = "channel", value.name = "asinh")

# protein data
dat_prot <- data.frame(t(assay(sce_prot[tumor_marker_protein,, sce_prot$celltype == "Tcytotoxic"], "asinh")))
dat_prot$cellID <- rownames(dat_prot)
dat_prot <- left_join(dat_prot, data.frame(colData(sce_prot))[,c("cellID", "dysfunction_score", "ImageNumber")])

# filter
dat_prot <- dat_prot %>%
  filter(dysfunction_score %in% c("high dysfunction", "low dysfunction"))

# mean per image
dat_prot <- dat_prot %>%
  select(-cellID) %>%
  group_by(ImageNumber, dysfunction_score) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# melt
dat_prot <- dat_prot %>%
  reshape2::melt(id.vars = c("ImageNumber", "dysfunction_score"), variable.name = "channel", value.name = "asinh")

group_comparison <- list(c("high dysfunction", "low dysfunction"))

# plot 
a <- ggplot(dat_rna, aes(x=dysfunction_score, y=asinh)) + 
  geom_boxplot(alpha=0.2) +
  geom_beeswarm(alpha=0.1) +
  theme_bw() +
  theme(text = element_text(size=18),
        axis.text.x = element_blank(),
        legend.position = "none") +
  facet_wrap(~channel) + 
  stat_compare_means(comparisons = group_comparison, label = "p.signif") +
  xlab("") + 
  ylab("") + 
  coord_cartesian(ylim = c(0,6))

b <- ggplot(dat_prot, aes(x=dysfunction_score, y=asinh)) + 
  geom_boxplot(alpha=0.2) +
  geom_beeswarm(alpha=0.1) +
  theme_bw() +
  theme(text = element_text(size=18),
        axis.text.x = element_text(angle=90),
        legend.position = "none") +
  facet_wrap(~channel) + 
  stat_compare_means(comparisons = group_comparison, label = "p.signif") +
  xlab("") + 
  ylab("Mean Count per Image (asinh)") + 
  coord_cartesian(ylim = c(0,6))

grid.arrange(a,b, nrow=2, heights = c(0.75,1))
```

# Boxplots

## Celltypes

```{r Fig_4X_celltype_fractions_dysfunction, dev=("pdf"), fig.width=10, fig.height=6, eval=F}
celltypes <- data.frame(colData(sce_prot)) %>%
  filter(celltype != "Tumor") %>%
  group_by(ImageNumber, bcell_patch_score, dysfunction_score, celltype) %>%
  summarise(n=n()) %>%
  mutate(fraction = n/sum(n)) %>%
  filter(is.na(dysfunction_score) == FALSE)

celltypes$bcell_patch_score <- as.character(celltypes$bcell_patch_score)
celltypes$bcell_patch_score <- factor(celltypes$bcell_patch_score, levels = c("no Bcells", "few Bcells", "small patches", "large patches"))

ggplot(celltypes, aes(x=celltype, y=fraction, fill=dysfunction_score)) +
  geom_boxplot(alpha=.2, lwd = 1) +
  geom_jitter(alpha=1, position = position_jitterdodge(dodge.width = 0.75,jitter.width = 0.1), size = 4, 
              aes(x = celltype, y = fraction, col=ifelse(celltype %in% c("Bcell", "BnTcell"), bcell_patch_score, " "),
                  group = dysfunction_score)) + 
  #scale_color_discrete(guide = FALSE) +
  stat_compare_means(aes(group = dysfunction_score), label = "p.signif") +
  theme_bw() +
  theme(text = element_text(size = 16),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  guides(fill=guide_legend(title="Dysfunction Score", override.aes = c(lwd=0.5)), col=guide_legend(title="Bcell Score")) +
  xlab("") + 
  ylab("Cell Type Fractions") +
  scale_color_manual(values = c("black", "lightblue", "darkblue", "red", "red4"),
                    labels = c(" ", "no Bcells", "few Bcells", "small patches", "large patches"),
                    guide = TRUE)

# check images above median in low dysfunction group for B cells (all have large patches)
celltypes %>%
  filter(dysfunction_score == "low dysfunction") %>%
  filter(celltype == "Bcell") %>%
  group_by(dysfunction_score) %>%
  mutate(median_frac = median(fraction)) %>%
  filter(fraction > median_frac)
```

## Composition of Dysfunction Groups (Met Location and Punch Location)

```{r alluvial_dysfunction_score, fig.width=10, fig.height=5, dev=("pdf"), eval=F}
c <- data.frame(colData(sce_rna)) %>%
  distinct(Description, .keep_all = T) %>%
  filter(dysfunction_score %in% c("low dysfunction", "high dysfunction")) %>%
  dplyr::count(MM_location, Location, dysfunction_score) %>%
  ggplot(aes(axis1 = MM_location, axis2 = Location, axis3 = dysfunction_score,y=n))+
  geom_alluvium(aes(fill=as.factor(dysfunction_score)))+
  geom_stratum()+
  geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
  theme_minimal()+
  scale_x_discrete(limits = c("Met Location", "Punch Location", "Dysfunction Score"), expand = c(.2, .05)) +
  theme(text = element_text(size=20)) +
  guides(fill=guide_legend(title="Dysfunction Score")) +
  ylab("Number of Samples")
plot(c)
```

## B cell patch grouping for dysfunction groups

```{r Fig_4X_bcell_groups_fraction, dev=("pdf"), fig.width=12, fig.height=4, eval=F}
a <- data.frame(colData(sce_rna)) %>%
  distinct(Description, .keep_all = T) %>%
  group_by(bcell_patch_score, dysfunction_score) %>%
  summarise(n=n()) %>%
  filter(is.na(dysfunction_score) == F) %>%
  group_by(dysfunction_score) %>%
  mutate(fraction = n / sum(n)) %>%
  ungroup()

ggplot(a) + 
  geom_col(aes(y=dysfunction_score, x=fraction, fill=bcell_patch_score)) +
  theme_minimal() + 
  theme(text = element_text(size = 22)) +
  xlab("Fraction of Samples") +
  ylab("") +
  guides(fill=guide_legend(title="Bcell Groups"))
```

## S100 levels and CD8/Tumor Interactions

# S100 and T Cell Dysfunction

```{r Fig_4H_S100_dysfunction, dev=("pdf"), fig.width=7.7, fig.height=3.5}
# fraction of exhausted cd8 per image
dysfunction <- data.frame(colData(sce_rna)) %>%
  mutate(celltype2 = paste(celltype, CXCL13, sep = "_")) %>%
  group_by(ImageNumber, celltype2) %>%
  summarise(n=n()) %>%
  reshape2::dcast(ImageNumber ~ celltype2, value.var = "n", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber"), variable.name = "celltype2", value.name = "n") %>%
  group_by(ImageNumber) %>%
  mutate(fraction = n / sum(n)) %>%
  filter(celltype2 == "Tcytotoxic_1") %>%
  ungroup() %>%
  select(ImageNumber, fraction)

# rna data 
dat_rna <- data.frame(t(assay(sce_rna["S100", sce_rna$celltype == "Tumor"], "asinh")))
dat_rna$cellID <- rownames(dat_rna)
dat_rna <- left_join(dat_rna, data.frame(colData(sce_rna))[,c("cellID", "ImageNumber")])

# mean per image
dat_rna <- dat_rna %>%
  select(-cellID) %>%
  group_by(ImageNumber) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)

# melt
dat_rna <- dat_rna %>%
  reshape2::melt(id.vars = c("ImageNumber"), variable.name = "channel", value.name = "asinh")

# correlation plot
cur_dat <- left_join(dysfunction, dat_rna)

# high density images
cur_dat <- cur_dat[cur_dat$ImageNumber %in% unique(sce_rna[,colData(sce_rna)$dysfunction_score %in% c("high dysfunction", "low dysfunction")]$ImageNumber),]

ggplot(cur_dat, aes(x=asinh, y=log10(fraction))) + 
  geom_point(size=3) + 
  geom_smooth(method="lm") +
  stat_poly_eq(formula = y ~ x, 
                aes(label =  ..rr.label..), 
                parse = TRUE, size=10) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("Mean S100 (asinh)") +
  ylab("Fraction of Dysfunctional T cells\n(log10)")
```

# Response / Survival Analysis

```{r}
# select blocks in ICI subgroup that are treatment-naive and non-adjuvant
blocks <- unique(sce_prot[,sce_prot$treatment_status_before_surgery == "naive" & 
                            sce_prot$treatment_group_after_surgery == "ICI" &
                            sce_prot$Adjuvant == "n"]$BlockID)

# subset survival data (only data points that contain info for 3m response)
dat_survival_prot_sub <- dat_survival_prot[dat_survival_prot$BlockID %in% blocks & 
                                             is.na(dat_survival_prot$Status_at_3m) == FALSE, ]

# remove LN margin samples
dat_survival_prot_sub <- dat_survival_prot_sub %>%
  mutate(mmLocationPunch = paste(MM_location, Location, sep = "_")) %>%
  filter(mmLocationPunch != "LN_M")

# group sizes
dat_survival_prot_sub %>%
  distinct(Internal_pat_ID, .keep_all = T) %>%
  group_by(Status_at_3m) %>%
  summarise(n=n())
```

## Celltypes Clustered in Responder vs. Non-Responder

```{r, Fig_4G_responder_nonresponder_tumor, fig.height=3.8, fig.width=9.1, dev=("pdf")}
im_size <- as.data.frame(cbind(image_mat$Metadata_Description, (image_mat$Height_cellmask * image_mat$Width_cellmask)/1000000))
names(im_size) <- c("Description", "mm2")
im_size$mm2 <- as.numeric(im_size$mm2)
im_size[im_size$Description %in% c("G1", "G1 - split"), ]$mm2 <- mean(im_size[im_size$Description %in% c("G1", "G1 - split"), ]$mm2)
im_size <- im_size[im_size != "G1 - split",]

cur_dat <- data.frame(colData(sce_prot[,sce_prot$BlockID %in% unique(dat_survival_prot_sub$BlockID)])) %>%
  mutate(mmLocationPunch = paste(MM_location, Location, sep = "_")) %>%
  #filter(mmLocationPunch != "LN_M") %>% # remove LN margin images 
  #filter(celltype != "Tumor") %>%
  group_by(PatientID,BlockID, Description, bcell_patch_score, celltype_clustered) %>%
  summarise(n=n()) %>% 
  reshape2::dcast(PatientID + BlockID + Description + bcell_patch_score ~ celltype_clustered, value.var = "n", fill=0) %>%
  reshape2::melt(id.vars = c("PatientID","BlockID", "Description", "bcell_patch_score"), 
                 variable.name = "celltype", value.name = "n") %>%
  group_by(Description) %>%
  mutate(fraction = n/sum(n)) %>%
  mutate(total_cells = sum(n)) %>%
  ungroup() %>%
  filter(celltype %in% c("Tumor_1", "Tumor_9"))

cur_dat <- left_join(cur_dat, dat_survival_prot_sub[,c("BlockID", "Status_at_3m", "Primary_melanoma_type")]) %>%
  distinct(Description, celltype, .keep_all = T)

cur_dat <- left_join(cur_dat, im_size[im_size$Description %in% unique(cur_dat$Description),])
cur_dat$n_per_mm2 <- cur_dat$n / cur_dat$mm2

ggplot(cur_dat, aes(x=Status_at_3m, y=log10(n_per_mm2+1), fill=Status_at_3m, label=PatientID)) + 
  geom_boxplot(alpha=.4, outlier.shape = NA) +
  geom_beeswarm(size=3) +
  geom_label_repel(aes(label=PatientID), max.overlaps = 12, size = 5, alpha=.5) + 
  stat_compare_means(label.x.npc = "left", label.y = -0.9, size=8) +
  theme_bw() +
  theme(text = element_text(size=18),
        legend.position = "none") +
  ylab("Cells per mm2 (log10)") +
  xlab("") +
  guides(fill=guide_legend(title="Response 3m", override.aes = c(lwd=0.5, size=1))) +
  facet_wrap(~celltype, scales = "free")
```
