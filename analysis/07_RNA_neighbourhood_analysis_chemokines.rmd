---
title: "07_RNA_neighbourhood_analysis_chemokines"
author: "toobiwankenobi"
date: "2020-07-28"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

# Preparations

## Load libraries

```{r, message=F}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(ComplexHeatmap)
library(SingleCellExperiment)
library(ggplot2)
library(ggrepel)
library(dplyr)
library(data.table)
library(sf)
library(RANN)
```

## Load data

```{r load data}
sce = readRDS(file = "data/sce_RNA.rds")
```

# Chemokine Cluster Detection and Analysis

## Detect Clusters for Single Chemokines

```{r}
start = Sys.time()
cur_sce <- data.frame(colData(sce))
# loop through all chemokines
for(i in names(cur_sce[,grepl(glob2rx("C*L*"),names(cur_sce))])) {

  # find clusters
  sce <- findClusters(input_sce = sce, 
                    IDs_of_interest = cur_sce[cur_sce[,names(cur_sce) == i] == 1,]$cellID, 
                    'cellID', 
                    'Center_X', 'Center_Y', 
                    'ImageNumber', 
                    distance = 25, 
                    min_clust_size = 1,
                    output_colname = paste(tolower(i), "only_clust", sep = ""))

  
  # define cells within/surrounding a cluster of chemokine producing cells
  sce <- findCommunity(sce, 
                     'cellID', 
                     'Center_X', 
                     'Center_Y', 
                     'ImageNumber', 
                     paste(tolower(i), "only_clust", sep = ""), 
                     distance = 30,
                     output_colname = paste(tolower(i), "only_comm", sep = ""))
} 
end = Sys.time()
print(end-start)
```

## Save SCE

```{r}
saveRDS(sce, file = "data/sce_RNA.rds")
```
