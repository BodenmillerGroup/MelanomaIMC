---
title: "Supplementary Figure 2"
author: "toobiwankenobi"
date: "2020-10-13"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction
This script generates plots for Supplementary Figure 2.

# Preparations

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message= FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Load libraries

```{r load libraries}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(data.table)
library(survival)
library(ggplot2)
library(broom)
library(dplyr)
library(RColorBrewer)
library(ggalluvial)
library(tidyverse)
library(cowplot)
library(ggbeeswarm)
library(gridExtra)
```

## Load Data

```{r}
# clinical data
dat <- read_csv("data/protein/clinical_data_protein.csv")

# SCE object
sce_protein = readRDS(file = "data/sce_protein.rds")
sce_rna = readRDS(file = "data/sce_RNA.rds")
```

# Analysis

## Clinical features of the cohort 

Note: as the cohort is very diverse, we are using the BlockID as the minimal unit since clinical parameters are described per BlockID. However, sometimes we do have patients of which we have multiple FFPE blocks (BlockIDs). Nonetheless, clinical parameters are not given per patient but per patient FFPE block and are therefore considered the minimial unit.

## Number of Samples

```{r Supp_Fig_2A_number_of_samples, fig.height=8, fig.width=19, dev=c('pdf')}
dat[dat$BlockID %in% unique(sce_protein[,sce_protein$Location == "CTRL"]$BlockID),]$MM_location <- "Control"

# remove control samples
dat <- dat[dat$BlockID %in% unique(sce_protein[,sce_protein$Location != "CTRL"]$BlockID),]

p1 <- unique(dat[,c("BlockID","MM_location")]) %>%
  ggplot()+
  geom_bar(aes(y=MM_location),stat ="count") +
  xlab("BlockIDs per Location") +
  ylab("Metastasis Location") +
  theme(text = element_text(size=18))
  
p2 <- dat %>%
  ggplot()+
  geom_bar(aes(x=BlockID, fill=(MM_location)),stat="count")+
  theme(axis.text.x = element_text(angle = 90,vjust = 0.5)) + 
  ylab("Number of Samples") +
  guides(fill=guide_legend(title="Metasis Location")) +
  theme(text = element_text(size=18))

plot_grid(p1,p2,rel_widths = c(1,3))  
```

## Location Information

```{r Supp_Fig_2B_location_plot, fig.height=10,fig.width=15, dev=c('pdf')}
cur_df <- dat %>%
  select(BlockID,Nr_treatments_before_surgery,MM_location,Treatment_after_surgery, Status_at_3m, Date_death,Location,Cancer_Stage, E_I_D)
cur_df <- unique(cur_df)
cur_df$Death <- "Dead"
cur_df[which(is.na(cur_df$Date_death)),]$Death <- "Alive"

# Alluvial plot
b<- cur_df %>%
  dplyr::count(MM_location,Cancer_Stage,Location) %>%
  ggplot(aes(axis1 = MM_location, axis2 = Cancer_Stage, axis3 = Location,y=n))+
  geom_alluvium(aes(fill=as.factor(MM_location)))+
  geom_stratum()+
  geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
  theme_minimal()+
  scale_x_discrete(limits = c("Met Location", "Cancer Stage", "Punch position"), expand = c(.2, .05)) +
  theme(text = element_text(size=20)) +
  guides(fill=guide_legend(title="Metasis Location")) +
  ylab("Number of Samples")
plot(b)
```

## Treamtents before Surgery

```{r Supp_Fig_2C_treatment_plot, fig.height=10,fig.width=15, dev=c('pdf')}
c <- cur_df %>%
  dplyr::count(MM_location, Nr_treatments_before_surgery,Death) %>%
  ggplot(aes(axis1 = MM_location, axis2 = Nr_treatments_before_surgery, axis3 = Death,y=n))+
  geom_alluvium(aes(fill=as.factor(Death)))+
  geom_stratum()+
  geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
  theme_minimal()+
  scale_x_discrete(limits = c("Met Location", "# Previous Treatments", "Outcome"), expand = c(.2, .05)) +
  theme(text = element_text(size=20)) +
  guides(fill=guide_legend(title="Outcome")) +
  ylab("Number of Samples")
plot(c)
```

# Chemokines

## Cancer Stage

```{r Supp_Fig_2D_cancer_stage, dev=c('pdf'), fig.width=7, fig.height=8}
targets <- metadata(sce_rna)$chemokines_morethan600_withcontrol

# subset sce_rna
group_size <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, Cancer_Stage) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(Cancer_Stage) %>%
  summarise(n=n()) %>%
  filter(n>10 & Cancer_Stage != "")

sce_rna_sub <- sce_rna[,sce_rna$Cancer_Stage %in% group_size$Cancer_Stage]

plotCellCounts(sce = sce_rna_sub, 
                     sce_sub = sce_rna_sub[,which(sce_rna_sub$expressor %in% targets)],
                     cellID = "cellID",
                     colour_by = "expressor",
                     split_by = "Cancer_Stage",
                     imageID = "ImageNumber",
                     normalize = TRUE,
                     colour_vector = metadata(sce_rna)$colour_vectors$chemokine_combinations) + 
  guides(fill=guide_legend("Chemokine")) +
  theme(text = element_text(size=18))

t <- data.frame(colData(sce_rna_sub)) %>%
  group_by(ImageNumber, Cancer_Stage, chemokine) %>%
  summarise(n=n()) %>%
  group_by(ImageNumber) %>%
  mutate(fraction = n / sum(n)) %>%
  reshape2::dcast(ImageNumber + Cancer_Stage ~ chemokine, value.var = "fraction")

round(wilcox.test(t$`TRUE` ~ t$Cancer_Stage)$p.value,3)
```

## Age

```{r Supp_Fig_2E_age, dev=c('pdf'), fig.width=7, fig.height=8}
# subset sce_rna
group_size <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, Age) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(Age) %>%
  summarise(n=n()) %>%
  filter(n>10 & Age != "")

sce_rna_sub <- sce_rna[,sce_rna$Age %in% group_size$Age]
sce_rna_sub[,sce_rna_sub$Age == "?60"]$Age <- "60+"

# relevel age factor
sce_rna_sub$Age <- factor(sce_rna_sub$Age, levels = c("<45", "45-59", "60+"))

plotCellCounts(sce = sce_rna_sub, 
                     sce_sub = sce_rna_sub[,which(sce_rna_sub$expressor %in% targets)],
                     cellID = "cellID",
                     colour_by = "expressor",
                     split_by = "Age",
                     imageID = "ImageNumber",
                     normalize = TRUE,
                     colour_vector = metadata(sce_rna)$colour_vectors$chemokine_combinations) + 
  guides(fill=guide_legend("Chemokine")) +
  theme(text = element_text(size=18))

t <- data.frame(colData(sce_rna_sub)) %>%
  group_by(ImageNumber, Age, chemokine) %>%
  summarise(n=n()) %>%
  group_by(ImageNumber) %>%
  mutate(fraction = n / sum(n)) %>%
  reshape2::dcast(ImageNumber + Age ~ chemokine, value.var = "fraction")

round(kruskal.test(x = t$`TRUE`, g = t$Age)$p.value,3)
```

## Gender

```{r Supp_Fig_2F_gender, dev=c('pdf'), fig.width=7, fig.height=8}
# subset sce_rna
group_size <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, Gender) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(Gender) %>%
  summarise(n=n()) %>%
  filter(n>10 & Gender != "")

sce_rna_sub <- sce_rna[,sce_rna$Gender %in% group_size$Gender]

plotCellCounts(sce = sce_rna_sub, 
                     sce_sub = sce_rna_sub[,which(sce_rna_sub$expressor %in% targets)],
                     cellID = "cellID",
                     colour_by = "expressor",
                     split_by = "Gender",
                     imageID = "ImageNumber",
                     normalize = TRUE,
                     colour_vector = metadata(sce_rna)$colour_vectors$chemokine_combinations) + 
  guides(fill=guide_legend("Chemokine")) +
  theme(text = element_text(size=18))

t <- data.frame(colData(sce_rna_sub)) %>%
  group_by(ImageNumber, Gender, chemokine) %>%
  summarise(n=n()) %>%
  group_by(ImageNumber) %>%
  mutate(fraction = n / sum(n)) %>%
  reshape2::dcast(ImageNumber + Gender ~ chemokine, value.var = "fraction")

round(wilcox.test(t$`TRUE` ~ t$Gender)$p.value,3)
```

## Treatment

```{r Supp_Fig_2G_treatment, dev=c('pdf'), fig.width=7, fig.height=8}
# subset sce_rna
group_size <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, treatment_group_before_surgery) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(treatment_group_before_surgery) %>%
  summarise(n=n()) %>%
  filter(n>10 & treatment_group_before_surgery != "control")

sce_rna_sub <- sce_rna[,sce_rna$treatment_group_before_surgery %in% group_size$treatment_group_before_surgery]

plotCellCounts(sce = sce_rna_sub, 
                     sce_sub = sce_rna_sub[,which(sce_rna_sub$expressor %in% targets)],
                     cellID = "cellID",
                     colour_by = "expressor",
                     split_by = "treatment_group_before_surgery",
                     imageID = "ImageNumber",
                     normalize = TRUE,
                     colour_vector = metadata(sce_rna)$colour_vectors$chemokine_combinations) + 
  guides(fill=guide_legend("Chemokine")) +
  theme(text = element_text(size=18))

t <- data.frame(colData(sce_rna_sub)) %>%
  group_by(ImageNumber, treatment_group_before_surgery, chemokine) %>%
  summarise(n=n()) %>%
  group_by(ImageNumber) %>%
  mutate(fraction = n / sum(n)) %>%
  reshape2::dcast(ImageNumber + treatment_group_before_surgery ~ chemokine, value.var = "fraction")

round(wilcox.test(t$`TRUE` ~ t$treatment_group_before_surgery)$p.value,3)
```

## Chemokine Fractions per Image for Location

```{r Supp_Fig_2H_fractions_met_location, fig.width=14, fig.height=9, dev=c('pdf')}
# subset sce_rna
group_size <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, MM_location) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(MM_location) %>%
  summarise(n=n()) %>%
  filter(n>4 & MM_location != "")

sce_rna_sub <- sce_rna[,sce_rna$MM_location %in% group_size$MM_location]

a <- plotCellFractions(sce = sce_rna_sub, 
                  imageID = "ImageNumber", 
                  celltype_column = "expressor",
                  celltype_subsets = targets,
                  split_by = "MM_location",
                  show_n = TRUE,
                  facet_wrap = TRUE,
                  merge_subsets = FALSE) + 
  ylim(0, 0.1)

a
```

# Met Location

## Patients per Location

```{r}
sce_rna$MM_location <- ifelse(sce_rna$MM_location %in% c("skin", "skin_undefine"), "skin_undefined", sce_rna$MM_location)

groups <- data.frame(colData(sce_rna)) %>%
  distinct(ImageNumber, .keep_all = T) %>%
  group_by(MM_location) %>%
  distinct(PatientID, .keep_all = T) %>%
  summarise(n=n()) %>%
  filter(n>=5) %>%
  arrange(-n)
```

## Boxplot/Barplot per Location for every chemokine combination

```{r}
targets <- metadata(sce_rna)$chemokines_morethan600_withcontrol

fractions_per_image <- data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, MM_location, expressor, celltype) %>%
  summarise(n = n()) %>%
  group_by(ImageNumber) %>%
  mutate(total_cells = sum(n)) %>%
  mutate(fraction_per_image = n / total_cells) %>%
  group_by(ImageNumber, expressor) %>%
  mutate(group_fraction = sum(fraction_per_image)) %>%
  ungroup() %>%
  filter(expressor %in% targets & MM_location %in% groups$MM_location)

# fraction of expressor cells per image 
fraction_expressor_per_image <- fractions_per_image %>%
  distinct(ImageNumber, MM_location, expressor, .keep_all = T) %>%
  reshape2::dcast(ImageNumber + MM_location ~ expressor, value.var = "group_fraction", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber", "MM_location"), variable.name = "expressor", value.name = "fraction_per_image")

# fraction of celltype expressing a certain combi per image
median_celltype_fraction <- fractions_per_image %>%
  distinct(ImageNumber, celltype, expressor, .keep_all = T) %>%
  reshape2::dcast(ImageNumber + MM_location + expressor ~ celltype, value.var = "fraction_per_image", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber", "MM_location", "expressor"), 
                 variable.name = "celltype", value.name = "fraction_per_image") %>%
  reshape2::dcast(ImageNumber + MM_location + celltype ~ expressor, value.var = "fraction_per_image", fill = 0) %>%
  reshape2::melt(id.vars = c("ImageNumber", "MM_location", "celltype"), 
                 variable.name = "expressor", value.name = "fraction_per_image") %>%
  group_by(MM_location, expressor, celltype) %>%
  summarise(sum_fraction = sum(fraction_per_image)) %>%
  group_by(MM_location, expressor) %>%
  mutate(proportions = sum_fraction / sum(sum_fraction))
```

```{r Fig_2D_expression_per_location, dev=c('pdf')}
plot_list <- list()
for(i in groups$MM_location) {
  a <- fraction_expressor_per_image %>%
    filter(MM_location == i) %>%  
    group_by(ImageNumber, expressor) %>%
    ggplot(., aes(y=expressor, x=fraction_per_image)) + 
    geom_boxplot() + 
    geom_point(alpha=0.2) +
    theme_bw() +
    theme(axis.title.y = element_blank(),
          axis.text.y = element_text(hjust=0.5)) +
    #annotation_logticks(sides = "bottom") + 
    xlab("Cell Fraction per Image") +
    xlim(0,0.15)
  
  b <- median_celltype_fraction %>%
    filter(MM_location == i) %>%  
    ggplot(., aes(y=expressor, x=-proportions, fill=celltype)) + 
    geom_bar(stat = "identity") +
    theme_bw() +
    theme(axis.text.y = element_blank(),
          axis.title.y = element_blank(),
          legend.position = "none") +
    xlab("Producing Cell Types") +
          scale_fill_manual(values = unname(metadata(sce_rna)$colour_vectors$celltype),
                        breaks = names(metadata(sce_rna)$colour_vectors$celltype),
                        labels = names(metadata(sce_rna)$colour_vectors$celltype)) +
    scale_x_continuous(breaks=c(-1.00,-0.75,-0.5, -0.25, 0.00),
                     labels=c("100%", "75%", "50%", "25%", "0%"))
  
  grid.arrange(b,a,nrow=1,
               widths = c(.75,1),
               top = i)
}
```
