---
title: "04_2_RNA_classification_subclustering"
author: "toobiwankenobi"
date: "2020-07-28"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction

In this script we try to set global thresholds for some key markers (CD3 etc) and then sub-cluster the respective cells with markers that we know are expressed on those cells.

# Preparations

## Load libraries

```{r message=F}
sapply(list.files("/Volumes/thoch/Git/ZTMA256_protein_data/code/helper_functions/", full.names = TRUE), source)
sapply(list.files("/Volumes/server_homes/daniels/Git/imcRtools/R/", full.names = TRUE), source)
library(LSD)
library(SingleCellExperiment)
library(ggplot2)
library(scater)
library(viridis)
library(Rphenograph)
library(igraph)
library(CATALYST)
library(workflowr)
```

## Load data

```{r load data}
sce <- readRDS(file = "data/sce_RNA.rds")
```

# Marker for Clustering

## Definition of markers used for subclustering the classified cells

```{r subclustering of the celltypes} 
# Select markers
marker_list <- list()

marker_list$Tumor <- c("HLADR", "S100","B2M","GLUT1","SOX10","cleavedPARP","Mart1","pRB")

# check if the names of the marker list match the names of the classified cells
names(marker_list) %in% unique(sce$celltypes_layer1)
```

# Clustering

## Sub-cluster the whole dataset with FlowSOM

FlowSOM first because it is faster

```{r sublcustering whole dataset using FlowSOM}
## the FlowSOM function from CATALYST needs an another column in the rowData of the sce to work properly:
rowData(sce)$marker_class <- "state"

# vector for clustering
fs_clustering <- vector(length = ncol(sce))

# Cluster Tumor cells into 6 clusters
set.seed(12345)

start = Sys.time()
for(i in c("Tumor")){
  #subset cells for clustering
  cur_sce <- sce[,sce$celltypes_layer1 == i]
  
  # change name of assay for clustering to exprs (hard-coded in CATALYST)
  names(assays(cur_sce)) <- c("counts", "exprs", "scaled_counts", "scaled_asinh")
  cur_sce <- CATALYST::cluster(cur_sce, features = marker_list[i][[1]], ydim = 2, xdim = 3, maxK = 4)
  fs_clustering[sce$celltypes_layer1 == i] <- cur_sce$cluster_id
}
end = Sys.time()
print(end-start)

# create new vector with layer1 info and tumor clusters
labels <- ifelse(sce$celltypes_layer1 == "Tumor", paste0(sce$celltypes_layer1, "_", fs_clustering), sce$celltypes_layer1)


# Save in SCE object
sce$celltypes_layer2 <- labels
```

# Visualization

## Visulalize clustering results for FlowSOM

```{r heatmap_mean_expression_per_celltypes_layer1_subclustered_asinh, fig.width= 20, fig.height=15}
# Aggregate the counts
mean_sce <- calculateSummary(sce, split_by = c("celltypes_layer2"), 
                             exprs_values = "counts")

# Exclude bad markers
mean_sce <- mean_sce[rowData(sce)$good_marker,]

# Transform and scale
assay(mean_sce, "arcsinh") <- asinh(assay(mean_sce, "meanCounts")) 
assay(mean_sce, "arcsinh_scaled") <- t(scale(t(asinh(assay(mean_sce, "meanCounts")))))

# Linear scale 
plotHeatmap(mean_sce, exprs_values = "arcsinh", 
            colour_columns_by = c("celltypes_layer2"), 
            color = viridis(100), labels_col = mean_sce$gating_clustering_FS,
            show_colnames = TRUE, annotation_legend = FALSE, borders_color = NA)

```

## Scaled heatmap

```{r heatmap_mean_expression_per_celltypes_layer1_subclustered_asinh_scaled, fig.width= 20, fig.height=15}
# Scaled
plotHeatmap(mean_sce, exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltypes_layer2"), 
            labels_col = mean_sce$celltypes_layer2,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE)

```

## Numbers of cells per cluster

```{r counts per cluster}
celltype_counts <- sce$celltypes_layer2

table(celltype_counts)
```

# Cluster Names

## Assign names to clusters

```{r names for clusters, fig.height= 15, fig.width=15}
annotations <- sce$celltypes_layer2

# add annotation if wanted
#annotations[annotations == "Tumor_1"] <- "Tumor1_"
#annotations[annotations == "Tumor_2"] <- "Tumor2_"
#annotations[annotations == "Tumor_3"] <- "Tumor3_"
#annotations[annotations == "Tumor_4"] <- "Tumor4_"
#annotations[annotations == "Tumor_5"] <- "Tumor5_"
#annotations[annotations == "Tumor_6"] <- "Tumor6_"

sce$cellAnnotation <- annotations

mean_sce <- calculateSummary(sce, split_by = c("celltypes_layer2","cellAnnotation"), 
                             exprs_values = "counts")

# Exclude bad markers
mean_sce <- mean_sce[rowData(sce)$good_marker,]

# Transform and scale
assay(mean_sce, "arcsinh") <- asinh(assay(mean_sce, "meanCounts")) 
assay(mean_sce, "arcsinh_scaled") <- t(scale(t(asinh(assay(mean_sce, "meanCounts")))))

plotHeatmap(mean_sce, exprs_values = "arcsinh_scaled", 
            colour_columns_by = c("celltypes_layer2"), 
            labels_col = mean_sce$cellAnnotation,
            show_colnames = TRUE, annotation_legend = TRUE, borders_color = NA,
            color = colorRampPalette(c("dark blue", "white", "dark red"))(100),
            zlim = c(-4, 4),legend = TRUE)
```

__clustering does not really pick up PDL1 positive Tumor cells (which definitely exist). Potentially we have to investigate this with a manual cut off. arcsinh > 1.75 seems to be reasonable__

__Additionally, the clustering did not pick up proliferating and non prolifertating tumor clusters. this should also be investigated by manual cut offs. arcsinh > 1.25 seems reasonable.__


## Update Celltype

```{r re-assign celltypes}
sce$celltype <- sce$celltypes_layer1
```

## Counts per Celltype

```{r counts per celltype}
celltype_counts <- sce$celltype

table(celltype_counts)
```

# SCE object

## Save the single cell object

```{r save object with clusters}
# delete the "exprs" slot from the single cell experiment again.

saveRDS(sce, "data/sce_RNA.rds")
```
