---
title: "Supp-Figure_X"
author: "toobiwankenobi"
date: "2021-10-19"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Load data

```{r}
sapply(list.files("code/helper_functions", full.names = TRUE), source)
library(ggridges)
library(SingleCellExperiment)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggbeeswarm)
library(ggrastr)
library(Hmisc)
library(data.table)
library(ggpubr)
library(corrplot)
library(gridExtra)
```

## Load data

```{r load_data}
sce_rna <- readRDS(file = "data/data_for_analysis/sce_RNA.rds")
sce_prot <- readRDS(file = "data/data_for_analysis/sce_protein.rds")

sce_rna <- sce_rna[,sce_rna$Location != "CTRL"]
sce_prot <- sce_prot[,sce_prot$Location != "CTRL"]

# image
image_mat_prot <- read.csv("data/data_for_analysis/protein/Image.csv")
image_mat_rna <- read.csv("data/data_for_analysis/RNA/Image.csv")

# surv_dat
dat_survival_prot <- fread(file = "data/data_for_analysis/protein/clinical_data_protein.csv")
```

## Prepare image size data

```{r}
im_size_prot <- as.data.frame(cbind(image_mat_prot$Metadata_Description, (image_mat_prot$Height_cellmask * image_mat_prot$Width_cellmask)/1000000))
names(im_size_prot) <- c("Description", "mm2_prot")
im_size_prot$mm2_prot <- as.numeric(im_size_prot$mm2_prot)
im_size_prot[im_size_prot$Description %in% c("G1", "G1 - split"), ]$mm2_prot <- mean(im_size_prot[im_size_prot$Description %in% c("G1", "G1 - split"), ]$mm2_prot)
im_size_prot <- im_size_prot[im_size_prot != "G1 - split",]
im_size_prot <- im_size_prot[1:166,]
```

## Prepare image size data

```{r}
im_size_rna <- as.data.frame(cbind(image_mat_rna$Metadata_Description, (image_mat_rna$Height_cellmask * image_mat_rna$Width_cellmask)/1000000))
names(im_size_rna) <- c("Description", "mm2_rna")
im_size_rna$mm2_rna <- as.numeric(im_size_rna$mm2_rna)
im_size_rna <- im_size_rna[1:166,]
```

```{r}
cur_prot <- data.frame(t(assay(sce_prot[c("PD1", "CD3"), sce_prot$celltype %in% c("CD8+ T cell", "CD4+ T cell", "BnT cell", "FOXP3+ T cell") &
                                          sce_prot$Location != "CTRL"], "asinh")))
set.seed(123)
cluster <- kmeans(cur_prot$PD1,3)
cur_prot$PD1_cluster <- ifelse(cluster$cluster == 3, 1,0)

ggplot(cur_prot, aes(x=PD1, y=CD3, col=as.character(PD1_cluster))) +
  geom_point_rast(size=.5, alpha=.5)

# add PD1 cluster info from kmeans to full sce_prot
sce_prot$PD1_cluster = 0
sce_prot[,sce_prot$cellID %in% rownames(cur_prot[cur_prot$PD1_cluster == 1,])]$PD1_cluster <- 1

sce_rna$CD8_CXCL13 <- 0
sce_rna[,sce_rna$celltype %in% c("CD8+ T cell") & sce_rna$CXCL13 == 1]$CD8_CXCL13 <- 1

# CD8+CXCL13+ in RNA data set
perc_cd8_cxcl13 <- as.data.frame(colData(sce_rna)) %>%
  group_by(Description, CD8_CXCL13) %>%
  summarise(n_cd8=n()) %>%
  ungroup() %>%
  complete(Description, CD8_CXCL13, fill=list(n_cd8=0)) %>%
  filter(CD8_CXCL13 == 1)

# CD3+PD1high in protein data set
sce_prot$CD3_PD1 <- 0
sce_prot[,sce_prot$celltype %in% c("CD8+ T cell", "CD4+ T cell", "BnT cell", "FOXP3+ T cell") & sce_prot$PD1_cluster == 1]$CD3_PD1 <- 1

perc_cd3_pd1 <- as.data.frame(colData(sce_prot)) %>%
  group_by(Description, CD3_PD1) %>%
  summarise(n_cd3=n()) %>%
  ungroup() %>%
  complete(Description, CD3_PD1, fill=list(n_cd3=0)) %>%
  filter(CD3_PD1 == 1)

data <- left_join(perc_cd3_pd1, perc_cd8_cxcl13)

# normalize by area
data <- left_join(data, im_size_prot)
data$n_cd3 <- data$n_cd3 / data$mm2_prot
data$n_cd8 <- data$n_cd8 / data$mm2_prot

ggplot(data, aes(x=n_cd3, y=n_cd8)) +
  geom_point(size=3) +
  geom_smooth(method = "lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..rr.label.., sep = "~`,`~")),
           size = 8, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left") +
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("PD1+CD3+ Density (cells/mm2)") +
  ylab("CXCL13+CD8+ Density (cells/mm2)")
```

## Response / Survival Analysis

```{r}
# select blocks in ICI subgroup that are treatment-naive and non-adjuvant
blocks <- unique(sce_prot[,sce_prot$treatment_status_before_surgery == "naive" & 
                            sce_prot$treatment_group_after_surgery == "ICI" &
                            sce_prot$Adjuvant == "n"]$BlockID)

# subset survival data (only data points that contain info for 3m response)
dat_survival_prot_sub <- dat_survival_prot[dat_survival_prot$BlockID %in% blocks & 
                                             is.na(dat_survival_prot$Status_at_3m) == FALSE, ]

# remove LN margin samples
dat_survival_prot_sub <- dat_survival_prot_sub %>%
  mutate(mmLocationPunch = paste(MM_location, Location, sep = "_")) %>%
  filter(mmLocationPunch != "LN_M")

# group sizes
dat_survival_prot_sub %>%
  distinct(PatientID, .keep_all = T) %>%
  group_by(Status_at_3m) %>%
  summarise(n=n())
```

```{r}
dat_survival_prot_sub$Status_at_3m

survival <-  dat_survival_prot_sub %>%
  distinct(Description, .keep_all = T) %>%
  select(Status_at_3m, Description, PatientID, Treatment_after_surgery)

data_surv <- left_join(survival, data)

ggplot(data_surv, aes(x=Status_at_3m, y=n_cd3)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(col=Treatment_after_surgery), size=2) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("") +
  ylab("PD1+CD3+ Density (cells/mm2)")

ggplot(data_surv, aes(x=Status_at_3m, y=n_cd8)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(col=Treatment_after_surgery), size=2) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("") +
  ylab("CXCL13+CD8+ Density (cells/mm2)")

# patient-level
data_surv_pat <- data_surv %>%
  group_by(PatientID, Status_at_3m, Treatment_after_surgery) %>%
  summarise(mean_density_patient = mean(n_cd3))

ggplot(data_surv_pat, aes(x=Status_at_3m, y=mean_density_patient)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(col=Treatment_after_surgery), size=2) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("") +
  ylab("Mean PD1+CD3+ Density (cells/mm2)")

data_surv_pat <- data_surv %>%
  group_by(PatientID, Status_at_3m, Treatment_after_surgery) %>%
  summarise(mean_density_patient = mean(n_cd8))

ggplot(data_surv_pat, aes(x=Status_at_3m, y=mean_density_patient)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(col=Treatment_after_surgery), size=2) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("") +
  ylab("Mean CXCL13+CD8+ Density (cells/mm2)")
```

## Density CD8+CXCL13+ and density B cells per Patch score

```{r}
perc_cd8_cxcl13 <- as.data.frame(colData(sce_rna)) %>%
  group_by(Description, CD8_CXCL13) %>%
  summarise(n_cd8pos=n()) %>%
  ungroup() %>%
  complete(Description, CD8_CXCL13, fill=list(n_cd8pos=0)) %>%
  filter(CD8_CXCL13 == 1)
perc_cd8_cxcl13$n <- NULL

perc_cd20 <- as.data.frame(colData(sce_prot)) %>%
  group_by(Description, celltype) %>%
  summarise(n_cd20=n()) %>%
  ungroup() %>%
  complete(Description, celltype, fill=list(n_cd20=0)) %>%
  filter(celltype == "B cell")
perc_cd20$n <- NULL

info <- as.data.frame(colData(sce_prot)) %>%
  distinct(Description, .keep_all = T) %>%
  select(Description, bcell_patch_score)

perc_cd20 <- left_join(info, perc_cd20)
data <- left_join(perc_cd20, perc_cd8_cxcl13)

data_cd8pos <- left_join(data, im_size_prot)
data_cd8pos <- left_join(data_cd8pos, im_size_rna)
data_cd8pos$n_cd20 <- data_cd8pos$n_cd20 / data_cd8pos$mm2_prot
data_cd8pos$n_cd8pos <- data_cd8pos$n_cd8pos / data_cd8pos$mm2_rna

ggplot(data_cd8pos, aes(x=n_cd8pos, y=n_cd20)) +
  geom_point() +
  geom_smooth(method="lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
           size = 4, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left") +
  xlab("CXCL13+CD8+ T cell / mm2") +
  ylab("CD20 / mm2") +
  theme_bw() +
  theme(text=element_text(size=15)) + 
  facet_wrap(~bcell_patch_score, scales="free")
```

## Density CD8-CXCL13+ and density B cells per Patch score

```{r}
sce_rna$CD8neg_CXCL13 <- 0
sce_rna[,sce_rna$celltype %in% c("CD8- T cell") & sce_rna$CXCL13 == 1]$CD8neg_CXCL13 <- 1

perc_cd4_cxcl13 <- as.data.frame(colData(sce_rna)) %>%
  group_by(Description, CD8neg_CXCL13) %>%
  summarise(n_cd8neg=n()) %>%
  ungroup() %>%
  complete(Description, CD8neg_CXCL13, fill=list(n_cd8neg=0)) %>%
  filter(CD8neg_CXCL13 == 1)
perc_cd4_cxcl13$n <- NULL

perc_cd20 <- as.data.frame(colData(sce_prot)) %>%
  group_by(Description, celltype) %>%
  summarise(n_cd20=n()) %>%
  ungroup() %>%
  complete(Description, celltype, fill=list(n_cd20=0)) %>%
  filter(celltype == "B cell")
perc_cd20$n <- NULL

info <- as.data.frame(colData(sce_prot)) %>%
  distinct(Description, .keep_all = T) %>%
  select(Description, bcell_patch_score)

perc_cd20 <- left_join(info, perc_cd20)
data <- left_join(perc_cd20, perc_cd4_cxcl13)

data_cd8neg <- left_join(data, im_size_prot)
data_cd8neg <- left_join(data_cd8neg, im_size_rna)
data_cd8neg$n_cd20 <- data_cd8neg$n_cd20 / data_cd8neg$mm2_prot
data_cd8neg$n_cd8neg <- data_cd8neg$n_cd8neg / data_cd8neg$mm2_rna

ggplot(data_cd8neg, aes(x=n_cd8neg, y=n_cd20)) +
  geom_point() +
  geom_smooth(method="lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
           size = 4, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left") +
  xlab("CXCL13+CD8- T cell / mm2") +
  ylab("CD20 / mm2") +
  theme_bw() +
  theme(text=element_text(size=15)) + 
  facet_wrap(~bcell_patch_score, scales="free")
```

## Density CXCL13+ T cells and density B cells per Patch score

```{r}
data_complete <- left_join(data_cd8neg, data_cd8pos[,c("Description","n_cd8pos")])

ggplot(data_complete, aes(x=n_cd8pos, y=n_cd8neg)) +
  geom_point() +
  geom_smooth(method="lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
           size = 4, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left") +
  xlab("CXCL13+CD8+ T cell / mm2") +
  ylab("CXCL13+CD8- T cell / mm2") +
  theme_bw() +
  theme(text=element_text(size=15)) + 
  facet_wrap(~bcell_patch_score, scales="free")
```

## Correlation Heaptmap and Scatter Plot 

```{r}
sce_rna$celltype_CXCL13 <- paste(sce_rna$celltype, sce_rna$CXCL13, sep = "_")
corr <- as.data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  group_by(Description, celltype_CXCL13, bcell_patch_score) %>%
  summarise(n=n()) %>%
  reshape2::dcast(Description + bcell_patch_score ~ celltype_CXCL13, fill = 0, value.var = "n") %>%
  select("Description", "bcell_patch_score", "CD8+ T cell_1", "CD8- T cell_1", "HLA-DR_1")

cd20 <- as.data.frame(colData(sce_prot)) %>%
  filter(Location != "CTRL") %>%
  group_by(Description, celltype) %>%
  summarise(n=n()) %>%
  reshape2::dcast(Description ~ celltype, fill = 0, value.var = "n") %>%
  select("Description", "B cell")

data <- left_join(corr, cd20)
data <- left_join(data, im_size_rna)
data <- left_join(data, im_size_prot)

data$`CD8+ T cell_1` <- data$`CD8+ T cell_1` / data$mm2_rna
data$`CD8- T cell_1` <- data$`CD8- T cell_1` / data$mm2_rna
data$`HLA-DR_1` <- data$`HLA-DR_1` / data$mm2_rna
data$`B cell` <- data$`B cell` / data$mm2_prot

a <- ggplot(data=data[data$bcell_patch_score != "B cell Follicles",],aes(x=`CD8- T cell_1`, y=`B cell`)) + 
  geom_point() +
  geom_smooth(method="lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
           size = 8, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left") +
  theme_bw() +
  theme(text=element_text(size=15)) +
  xlab("CXCL13+ CD8- T cells / mm2") +
  ylab("B cells / mm2")

b <- ggplot(data=data[data$bcell_patch_score != "B cell Follicles",],aes(x=`CD8+ T cell_1`, y=`B cell`)) + 
  geom_point() +
  geom_smooth(method="lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
           size = 8, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left") +
  theme_bw() +
  theme(text=element_text(size=15)) +
  xlab("CXCL13+ CD8+ T cells / mm2") +
  ylab("B cells / mm2")

grid.arrange(a,b, nrow=1)
```

## Correlation Heaptmap for all groups

```{r}
sce_rna$celltype_CXCL13 <- paste(sce_rna$celltype, sce_rna$CXCL13, sep = "_")
corr <- as.data.frame(colData(sce_rna)) %>%
  filter(Location != "CTRL") %>%
  group_by(Description, celltype_CXCL13, bcell_patch_score) %>%
  summarise(n=n()) %>%
  reshape2::dcast(Description + bcell_patch_score ~ celltype_CXCL13, fill = 0, value.var = "n") %>%
  select("Description", "bcell_patch_score", "CD8+ T cell_1", "CD8- T cell_1", "HLA-DR_1")

cd20 <- as.data.frame(colData(sce_prot)) %>%
  filter(Location != "CTRL") %>%
  group_by(Description, celltype) %>%
  summarise(n=n()) %>%
  reshape2::dcast(Description ~ celltype, fill = 0, value.var = "n") %>%
  select("Description", "B cell")

data <- left_join(corr, cd20)
data <- left_join(data, im_size_rna)
data <- left_join(data, im_size_prot)

data$`CD8+ T cell_1` <- data$`CD8+ T cell_1` / data$mm2_rna
data$`CD8- T cell_1` <- data$`CD8- T cell_1` / data$mm2_rna
data$`HLA-DR_1` <- data$`HLA-DR_1` / data$mm2_rna
data$`B cell` <- data$`B cell` / data$mm2_prot

# overall correlations
cd8pos_cor <- cor.test(data$`CD8+ T cell_1`, data$`B cell`, method = "pearson")
cd8neg_cor <- cor.test(data$`CD8- T cell_1`, data$`B cell`, method = "pearson")
tcell_cor <- cor.test((data$`CD8- T cell_1` + data$`CD8+ T cell_1`), data$`B cell`, method = "pearson")
hladr_cor <- cor.test(data$`HLA-DR_1`, data$`B cell`, method = "pearson")

# Combine overall correlations and grouping speicifc correlations
overall_correlation <- data.frame()
overall_correlation <- rbind(overall_correlation, cbind("Overall", "CXCL13+ CD8+ T cell", cd8pos_cor$estimate[[1]], cd8pos_cor$p.value[[1]]))
overall_correlation <- rbind(overall_correlation, cbind("Overall", "CXCL13+ CD8- T cell", cd8neg_cor$estimate[[1]], cd8neg_cor$p.value[[1]]))
overall_correlation <- rbind(overall_correlation, cbind("Overall", "CXCL13+ T cell", tcell_cor$estimate[[1]], tcell_cor$p.value[[1]]))
overall_correlation <- rbind(overall_correlation, cbind("Overall", "CXCL13+ HLA-DR", hladr_cor$estimate[[1]], hladr_cor$p.value[[1]]))
colnames(overall_correlation) <- c("patch_groups", "celltype", "estimate", "p.value")

# patch group specific correlations - No B cells
correlations <- data.frame()

for(group in unique(sce_rna$bcell_patch_score)){
  # subset data
  data_sub <- data[data$bcell_patch_score == group,]
  
  # calculate correlations and p values
  cd8pos_cor <- cor.test(data_sub$`CD8+ T cell_1`, data_sub$`B cell`, method = "pearson")
  cd8neg_cor <- cor.test(data_sub$`CD8- T cell_1`, data_sub$`B cell`, method = "pearson")
  tcell_cor <- cor.test((data_sub$`CD8- T cell_1` + data_sub$`CD8+ T cell_1`), data_sub$`B cell`, method = "pearson")
  hladr_cor <- cor.test(data_sub$`HLA-DR_1`, data_sub$`B cell`, method = "pearson")
  
  correlations <- rbind(correlations, cbind(group[[1]], "CXCL13+ CD8+ T cell", cd8pos_cor$estimate[[1]], cd8pos_cor$p.value[[1]]))
  correlations <- rbind(correlations, cbind(group[[1]], "CXCL13+ CD8- T cell", cd8neg_cor$estimate[[1]], cd8neg_cor$p.value[[1]]))
  correlations <- rbind(correlations, cbind(group[[1]], "CXCL13+ T cell", tcell_cor$estimate[[1]], tcell_cor$p.value[[1]]))
  correlations <- rbind(correlations, cbind(group[[1]], "CXCL13+ HLA-DR", hladr_cor$estimate[[1]], hladr_cor$p.value[[1]]))
}

colnames(correlations) <- c("patch_groups", "celltype", "estimate", "p.value")

corr <- rbind(overall_correlation, correlations)
corr$p.value <- as.numeric(corr$p.value)
corr$estimate <- as.numeric(corr$estimate)

corr$p.value <- p.adjust(corr$p.value, method = "BH")

# plot
dat_long <- corr %>%
  mutate(sig = ifelse(p.value <= 0.001 & p.value > 0.0001,0.001,p.value))

dat_long <- dat_long %>%
  mutate(sig = case_when(p.value <= 0.0001 ~ "< 0.0001",
                         p.value <= 0.001 & p.value > 0.0001 ~ "< 0.001",
                         p.value <= 0.01 & p.value > 0.001 ~ "< 0.01",
                         p.value <= 0.1 & p.value > 0.01 ~ "< 0.1",
                         p.value > 0.1 ~ "ns"))

# plot
dat_long$patch_groups <- factor(dat_long$patch_groups, levels = c("B cell Follicles", "Small B cell Patches", "No B cell Patches", "No B cells", "Overall")) 
dat_long$celltype <- factor(dat_long$celltype, levels = c("CXCL13+ CD8+ T cell", "CXCL13+ CD8- T cell", "CXCL13+ T cell", "CXCL13+ HLA-DR")) 

ggplot()+
  geom_tile(data = dat_long, aes(x = celltype, y = patch_groups,fill=sig),color = "gray",size = 0.1, alpha = 0.5)+
  scale_fill_manual(values = c("< 0.0001" = "darkgreen", "< 0.001" = "green3", "< 0.01"="green", "< 0.1" = "lightgray","ns" = "white"), name = "adj p-value" )+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5))+
  geom_point(data = dat_long, aes(x=celltype,y = patch_groups), size=10.5, show.legend = FALSE)+
  geom_point(data = dat_long, aes(x=celltype,y = patch_groups, color=estimate),size= 10, shape=19)+
  scale_color_gradient2(low="blue",mid= "white", high="red", name = "Pearson correlation")
```


## FOXP3+CD8+ and FOXP3+CD8+PD1+ cells

```{r}
cur_prot <- data.frame(t(assay(sce_prot[c("PD1", "CD8", "FOXP3"), 
                                        sce_prot$celltype %in% c("CD8+ T cell") & 
                                        sce_prot$Location != "CTRL"], "asinh")))

plotDist(sce_prot["FOXP3", sce_prot$celltype == "CD8+ T cell"], plot_type = "ridges", 
         colour_by = "groups", split_by = "rows", 
         exprs_values = "asinh") +
  geom_vline(xintercept = 1.3)

sce_prot$FOXP3 <- ifelse(assay(sce_prot["FOXP3",], "asinh") > 2, "FOXP3+", "FOXP3-")
sce_prot$FOXP3_PD1 <- paste0(sce_prot$FOXP3, sce_prot$PD1)

perc_FOXP3_PD1 <- as.data.frame(colData(sce_prot)) %>%
  filter(celltype == "CD8+ T cell") %>%
  group_by(Description, FOXP3_PD1) %>%
  summarise(n=n()) %>%
  mutate(fraction_of_cd8 = n / sum(n)) %>%
  ungroup() %>%
  complete(Description, FOXP3_PD1, fill=list(fraction_of_cd8=0))

data_surv <- left_join(survival, perc_FOXP3_PD1)

ggplot(data_surv, aes(x=Status_at_3m, y=fraction_of_cd8)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(col=Treatment_after_surgery), size=2) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("") +
  ylab("Fraction of Total CD8+") +
  facet_wrap(~FOXP3_PD1, scales = "free")

# Patient Level
data_surv_pat <- data_surv %>%
  group_by(PatientID, Status_at_3m, FOXP3_PD1, Treatment_after_surgery) %>%
  summarise(mean_fraction_patient = mean(fraction_of_cd8))

ggplot(data_surv_pat, aes(x=Status_at_3m, y=mean_fraction_patient)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm(aes(col=Treatment_after_surgery), size=2) +
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("") +
  ylab("Mean Fraction of Total CD8+ per Patient") +
  facet_wrap(~FOXP3_PD1, scales = "free")
```

# S100 co-variation with CXCL13 fraction and CD8 fraction

```{r}
s100 <- data.frame(t(assay(sce_rna[c("S100"), 
                                        sce_rna$celltype %in% c("Tumor") & 
                                        sce_rna$Location != "CTRL"], "asinh")))
b2m <- data.frame(t(assay(sce_rna[c("B2M"), 
                                        sce_rna$celltype %in% c("Tumor") & 
                                        sce_rna$Location != "CTRL"], "asinh")))
sox10 <- data.frame(t(assay(sce_rna[c("SOX10"), 
                                        sce_rna$celltype %in% c("Tumor") & 
                                        sce_rna$Location != "CTRL"], "asinh")))
mart1 <- data.frame(t(assay(sce_rna[c("Mart1"), 
                                        sce_rna$celltype %in% c("Tumor") & 
                                        sce_rna$Location != "CTRL"], "asinh")))

info <- data.frame(colData(sce_rna)) %>%
  select(Description, cellID)

s100$cellID <- rownames(s100)

tumor_dat <- cbind(s100, b2m[,1], sox10[,1], mart1[,1])
colnames(tumor_dat) <- c("S100", "cellID", "B2M", "SOX10", "MART1")

tumor_dat <- left_join(tumor_dat, info) %>%
  group_by(Description) %>%
  summarise(mean_s100 = mean(S100), mean_b2m = mean(B2M), mean_sox10 = mean(SOX10), mean_mart1 = mean(MART1))

cxcl13_frac <- as.data.frame(colData(sce_rna)) %>%
  filter(celltype %in% c("CD8+ T cell", "CD8- T cell")) %>%
  group_by(Description, CXCL13) %>%
  summarise(n=n()) %>%
  mutate(fraction_of_cxcl13 = n / sum(n)) %>%
  ungroup() %>%
  complete(Description, CXCL13, fill=list(fraction_of_cxcl13=0)) %>%
  filter(CXCL13 == 1)
cxcl13_frac$n <- NULL
cxcl13_frac$CXCL13 <- NULL

cd8_frac <- as.data.frame(colData(sce_rna)) %>%
  filter(celltype != "Tumor") %>%
  group_by(Description, celltype) %>%
  summarise(n=n()) %>%
  mutate(fraction_of_cd8 = n / sum(n)) %>%
  ungroup() %>%
  complete(Description, celltype, fill=list(fraction_of_cd8=0)) %>%
  filter(celltype=="CD8+ T cell")
cd8_frac$n <- NULL
cd8_frac$celltype <- NULL

data <- left_join(tumor_dat, cxcl13_frac)
data <- left_join(data, cd8_frac)

# correlation
corr <- rcorr(as.matrix(data[,-1]))

# adjust p values manually
padj <- matrix(p.adjust(corr$P, method = "BH"), nrow=6, ncol=6, byrow = TRUE)
colnames(padj) <- colnames(corr$P)
rownames(padj) <- rownames(corr$P)
corr$P <- padj

colnames(corr$r) <- c("Mean S100", "Mean B2M", "Mean SOX10", "Mean Mart1", "CXCL13+ Fraction", "CD8+ Fraction")
rownames(corr$r) <- c("Mean S100", "Mean B2M", "Mean SOX10", "Mean Mart1", "CXCL13+ Fraction", "CD8+ Fraction")


corrplot(corr$r, p.mat = corr$P, 
         insig = 'label_sig', 
         tl.col = "black",
         #addCoef.col = 'white',
         sig.level = c(0.001, 0.01, 0.05), 
         pch.cex = 2, pch.col = 'black')
```

# Scatterplot - Correlation of S100 with CXCL13 expression, CXCL13+ T cells, CD8+ T cells

```{r}
s100 <- data.frame(t(assay(sce_rna[c("S100"), 
                                        sce_rna$celltype %in% c("Tumor") & 
                                        sce_rna$Location != "CTRL"], "asinh")))

info <- data.frame(colData(sce_rna)) %>%
  select(Description, cellID)

s100$cellID <- rownames(s100)

colnames(s100) <- c("S100", "cellID")

tumor_dat <- left_join(s100, info) %>%
  group_by(Description) %>%
  summarise(mean_s100 = mean(S100))

cxcl13_frac <- as.data.frame(colData(sce_rna)) %>%
  filter(celltype %in% c("CD8+ T cell")) %>%
  group_by(Description, CXCL13) %>%
  summarise(n=n()) %>%
  mutate(fraction_of_cxcl13 = n / sum(n)) %>%
  ungroup() %>%
  complete(Description, CXCL13, fill=list(fraction_of_cxcl13=0)) %>%
  filter(CXCL13 == 1)
cxcl13_frac$n <- NULL
cxcl13_frac$CXCL13 <- NULL

cd8_frac <- as.data.frame(colData(sce_rna)) %>%
  filter(celltype != "Tumor") %>%
  group_by(Description, celltype) %>%
  summarise(n=n()) %>%
  mutate(fraction_of_cd8 = n / sum(n)) %>%
  ungroup() %>%
  complete(Description, celltype, fill=list(fraction_of_cd8=0)) %>%
  filter(celltype=="CD8+ T cell")
cd8_frac$n <- NULL
cd8_frac$celltype <- NULL

data <- left_join(tumor_dat, cxcl13_frac)
data <- left_join(data, cd8_frac)


cxcl13 <- data.frame(t(assay(sce_rna[c("T8_CXCL13"),  
                                        sce_rna$Location != "CTRL"], "asinh")))
cxcl13$cellID <- rownames(cxcl13)
colnames(cxcl13) <- c("CXCL13", "cellID")

cxcl13_dat <- left_join(cxcl13, info) %>%
  group_by(Description) %>%
  summarise(mean_cxcl13 = mean(CXCL13))

data <- left_join(data, cxcl13_dat)

a <- ggplot(data, aes(x=mean_s100, y=fraction_of_cxcl13)) + 
  geom_point(size=3) + 
  geom_smooth(method="lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
           size = 8, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left") + 
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("Mean S100 in Tumor (asinh)") +
  ylab("Fraction of CXCL13+CD8+ T cells\n(of all CD8+ T cells)")

b <- ggplot(data, aes(x=mean_s100, y=fraction_of_cd8)) + 
  geom_point(size=3) + 
  geom_smooth(method="lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
           size = 8, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left") + 
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("Mean S100 in Tumor (asinh)") +
  ylab("Fraction of CD8+ T cells\n(of all non-tumor cells)")

c <- ggplot(data, aes(x=mean_s100, y=mean_cxcl13)) + 
  geom_point(size=3) + 
  geom_smooth(method="lm") +
  stat_cor(method = "pearson",
           aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
           size = 8, cor.coef.name = "R", label.sep="\n", label.y.npc = "top", label.x.npc = "left") + 
  theme_bw() +
  theme(text = element_text(size=15)) +
  xlab("Mean S100 in Tumor (asinh)") +
  ylab("Mean CXCL13 in All Cells (asinh)")

grid.arrange(a,b,c,nrow=1)
```

## Number of B cell Patches Cancer Stage

```{r}
number_of_patches <- as.data.frame(colData(sce_prot)) %>%
  mutate(MM_location_simplified2 = paste(MM_location_simplified, Location, sep="_")) %>%
  filter(Location != "CTRL", MM_location_simplified2 != "LN_M") %>%
  group_by(Description, PatientID, Cancer_Stage) %>%
  filter(bcell_patch > 0) %>%
  group_by(PatientID, Cancer_Stage) %>%
  distinct(bcell_patch, .keep_all = T) %>%
  summarise(n=n())


size_of_patches <- as.data.frame(colData(sce_prot)) %>%
  mutate(MM_location_simplified2 = paste(MM_location_simplified, Location, sep="_")) %>%
  filter(Location != "CTRL", MM_location_simplified2 != "LN_M") %>%
  filter(bcell_patch > 0) %>%
  group_by(PatientID, bcell_patch, Cancer_Stage) %>%
  summarise(size=n()) %>%
  group_by(PatientID, Cancer_Stage) %>%
  summarise(mean_size=mean(size))
  

a <- ggplot(number_of_patches, aes(x=Cancer_Stage,y=n)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm() +
  xlab("Cancer Stage") +
  ylab("Number of B cell Patches per Patient") +
  theme_bw() +
  theme(text=element_text(size=15))

b <- ggplot(size_of_patches, aes(x=Cancer_Stage,y=mean_size)) +
  geom_boxplot(outlier.shape = NULL) +
  geom_beeswarm() +
  xlab("Cancer Stage") +
  ylab("Mean B cell Patch Size per Patient") +
  theme_bw() +
  theme(text=element_text(size=15))

grid.arrange(a,b,nrow=1)
  
```

## Chemokine Milieu Overlap

```{r}
# what percentage of CXCL13 patch cells are part of CXCL10 milieu
cxcl13_in_cxcl10 <- as.data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, CXCL10) %>%
  filter(cxcl13_pure > 0 & CXCL13 > 0) %>%
  select(cxcl10_pure, cxcl13_pure) %>%
  mutate(cxcl10_pure = ifelse(cxcl10_pure > 0, "CXCL10Milieu", "NotInMilieu")) %>%
  group_by(cxcl10_pure) %>%
  summarise(n=n()) %>%
  mutate(percentage=n/sum(n)*100)

# what percentage of CXCL13 patch cells are part of CXCL9 milieu
cxcl13_in_cxcl9 <- as.data.frame(colData(sce_rna)) %>%
  group_by(ImageNumber, CXCL10) %>%
  filter(cxcl13_pure > 0 & CXCL13 > 0) %>%
  select(cxcl9_pure, cxcl13_pure) %>%
  mutate(cxcl9_pure = ifelse(cxcl9_pure > 0, "CXCL9Milieu", "NotInMilieu")) %>%
  group_by(cxcl9_pure) %>%
  summarise(n=n()) %>%
  mutate(percentage=n/sum(n)*100)
```


